import{r as _,j as e,D as V,m as F,n as O,o as q,p as M,L as b,I as y,M as w,q as R,B as C,a as G,E as H,C as k,b as L,c as E,e as A,U as K}from"./index-BiqUYfMP.js";import{b as I}from"./validation.constants-C18ePHzl.js";import{u as Y}from"./useScrollToError-Dq4kUlQ8.js";import{e as z,f as $,g as J,h as Q,P as S,i as W}from"./personGateIn.queries-UBxRVqUL.js";import{I as X,a as T}from"./driver.schema-DZt_XaHY.js";import{G as Z}from"./GateSelect-BqCCzE29.js";import{S as U}from"./SearchableSelect-Ccn4BFOS.js";import{C as ee}from"./ContractorSelect-t8GxfmG6.js";import{A as se}from"./arrow-left-BQF7jrqo.js";import{C as re}from"./circle-alert-DZMhDntM.js";import{U as ie}from"./users-DmHf_mtU.js";import"./useMutation-26qx2_Go.js";import"./schemas-D8ebsZBL.js";import"./plus-D-Qo3X9s.js";function ae({open:f,onOpenChange:v,onSuccess:j,defaultContractorId:n}){const[p,r]=_.useState({}),[t,d]=_.useState({name:"",contractor:n||0,mobile:"",id_proof_no:"",skill_type:"",permit_valid_till:""}),h=z();_.useEffect(()=>{f&&(d({name:"",contractor:n||0,mobile:"",id_proof_no:"",skill_type:"",permit_valid_till:""}),r({}))},[f,n]);const a=async s=>{s.preventDefault();const i={};if(t.name.trim()||(i.name="Name is required"),t.contractor||(i.contractor="Contractor is required"),t.mobile?.trim()&&!I.phone.test(t.mobile.trim())&&(i.mobile="Please enter a valid 10-digit phone number"),Object.keys(i).length>0){r(i);return}r({});try{const c=await h.mutateAsync({name:t.name,contractor:t.contractor,mobile:t.mobile||void 0,id_proof_no:t.id_proof_no||void 0,skill_type:t.skill_type||void 0,permit_valid_till:t.permit_valid_till||void 0,is_active:!0});v(!1),j?.(c)}catch(c){const g=c;if(g.errors){const N={};Object.entries(g.errors).forEach(([u,m])=>{Array.isArray(m)&&m.length>0&&(N[u]=m[0])}),r(N)}else r({general:g.message||"Failed to create labour"})}};return e.jsx(V,{open:f,onOpenChange:v,children:e.jsxs(F,{className:"sm:max-w-[500px]",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Add New Labour"}),e.jsx(M,{children:"Fill in the details to register a new labour."})]}),e.jsxs("form",{onSubmit:a,className:"space-y-4",children:[p.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:p.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"name",children:["Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(y,{id:"name",placeholder:"Enter labour name",value:t.name,onChange:s=>d(i=>({...i,name:s.target.value})),disabled:h.isPending,className:p.name?"border-destructive":""}),p.name&&e.jsx("p",{className:"text-sm text-destructive",children:p.name})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(ee,{value:t.contractor?String(t.contractor):void 0,onChange:s=>{d(i=>({...i,contractor:s}))},disabled:h.isPending,label:"Contractor",required:!0,error:p.contractor})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"mobile",children:"Mobile"}),e.jsx(y,{id:"mobile",placeholder:"9876543210",value:t.mobile,onChange:s=>{const i=s.target.value.replace(/[^0-9]/g,"").slice(0,10);d(c=>({...c,mobile:i})),p.mobile&&r(c=>{const g={...c};return delete g.mobile,g})},maxLength:10,disabled:h.isPending,className:w(p.mobile&&"border-destructive")}),p.mobile&&e.jsx("p",{className:"text-sm text-destructive",children:p.mobile})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"skill_type",children:"Skill Type"}),e.jsx(y,{id:"skill_type",placeholder:"e.g., Electrician, Plumber",value:t.skill_type,onChange:s=>d(i=>({...i,skill_type:s.target.value})),disabled:h.isPending})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_no",children:"ID Proof Number"}),e.jsx(y,{id:"id_proof_no",placeholder:"ID number",value:t.id_proof_no,onChange:s=>d(i=>({...i,id_proof_no:s.target.value})),disabled:h.isPending})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"permit_valid_till",children:"Permit Valid Till"}),e.jsx(y,{id:"permit_valid_till",type:"date",value:t.permit_valid_till,onChange:s=>d(i=>({...i,permit_valid_till:s.target.value})),disabled:h.isPending})]})]}),e.jsxs(R,{children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:h.isPending,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:h.isPending,children:h.isPending?"Creating...":"Create Labour"})]})]})]})})}function te({open:f,onOpenChange:v,onSuccess:j}){const[n,p]=_.useState({}),[r,t]=_.useState({name:"",mobile:"",company_name:"",id_proof_type:"",id_proof_no:""}),d=$();_.useEffect(()=>{f&&(t({name:"",mobile:"",company_name:"",id_proof_type:"",id_proof_no:""}),p({}))},[f]);const h=async a=>{a.preventDefault();const s={};if(r.name.trim()||(s.name="Name is required"),r.mobile?.trim()&&!I.phone.test(r.mobile.trim())&&(s.mobile="Please enter a valid 10-digit phone number"),r.id_proof_type&&r.id_proof_no?.trim()){const i=r.id_proof_type,c=T[i];c?.pattern&&!c.pattern.test(r.id_proof_no.trim().toUpperCase())&&(s.id_proof_no=c.message)}if(Object.keys(s).length>0){p(s);return}p({});try{const i=await d.mutateAsync({name:r.name,mobile:r.mobile||void 0,company_name:r.company_name||void 0,id_proof_type:r.id_proof_type||void 0,id_proof_no:r.id_proof_no||void 0});v(!1),j?.(i)}catch(i){const c=i;if(c.errors){const g={};Object.entries(c.errors).forEach(([N,u])=>{Array.isArray(u)&&u.length>0&&(g[N]=u[0])}),p(g)}else p({general:c.message||"Failed to create visitor"})}};return e.jsx(V,{open:f,onOpenChange:v,children:e.jsxs(F,{className:"sm:max-w-[500px]",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Add New Visitor"}),e.jsx(M,{children:"Fill in the details to register a new visitor."})]}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[n.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:n.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"name",children:["Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(y,{id:"name",placeholder:"Enter visitor name",value:r.name,onChange:a=>t(s=>({...s,name:a.target.value})),disabled:d.isPending,className:n.name?"border-destructive":""}),n.name&&e.jsx("p",{className:"text-sm text-destructive",children:n.name})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"mobile",children:"Mobile"}),e.jsx(y,{id:"mobile",placeholder:"9876543210",value:r.mobile,onChange:a=>{const s=a.target.value.replace(/[^0-9]/g,"").slice(0,10);t(i=>({...i,mobile:s})),n.mobile&&p(i=>{const c={...i};return delete c.mobile,c})},maxLength:10,disabled:d.isPending,className:w(n.mobile&&"border-destructive")}),n.mobile&&e.jsx("p",{className:"text-sm text-destructive",children:n.mobile})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"company_name",children:"Company"}),e.jsx(y,{id:"company_name",placeholder:"Company name",value:r.company_name,onChange:a=>t(s=>({...s,company_name:a.target.value})),disabled:d.isPending})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_type",children:"ID Proof Type"}),e.jsxs("select",{id:"id_proof_type",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:r.id_proof_type,onChange:a=>{t(s=>({...s,id_proof_type:a.target.value,id_proof_no:""})),n.id_proof_no&&p(s=>{const i={...s};return delete i.id_proof_no,i})},disabled:d.isPending,children:[e.jsx("option",{value:"",children:"Select type"}),X.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_no",children:"ID Proof Number"}),e.jsx(y,{id:"id_proof_no",placeholder:T[r.id_proof_type]?.placeholder||"ID number",value:r.id_proof_no,onChange:a=>{let s=a.target.value;r.id_proof_type==="Aadhar"?s=s.replace(/[^0-9]/g,"").slice(0,12):(r.id_proof_type==="PAN Card"||r.id_proof_type==="Voter ID")&&(s=s.toUpperCase()),t(i=>({...i,id_proof_no:s})),n.id_proof_no&&p(i=>{const c={...i};return delete c.id_proof_no,c})},maxLength:r.id_proof_type==="Aadhar"?12:r.id_proof_type==="PAN Card"||r.id_proof_type==="Voter ID"?10:50,disabled:d.isPending||!r.id_proof_type,className:w(n.id_proof_no&&"border-destructive")}),n.id_proof_no&&e.jsx("p",{className:"text-sm text-destructive",children:n.id_proof_no})]})]}),e.jsxs(R,{children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:d.isPending,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:d.isPending,children:d.isPending?"Creating...":"Create Visitor"})]})]})]})})}function oe({value:f,onChange:v,contractorId:j,placeholder:n="Select labour",disabled:p=!1,error:r,label:t,required:d=!1}){const[h,a]=_.useState(!1),[s,i]=_.useState(null),{data:c=[],isLoading:g,isError:N}=J(void 0,j,h&&!p),u=_.useMemo(()=>c.filter(m=>m.is_active),[c]);return e.jsx(U,{value:f?String(f):void 0,items:u,isLoading:g,isError:N,placeholder:n,disabled:p,error:r,label:t,required:d,inputId:"labour-select",getItemKey:m=>m.id,getItemLabel:m=>m.name,filterFn:(m,l)=>{const o=l.toLowerCase();return m.name.toLowerCase().includes(o)||(m.skill_type?.toLowerCase().includes(o)??!1)||(m.contractor_name?.toLowerCase().includes(o)??!1)},renderItem:m=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:m.name}),m.skill_type&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",m.skill_type,")"]})]}),renderPopoverContent:()=>s?e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.name})]}),s.contractor_name&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Contractor:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.contractor_name})]}),s.mobile&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.mobile})]}),s.skill_type&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Skill Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.skill_type})]}),s.id_proof_no&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.id_proof_no})]}),s.permit_valid_till&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Permit Valid Till:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.permit_valid_till})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a labour to view details."}),loadingText:"Loading labours...",emptyText:"No labours available",notFoundText:"No labours found",addNewLabel:"Add New Labour",onOpenChange:a,onItemSelect:m=>{i(m),v(m)},onClear:()=>{i(null),v(null)},renderCreateDialog:(m,l,o)=>e.jsx(ae,{open:m,onOpenChange:l,onSuccess:x=>{o(x.id,x.name),i(x),v(x)},defaultContractorId:j})})}function le({value:f,onChange:v,placeholder:j="Select visitor",disabled:n=!1,error:p,label:r,required:t=!1}){const[d,h]=_.useState(!1),[a,s]=_.useState(null),{data:i=[],isLoading:c,isError:g}=Q(void 0,d&&!n),N=_.useMemo(()=>i.filter(u=>!u.blacklisted),[i]);return e.jsx(U,{value:f?String(f):void 0,items:N,isLoading:c,isError:g,placeholder:j,disabled:n,error:p,label:r,required:t,inputId:"visitor-select",getItemKey:u=>u.id,getItemLabel:u=>u.name,filterFn:(u,m)=>{const l=m.toLowerCase();return u.name.toLowerCase().includes(l)||(u.company_name?.toLowerCase().includes(l)??!1)},renderItem:u=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:u.name}),u.company_name&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",u.company_name,")"]})]}),renderPopoverContent:()=>a?e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:a.name})]}),a.mobile&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile:"})," ",e.jsx("span",{className:"text-muted-foreground",children:a.mobile})]}),a.company_name&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Company:"})," ",e.jsx("span",{className:"text-muted-foreground",children:a.company_name})]}),a.id_proof_type&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:a.id_proof_type})]}),a.id_proof_no&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:a.id_proof_no})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a visitor to view details."}),loadingText:"Loading visitors...",emptyText:"No visitors available",notFoundText:"No visitors found",addNewLabel:"Add New Visitor",onOpenChange:h,onItemSelect:u=>{s(u),v(u)},onClear:()=>{s(null),v(null)},renderCreateDialog:(u,m,l)=>e.jsx(te,{open:u,onOpenChange:m,onSuccess:o=>{l(o.id,o.name),s(o),v(o)}})})}function ye(){const f=G(),[v]=H(),j=v.get("type"),[n,p]=_.useState(j||"visitor"),[r,t]=_.useState({person_type:j==="labour"?S.LABOUR:S.VISITOR,visitor:null,labour:null,gate_in:null,purpose:"",vehicle_no:"",remarks:""}),[d,h]=_.useState(null),[a,s]=_.useState({});Y(a);const i=W(),c=l=>{p(l),h(null),t(o=>({...o,person_type:l==="labour"?S.LABOUR:S.VISITOR,visitor:null,labour:null})),s({})},g=l=>{h(l),t(o=>({...o,visitor:l?.id||null,labour:null})),a.visitor&&s(o=>{const x={...o};return delete x.visitor,x})},N=l=>{h(l),t(o=>({...o,labour:l?.id||null,visitor:null})),a.labour&&s(o=>{const x={...o};return delete x.labour,x})},u=l=>{t(o=>({...o,gate_in:l?.id||null})),a.gate_in&&s(o=>{const x={...o};return delete x.gate_in,x})},m=async()=>{const l={};if(r.person_type||(l.person_type="Person type is required"),r.gate_in||(l.gate_in="Gate is required"),n==="visitor"&&!r.visitor&&(l.visitor="Please select a visitor"),n==="labour"&&!r.labour&&(l.labour="Please select a labour"),r.vehicle_no.trim()&&!I.vehicleNumber.test(r.vehicle_no.trim().toUpperCase())&&(l.vehicle_no="Please enter a valid vehicle number (e.g., MH12AB1234, DL1LAB1234)"),Object.keys(l).length>0){s(l);return}try{const o={person_type:r.person_type,gate_in:r.gate_in,purpose:r.purpose||void 0,vehicle_no:r.vehicle_no||void 0,remarks:r.remarks||void 0};n==="visitor"?o.visitor=r.visitor:o.labour=r.labour;const x=await i.mutateAsync(o);f(`/gate/visitor-labour/entry/${x.id}`)}catch(o){const x=o,P={};x.errors&&Object.entries(x.errors).forEach(([B,D])=>{Array.isArray(D)&&D.length>0&&(P[B]=D[0])}),x.message&&(P.general=x.message),s(P)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>f("/gate/visitor-labour"),children:e.jsx(se,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"New Entry"}),e.jsx("p",{className:"text-muted-foreground",children:"Create a new gate entry for visitor or labour"})]})]}),a.general&&e.jsx("div",{className:"rounded-lg border border-destructive/50 bg-destructive/10 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(re,{className:"h-5 w-5 text-destructive flex-shrink-0"}),e.jsx("p",{className:"text-sm font-medium text-destructive",children:a.general})]})}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsx(E,{className:"text-base",children:"Person Type"})}),e.jsx(A,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(C,{variant:n==="visitor"?"default":"outline",onClick:()=>c("visitor"),className:"flex-1",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Visitor"]}),e.jsxs(C,{variant:n==="labour"?"default":"outline",onClick:()=>c("labour"),className:"flex-1",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Labour"]})]})})]}),e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsxs(E,{className:"text-base",children:["Select ",n==="visitor"?"Visitor":"Labour"]})}),e.jsxs(A,{className:"space-y-3",children:[n==="visitor"?e.jsx(le,{value:r.visitor,onChange:g,label:"Visitor",placeholder:"Search and select visitor...",error:a.visitor,required:!0}):e.jsx(oe,{value:r.labour,onChange:N,label:"Labour",placeholder:"Search and select labour...",error:a.labour,required:!0}),d&&e.jsx("div",{className:"p-3 rounded-lg border-2 border-primary bg-primary/5",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:d.name}),"company_name"in d&&d.company_name&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.company_name}),"skill_type"in d&&d.skill_type&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.skill_type})]})})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsx(E,{className:"text-base",children:"Entry Details"})}),e.jsxs(A,{className:"space-y-4",children:[e.jsx(Z,{value:r.gate_in,onChange:u,label:"Entry Gate",placeholder:"Select gate...",error:a.gate_in,required:!0}),e.jsxs("div",{children:[e.jsx(b,{children:"Purpose of Visit"}),e.jsx(y,{value:r.purpose,onChange:l=>t(o=>({...o,purpose:l.target.value})),placeholder:"e.g., Meeting with HR, Daily work",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Vehicle Number"}),e.jsx(y,{value:r.vehicle_no,onChange:l=>{const o=l.target.value.toUpperCase().replace(/\s/g,"");t(x=>({...x,vehicle_no:o})),a.vehicle_no&&s(x=>{const P={...x};return delete P.vehicle_no,P})},placeholder:"MH12AB1234",className:w("mt-1",a.vehicle_no&&"border-destructive")}),a.vehicle_no&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:a.vehicle_no})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Remarks"}),e.jsx("textarea",{value:r.remarks,onChange:l=>t(o=>({...o,remarks:l.target.value})),placeholder:"Any additional notes...",className:"mt-1 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",rows:3})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{variant:"outline",onClick:()=>f("/gate/visitor-labour"),className:"flex-1",children:"Cancel"}),e.jsx(C,{onClick:m,disabled:i.isPending,className:"flex-1",children:i.isPending?"Creating...":"Create Entry"})]})]})]})]})}export{ye as default};
