import{F as b,G as g,H as D,a as z,r as v,j as i,k as P,C as R,b as X,c as ee,e as O,L as u,I as y,J as x,N as T}from"./index-DVXWn1VN.js";import{A as ie}from"./status.constants--RT6r8bX.js";import{b as te}from"./validation.constants-DHFF3fUR.js";import{i as ae,a as se,g as re,b as Q}from"./error-qMYEww3Q.js";import{u as le}from"./useScrollToError-B69Qq30W.js";import{a as V}from"./useMutation-BYF3D-8F.js";import{u as ne}from"./poReceipt.queries-Db2AVMyQ.js";import{a as ce}from"./vehicleEntry.queries-CF7tHdFa.js";import{F as de}from"./FillDataAlert-Ds-Fx3PU.js";import{S as oe}from"./StepFooter-IJHXKLiV.js";import{S as _e}from"./StepHeader-Bu78yBsT.js";import{S as ue}from"./StepLoadingSpinner-TrlI3lCB.js";import"./driver.schema-DO7pkEio.js";import"./vehicle.schema-Cw9NqPJ5.js";import{W as pe}from"./wizard.constants-DfnuBX7K.js";import{u as me}from"./useEntryId-CRo250vv.js";import{F as ye}from"./file-text-B257ltzM.js";import{C as he}from"./circle-alert-DBCxtkRD.js";import"./triangle-alert-OXPPGy6N.js";import"./circle-x-BefDMP0y.js";import"./circle-check-DuYl4wQ3.js";import"./clock-BZ_POEj3.js";import"./arrow-left-DuG4Sj7B.js";import"./schemas-D8ebsZBL.js";const w={async get(s){try{return(await b.get(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_GET(s))).data}catch(c){if(c.status===404)return null;throw c}},async getById(s){return(await b.get(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_BY_ID(s))).data},async create(s,c){return(await b.post(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_CREATE(s),c)).data},async update(s,c){return(await b.post(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_CREATE(s),c)).data},async submit(s){return(await b.post(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_SUBMIT(s))).data},async list(s){return(await b.get(g.QUALITY_CONTROL_V2.ARRIVAL_SLIP_LIST,{params:s})).data}};function be(){const s=D();return V({mutationFn:({poItemReceiptId:c,data:d})=>w.create(c,d),onSuccess:(c,{poItemReceiptId:d})=>{s.invalidateQueries({queryKey:["arrivalSlip",d]}),s.invalidateQueries({queryKey:["arrivalSlips"]}),s.invalidateQueries({queryKey:["gateEntryFullView"]})}})}function ge(){const s=D();return V({mutationFn:c=>w.submit(c),onSuccess:()=>{s.invalidateQueries({queryKey:["arrivalSlip"]}),s.invalidateQueries({queryKey:["arrivalSlips"]}),s.invalidateQueries({queryKey:["gateEntryFullView"]}),s.invalidateQueries({queryKey:["pendingInspections"]})}})}function Ue(){const s=z(),c=D(),{entryId:d,entryIdNumber:I,isEditMode:$}=me(),M=pe.STEPS.ARRIVAL_SLIP,{data:j=[],isLoading:q,error:S}=ne(I||null),{data:f,isLoading:U}=ce(I||null),E=be(),k=ge(),[m,A]=v.useState([]),[l,h]=v.useState({});le(l);const[B,K]=v.useState(!1),[L,Y]=v.useState(!1),N=$&&!L;v.useEffect(()=>{if(j.length>0&&f){const e=new Date().toISOString().slice(0,16),t=[];for(const a of j)for(const r of a.items)r.id&&t.push({id:r.id,po_item_code:r.po_item_code,item_name:r.item_name,ordered_qty:r.ordered_qty,received_qty:r.received_qty,uom:r.uom,supplier_name:a.supplier_name,po_number:a.po_number,existingSlip:null,isSubmitted:!1,slipId:null,formData:{particulars:`${r.item_name}`,arrival_datetime:e,party_name:a.supplier_name,billing_qty:r.received_qty.toString(),billing_uom:r.uom,truck_no_as_per_bill:f.vehicle?.vehicle_number||"",commercial_invoice_no:"",eway_bill_no:"",bilty_no:"",has_certificate_of_analysis:!1,has_certificate_of_quantity:!1,remarks:""}});A(t)}},[j,f]),v.useEffect(()=>{(async()=>{if(m.length===0||!N)return;const t=[...m];let a=!1;for(let r=0;r<t.length;r++){const _=t[r];if(!_.existingSlip)try{const n=await w.get(_.id);n&&(t[r]={..._,existingSlip:n,isSubmitted:n.status===ie.SUBMITTED,slipId:n.id,formData:{particulars:n.particulars,arrival_datetime:n.arrival_datetime?.slice(0,16)||"",party_name:n.party_name,billing_qty:n.billing_qty,billing_uom:n.billing_uom,truck_no_as_per_bill:n.truck_no_as_per_bill,commercial_invoice_no:n.commercial_invoice_no||"",eway_bill_no:n.eway_bill_no||"",bilty_no:n.bilty_no||"",has_certificate_of_analysis:n.has_certificate_of_analysis,has_certificate_of_quantity:n.has_certificate_of_quantity,remarks:n.remarks||""}},a=!0)}catch{}}a&&A(t)})()},[m.length,N]);const p=(e,t,a)=>{A(r=>r.map(_=>_.id===e?{..._,formData:{..._.formData,[t]:a}}:_)),l[`${e}_${t}`]&&h(r=>{const _={...r};return delete _[`${e}_${t}`],_})},H=()=>{Y(!0),h({})},G=()=>{s($&&d?`/gate/raw-materials/edit/${d}/step3`:`/gate/raw-materials/new/step3?entryId=${d}`)},W=e=>{const t={};return e.formData.particulars.trim()||(t[`${e.id}_particulars`]="Particulars is required"),e.formData.arrival_datetime||(t[`${e.id}_arrival_datetime`]="Arrival date/time is required"),e.formData.party_name.trim()||(t[`${e.id}_party_name`]="Party name is required"),(!e.formData.billing_qty||parseFloat(e.formData.billing_qty)<=0)&&(t[`${e.id}_billing_qty`]="Billing quantity is required"),e.formData.billing_uom.trim()||(t[`${e.id}_billing_uom`]="Billing UOM is required"),e.formData.truck_no_as_per_bill.trim()?te.vehicleNumber.test(e.formData.truck_no_as_per_bill.trim().toUpperCase())||(t[`${e.id}_truck_no_as_per_bill`]="Please enter a valid vehicle number (e.g., MH12AB1234)"):t[`${e.id}_truck_no_as_per_bill`]="Truck number is required",t},J=async()=>{if(!d){h({general:"Entry ID is missing. Please go back to step 1."});return}if(N&&m.every(t=>t.isSubmitted)){s(`/gate/raw-materials/edit/${d}/step5`);return}let e={};for(const t of m)if(!t.isSubmitted){const a=W(t);e={...e,...a}}if(Object.keys(e).length>0){h(e);return}h({});try{for(const t of m)if(!t.isSubmitted){const a={particulars:t.formData.particulars,arrival_datetime:new Date(t.formData.arrival_datetime).toISOString(),weighing_required:!0,party_name:t.formData.party_name,billing_qty:parseFloat(t.formData.billing_qty),billing_uom:t.formData.billing_uom,truck_no_as_per_bill:t.formData.truck_no_as_per_bill,commercial_invoice_no:t.formData.commercial_invoice_no,eway_bill_no:t.formData.eway_bill_no,bilty_no:t.formData.bilty_no,has_certificate_of_analysis:t.formData.has_certificate_of_analysis,has_certificate_of_quantity:t.formData.has_certificate_of_quantity,remarks:t.formData.remarks},r=await E.mutateAsync({poItemReceiptId:t.id,data:a});await k.mutateAsync(r.id)}K(!0),s($?`/gate/raw-materials/edit/${d}/step5`:`/gate/raw-materials/new/step5?entryId=${d}`)}catch(t){const a=t;if(a.errors){const r={};Object.entries(a.errors).forEach(([_,n])=>{Array.isArray(n)&&n.length>0&&(r[_]=n[0])}),h(r)}else h({general:a.message||"Failed to save arrival slips"})}},C=ae(S),Z=se(S),F=N&&!q&&(j.length===0||C);if(q||U)return i.jsx(ue,{});const o=E.isPending||k.isPending;return i.jsxs("div",{className:"space-y-6 pb-6",children:[i.jsx(_e,{currentStep:M,error:Z?re():l.general||(S&&!C?Q(S,"Failed to load PO receipts"):null)}),F&&!L&&i.jsx(de,{message:C?Q(S,"PO receipts not found"):"No PO receipts found. Please go back to Step 3 to add PO receipts.",onFillData:H}),m.length>0&&m.every(e=>e.isSubmitted)&&i.jsxs("div",{className:"rounded-md bg-green-50 p-4 text-sm text-green-800 flex items-center gap-2",children:[i.jsx(P,{className:"h-5 w-5"}),"All arrival slips have been submitted to QA. Click Next to proceed to Weighment."]}),i.jsxs("div",{className:"space-y-6",children:[m.map((e,t)=>i.jsxs(R,{className:e.isSubmitted?"opacity-75":"",children:[i.jsxs(X,{children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs(ee,{className:"flex items-center gap-2",children:[i.jsx(ye,{className:"h-5 w-5"}),i.jsxs("span",{children:["Arrival Slip ",t+1,": ",e.item_name]})]}),e.isSubmitted&&i.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800",children:[i.jsx(P,{className:"h-3 w-3"}),"Submitted"]})]}),i.jsxs("p",{className:"text-sm text-muted-foreground",children:["PO: ",e.po_number," | Item Code: ",e.po_item_code," | Received Qty:"," ",e.received_qty," ",e.uom]})]}),i.jsx(O,{children:i.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`particulars-${e.id}`,children:["Particulars ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`particulars-${e.id}`,placeholder:"Material description",value:e.formData.particulars,onChange:a=>p(e.id,"particulars",a.target.value),disabled:e.isSubmitted||o,className:x(l[`${e.id}_particulars`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_particulars`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_particulars`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`arrival_datetime-${e.id}`,children:["Arrival Date/Time ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`arrival_datetime-${e.id}`,type:"datetime-local",value:e.formData.arrival_datetime,onChange:a=>p(e.id,"arrival_datetime",a.target.value),disabled:e.isSubmitted||o,className:x(l[`${e.id}_arrival_datetime`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_arrival_datetime`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_arrival_datetime`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`party_name-${e.id}`,children:["Party Name ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`party_name-${e.id}`,placeholder:"Supplier name",value:e.formData.party_name,onChange:a=>p(e.id,"party_name",a.target.value),disabled:e.isSubmitted||o,className:x(l[`${e.id}_party_name`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_party_name`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_party_name`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`billing_qty-${e.id}`,children:["Billing Quantity ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`billing_qty-${e.id}`,type:"number",step:"0.001",min:"0",placeholder:"0",value:e.formData.billing_qty,onChange:a=>p(e.id,"billing_qty",a.target.value),disabled:e.isSubmitted||o,className:x(l[`${e.id}_billing_qty`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_billing_qty`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_billing_qty`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`billing_uom-${e.id}`,children:["Billing UOM ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`billing_uom-${e.id}`,placeholder:"Pcs, Kg, etc.",value:e.formData.billing_uom,onChange:a=>p(e.id,"billing_uom",a.target.value),disabled:e.isSubmitted||o,className:x(l[`${e.id}_billing_uom`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_billing_uom`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_billing_uom`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(u,{htmlFor:`truck_no_as_per_bill-${e.id}`,children:["Truck No. (as per Bill) ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(y,{id:`truck_no_as_per_bill-${e.id}`,placeholder:"MH12AB1234",value:e.formData.truck_no_as_per_bill,onChange:a=>{const r=a.target.value.toUpperCase().replace(/\s/g,"");p(e.id,"truck_no_as_per_bill",r)},disabled:e.isSubmitted||o,className:x(l[`${e.id}_truck_no_as_per_bill`]&&"border-destructive",e.isSubmitted&&"cursor-not-allowed opacity-50")}),l[`${e.id}_truck_no_as_per_bill`]&&i.jsx("p",{className:"text-sm text-destructive",children:l[`${e.id}_truck_no_as_per_bill`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(u,{htmlFor:`commercial_invoice_no-${e.id}`,children:"Commercial Invoice No."}),i.jsx(y,{id:`commercial_invoice_no-${e.id}`,placeholder:"Invoice number",value:e.formData.commercial_invoice_no,onChange:a=>p(e.id,"commercial_invoice_no",a.target.value),disabled:e.isSubmitted||o,className:e.isSubmitted?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(u,{htmlFor:`eway_bill_no-${e.id}`,children:"E-way Bill No."}),i.jsx(y,{id:`eway_bill_no-${e.id}`,placeholder:"E-way bill number",value:e.formData.eway_bill_no,onChange:a=>p(e.id,"eway_bill_no",a.target.value),disabled:e.isSubmitted||o,className:e.isSubmitted?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(u,{htmlFor:`bilty_no-${e.id}`,children:"Bilty No."}),i.jsx(y,{id:`bilty_no-${e.id}`,placeholder:"Bilty/LR number",value:e.formData.bilty_no,onChange:a=>p(e.id,"bilty_no",a.target.value),disabled:e.isSubmitted||o,className:e.isSubmitted?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[i.jsx(u,{htmlFor:`remarks-${e.id}`,children:"Remarks"}),i.jsx(y,{id:`remarks-${e.id}`,placeholder:"Any additional remarks",value:e.formData.remarks,onChange:a=>p(e.id,"remarks",a.target.value),disabled:e.isSubmitted||o,className:e.isSubmitted?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-4 md:col-span-2 lg:col-span-3",children:[i.jsx(u,{children:"Certificates"}),i.jsxs("div",{className:"flex flex-wrap gap-6",children:[i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx(T,{id:`has_certificate_of_analysis-${e.id}`,checked:e.formData.has_certificate_of_analysis,onCheckedChange:a=>p(e.id,"has_certificate_of_analysis",a===!0),disabled:e.isSubmitted||o}),i.jsx(u,{htmlFor:`has_certificate_of_analysis-${e.id}`,className:"text-sm font-normal cursor-pointer",children:"Certificate of Analysis (COA)"})]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx(T,{id:`has_certificate_of_quantity-${e.id}`,checked:e.formData.has_certificate_of_quantity,onCheckedChange:a=>p(e.id,"has_certificate_of_quantity",a===!0),disabled:e.isSubmitted||o}),i.jsx(u,{htmlFor:`has_certificate_of_quantity-${e.id}`,className:"text-sm font-normal cursor-pointer",children:"Certificate of Quantity (COQ)"})]})]})]})]})})]},e.id)),m.length===0&&!F&&i.jsx(R,{children:i.jsx(O,{className:"py-8",children:i.jsxs("div",{className:"text-center text-muted-foreground",children:[i.jsx(he,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),i.jsx("p",{children:"No PO item receipts found to create arrival slips."}),i.jsx("p",{className:"text-sm mt-2",children:"Please go back to Step 3 to add PO receipts first."})]})})})]}),i.jsx(oe,{onPrevious:G,onCancel:()=>{c.invalidateQueries({queryKey:["vehicleEntries"]}),s("/gate/raw-materials")},onNext:J,showUpdate:!1,isSaving:o||B,isEditMode:N,isUpdateMode:!1,nextLabel:m.every(e=>e.isSubmitted)?"Next":"Submit to QA and Continue"})]})}export{Ue as default};
