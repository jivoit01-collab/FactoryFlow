import{F as C,G as k,H as P,a as B,r as p,j as e,C as J,b as Y,c as Z,e as z,L as f,I as x,J as y}from"./index-FTIaQgW5.js";import{E as X}from"./status.constants-Dr0xsafU.js";import{i as ee,a as te,g as se,b as M}from"./error-qMYEww3Q.js";import{u as ie}from"./useScrollToError-Bl7nvqHc.js";import{a as re}from"./vehicleEntry.queries-CpunRUYK.js";import{a as ae,u as ne}from"./useMutation-BQU46QGt.js";import{F as oe}from"./FillDataAlert-Dw7qjoDT.js";import{S as ce}from"./StepFooter-Ce1KvPfQ.js";import{S as ge}from"./StepHeader-DSN-sJxx.js";import{S as de}from"./StepLoadingSpinner-BqtP6mWs.js";import"./driver.schema-DO7pkEio.js";import"./vehicle.schema-Cw9NqPJ5.js";import{W as le}from"./wizard.constants-DfnuBX7K.js";import{u as me}from"./useEntryId-CXyPnhqX.js";import{S as he}from"./scale-DfFMk5d2.js";import"./triangle-alert-DwAJckdW.js";import"./circle-x-DPVka7m7.js";import"./circle-check-Bl6EaNhP.js";import"./clock-CjpRzroy.js";import"./circle-alert-BN4aLgiR.js";import"./arrow-left-W805IoU0.js";import"./validation.constants-DHFF3fUR.js";import"./schemas-D8ebsZBL.js";const D={async get(r){const o=await C.get(k.WEIGHMENT.GET(r));return Array.isArray(o.data)?o.data.length===0?null:o.data[0]:o.data},async create(r,o){return(await C.post(k.WEIGHMENT.CREATE(r),o)).data}};function ue(r){return ne({queryKey:["weighment",r],queryFn:()=>D.get(r),enabled:!!r})}function pe(r){const o=P();return ae({mutationFn:g=>D.create(r,g),onSuccess:()=>{o.invalidateQueries({queryKey:["weighment"]}),o.invalidateQueries({queryKey:["gateEntryFullView"]})}})}function Oe(){const r=B(),o=P(),{entryId:g,entryIdNumber:w,isEditMode:W}=me(),I=le.STEPS.WEIGHMENT,h=pe(w||0),{data:a,isLoading:S,error:N}=ue(W&&w?w:null),{data:A}=re(W&&w?w:null),[t,E]=p.useState({grossWeight:"0",tareWeight:"0",weighbridgeTicketNo:"",firstWeighmentTime:"",secondWeighmentTime:""}),_=p.useMemo(()=>{const s=parseFloat(t.grossWeight)||0,c=parseFloat(t.tareWeight)||0;return Math.max(0,s-c).toFixed(3)},[t.grossWeight,t.tareWeight]),[i,n]=p.useState({});ie(i);const[j,$]=p.useState(!1),[T,q]=p.useState(!1),[O,G]=p.useState(!1),l=W&&!j;p.useEffect(()=>{if(l&&a){let s=a.first_weighment_time?a.first_weighment_time.slice(11,16):"",c=a.second_weighment_time?a.second_weighment_time.slice(11,16):"";if(!s&&!c&&a.remarks){const m=a.remarks.match(/First weighment:\s*([\d:]+)/i),u=a.remarks.match(/Second weighment:\s*([\d:]+)/i);m&&(s=m[1]),u&&(c=u[1])}E({grossWeight:a.gross_weight||"0",tareWeight:a.tare_weight||"0",weighbridgeTicketNo:a.weighbridge_slip_no||"",firstWeighmentTime:s,secondWeighmentTime:c})}},[l,a]);const v=(s,c)=>{l&&!T||(E(m=>({...m,[s]:c})),i[s]&&n(m=>{const u={...m};return delete u[s],u}))},U=()=>{$(!0),E({grossWeight:"0",tareWeight:"0",weighbridgeTicketNo:"",firstWeighmentTime:"",secondWeighmentTime:""}),n({})},H=()=>{r(W&&g?`/gate/raw-materials/edit/${g}/step4`:`/gate/raw-materials/new/step4?entryId=${g}`)},L=async()=>{if(!g){n({general:"Entry ID is missing. Please go back to step 1."});return}if(l&&!T){r(`/gate/raw-materials/edit/${g}/attachments`);return}if(n({}),!t.grossWeight||parseFloat(t.grossWeight)<=0){n({grossWeight:"Please enter gross weight"});return}if(!t.tareWeight||parseFloat(t.tareWeight)<=0){n({tareWeight:"Please enter tare weight"});return}if(parseFloat(t.tareWeight)>=parseFloat(t.grossWeight)){n({tareWeight:"Tare weight must be less than gross weight"});return}if(!t.weighbridgeTicketNo.trim()){n({weighbridgeTicketNo:"Please enter weighbridge ticket number"});return}if(!t.firstWeighmentTime.trim()){n({firstWeighmentTime:"Please enter first weighment time"});return}if(!t.secondWeighmentTime.trim()){n({secondWeighmentTime:"Please enter second weighment time"});return}try{const s={gross_weight:parseFloat(t.grossWeight),tare_weight:parseFloat(t.tareWeight),weighbridge_slip_no:t.weighbridgeTicketNo,first_weighment_time:`${new Date().toISOString().slice(0,10)}T${t.firstWeighmentTime}:00`,second_weighment_time:`${new Date().toISOString().slice(0,10)}T${t.secondWeighmentTime}:00`};await h.mutateAsync(s),G(!0),r(W?`/gate/raw-materials/edit/${g}/attachments`:`/gate/raw-materials/new/attachments?entryId=${g}`)}catch(s){const c=s;if(c.errors){const m={};Object.entries(c.errors).forEach(([u,F])=>{Array.isArray(F)&&F.length>0&&(m[u]=F[0])}),n(m)}else n({general:c.message||"Failed to save weighment details"})}},b=ee(N),Q=te(N),R=l&&!S&&(!a||b),d=l&&!!a&&!j&&!T||b&&!j,K=l&&A?.status!==X.COMPLETED&&!!a,V=()=>{q(!0)};return W&&S?e.jsx(de,{}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsx(ge,{currentStep:I,error:Q?se():i.general||(N&&!b?M(N,"Failed to load weighment data"):null)}),R&&!j&&e.jsx(oe,{message:b?M(N,"Weighment not found"):"No weighment data found for this entry.",onFillData:U}),e.jsx("div",{className:"space-y-6",children:e.jsxs(J,{children:[e.jsx(Y,{children:e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),"Weighment Details"]})}),e.jsx(z,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"grossWeight",children:["Gross Weight ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{id:"grossWeight",type:"number",step:"0.001",min:"0",placeholder:"0",value:t.grossWeight,onChange:s=>v("grossWeight",s.target.value),disabled:d||h.isPending,className:y(i.grossWeight&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.grossWeight&&e.jsx("p",{className:"text-sm text-destructive",children:i.grossWeight})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"tareWeight",children:["Tare Weight ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{id:"tareWeight",type:"number",step:"0.001",min:"0",placeholder:"0",value:t.tareWeight,onChange:s=>v("tareWeight",s.target.value),disabled:d||h.isPending,className:y(i.tareWeight&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.tareWeight&&e.jsx("p",{className:"text-sm text-destructive",children:i.tareWeight})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"netWeight",children:"Net Weight"}),e.jsx(x,{id:"netWeight",type:"text",placeholder:"Auto-calculated",value:_==="0.000"?"":_,readOnly:!0,disabled:!0,className:"bg-muted cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-calculated"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"weighbridgeTicketNo",children:["Weighbridge Ticket No. ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{id:"weighbridgeTicketNo",placeholder:"WB-2026-001",value:t.weighbridgeTicketNo,onChange:s=>v("weighbridgeTicketNo",s.target.value),disabled:d||h.isPending,className:y(i.weighbridgeTicketNo&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.weighbridgeTicketNo&&e.jsx("p",{className:"text-sm text-destructive",children:i.weighbridgeTicketNo})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"firstWeighmentTime",children:["First Weighment Time ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{id:"firstWeighmentTime",type:"time",placeholder:"--:--",value:t.firstWeighmentTime,onChange:s=>v("firstWeighmentTime",s.target.value),disabled:d||h.isPending,className:y(i.firstWeighmentTime&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.firstWeighmentTime&&e.jsx("p",{className:"text-sm text-destructive",children:i.firstWeighmentTime})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(f,{htmlFor:"secondWeighmentTime",children:["Second Weighment Time ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{id:"secondWeighmentTime",type:"time",placeholder:"--:--",value:t.secondWeighmentTime,onChange:s=>v("secondWeighmentTime",s.target.value),disabled:d||h.isPending,className:y(i.secondWeighmentTime&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.secondWeighmentTime&&e.jsx("p",{className:"text-sm text-destructive",children:i.secondWeighmentTime})]})]})})]})}),e.jsx(ce,{onPrevious:H,onCancel:()=>{o.invalidateQueries({queryKey:["vehicleEntries"]}),r("/gate/raw-materials")},onNext:L,showUpdate:l&&K&&!T,onUpdate:V,isSaving:h.isPending||O,isEditMode:l,isUpdateMode:T})]})}export{Oe as default};
