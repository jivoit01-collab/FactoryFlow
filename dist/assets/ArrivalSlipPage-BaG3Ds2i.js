import{F as v,G as x,H as I,a as te,r as g,j as i,k as Q,C as V,b as ae,c as se,e as M,L as p,I as h,J as S,N as U}from"./index-BlttmsHz.js";import{A as re}from"./status.constants-B0MYmmeb.js";import{b as le}from"./validation.constants-DHFF3fUR.js";import{i as ne,a as ce,g as de,b as B}from"./error-qMYEww3Q.js";import{u as oe}from"./useScrollToError-BbXkMWnH.js";import{a as Y}from"./useMutation-TnQ6hR0R.js";import{u as _e}from"./poReceipt.queries-BPqeQ4fs.js";import{a as ue}from"./vehicleEntry.queries-CFavWUt-.js";import{F as K}from"./FillDataAlert-jaU4Alzu.js";import{S as pe}from"./StepFooter-nTTeyMCN.js";import{S as me}from"./StepHeader-C7ugY6Ck.js";import{S as ye}from"./StepLoadingSpinner-ltyJ_nLr.js";import"./driver.schema-DO7pkEio.js";import"./vehicle.schema-Cw9NqPJ5.js";import{W as he}from"./wizard.constants-DfnuBX7K.js";import{u as be}from"./useEntryId-Cz9iv8zj.js";import{F as ge}from"./file-text-CHubKTsl.js";import{C as ve}from"./circle-alert-CUcQmltW.js";import"./triangle-alert-CadjuZfY.js";import"./circle-x-CXmN1Y2K.js";import"./circle-check-oo-uuCfp.js";import"./clock-IkmY-E9y.js";import"./arrow-left-D1raZAL5.js";import"./schemas-D8ebsZBL.js";const q={async get(s){try{return(await v.get(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_GET(s))).data}catch(d){if(d.status===404)return null;throw d}},async getById(s){return(await v.get(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_BY_ID(s))).data},async create(s,d){return(await v.post(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_CREATE(s),d)).data},async update(s,d){return(await v.post(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_CREATE(s),d)).data},async submit(s){return(await v.post(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_SUBMIT(s))).data},async list(s){return(await v.get(x.QUALITY_CONTROL_V2.ARRIVAL_SLIP_LIST,{params:s})).data}};function xe(){const s=I();return Y({mutationFn:({poItemReceiptId:d,data:o})=>q.create(d,o),onSuccess:(d,{poItemReceiptId:o})=>{s.invalidateQueries({queryKey:["arrivalSlip",o]}),s.invalidateQueries({queryKey:["arrivalSlips"]}),s.invalidateQueries({queryKey:["gateEntryFullView"]})}})}function Se(){const s=I();return Y({mutationFn:d=>q.submit(d),onSuccess:()=>{s.invalidateQueries({queryKey:["arrivalSlip"]}),s.invalidateQueries({queryKey:["arrivalSlips"]}),s.invalidateQueries({queryKey:["gateEntryFullView"]}),s.invalidateQueries({queryKey:["pendingInspections"]})}})}function Ye(){const s=te(),d=I(),{entryId:o,entryIdNumber:E,isEditMode:A}=be(),H=he.STEPS.ARRIVAL_SLIP,{data:f=[],isLoading:k,error:N}=_e(E||null),{data:D,isLoading:G}=ue(E||null),F=xe(),L=Se(),[y,C]=g.useState([]),[n,b]=g.useState({});oe(n);const[W,J]=g.useState(!1),[$,Z]=g.useState(!1),[R,P]=g.useState(!1),j=A&&!$;g.useEffect(()=>{if(f.length>0&&D){const e=new Date().toISOString().slice(0,16),t=[];for(const a of f)for(const r of a.items)r.id&&t.push({id:r.id,po_item_code:r.po_item_code,item_name:r.item_name,ordered_qty:r.ordered_qty,received_qty:r.received_qty,uom:r.uom,supplier_name:a.supplier_name,po_number:a.po_number,existingSlip:null,isSubmitted:!1,slipId:null,formData:{particulars:`${r.item_name}`,arrival_datetime:e,party_name:a.supplier_name,billing_qty:r.received_qty.toString(),billing_uom:r.uom,truck_no_as_per_bill:D.vehicle?.vehicle_number||"",commercial_invoice_no:"",eway_bill_no:"",bilty_no:"",has_certificate_of_analysis:!1,has_certificate_of_quantity:!1,remarks:""}});C(t)}},[f,D]),g.useEffect(()=>{(async()=>{if(y.length===0||!j)return;const t=[...y];let a=!1;for(let r=0;r<t.length;r++){const u=t[r];if(!u.existingSlip)try{const c=await q.get(u.id);c&&(t[r]={...u,existingSlip:c,isSubmitted:c.status===re.SUBMITTED,slipId:c.id,formData:{particulars:c.particulars,arrival_datetime:c.arrival_datetime?.slice(0,16)||"",party_name:c.party_name,billing_qty:c.billing_qty,billing_uom:c.billing_uom,truck_no_as_per_bill:c.truck_no_as_per_bill,commercial_invoice_no:c.commercial_invoice_no||"",eway_bill_no:c.eway_bill_no||"",bilty_no:c.bilty_no||"",has_certificate_of_analysis:c.has_certificate_of_analysis,has_certificate_of_quantity:c.has_certificate_of_quantity,remarks:c.remarks||""}},a=!0)}catch{}}a?C(t):t.length>0&&P(!0)})()},[y.length,j]);const m=(e,t,a)=>{C(r=>r.map(u=>u.id===e?{...u,formData:{...u.formData,[t]:a}}:u)),n[`${e}_${t}`]&&b(r=>{const u={...r};return delete u[`${e}_${t}`],u})},O=()=>{Z(!0),P(!1),b({})},z=()=>{s(A&&o?`/gate/raw-materials/edit/${o}/step3`:`/gate/raw-materials/new/step3?entryId=${o}`)},X=e=>{const t={};return e.formData.particulars.trim()||(t[`${e.id}_particulars`]="Particulars is required"),e.formData.arrival_datetime||(t[`${e.id}_arrival_datetime`]="Arrival date/time is required"),e.formData.party_name.trim()||(t[`${e.id}_party_name`]="Party name is required"),(!e.formData.billing_qty||parseFloat(e.formData.billing_qty)<=0)&&(t[`${e.id}_billing_qty`]="Billing quantity is required"),e.formData.billing_uom.trim()||(t[`${e.id}_billing_uom`]="Billing UOM is required"),e.formData.truck_no_as_per_bill.trim()?le.vehicleNumber.test(e.formData.truck_no_as_per_bill.trim().toUpperCase())||(t[`${e.id}_truck_no_as_per_bill`]="Please enter a valid vehicle number (e.g., MH12AB1234)"):t[`${e.id}_truck_no_as_per_bill`]="Truck number is required",t},ee=async()=>{if(!o){b({general:"Entry ID is missing. Please go back to step 1."});return}if(j&&y.every(t=>t.isSubmitted)){s(`/gate/raw-materials/edit/${o}/step5`);return}let e={};for(const t of y)if(!t.isSubmitted){const a=X(t);e={...e,...a}}if(Object.keys(e).length>0){b(e);return}b({});try{for(const t of y)if(!t.isSubmitted){const a={particulars:t.formData.particulars,arrival_datetime:new Date(t.formData.arrival_datetime).toISOString(),weighing_required:!0,party_name:t.formData.party_name,billing_qty:parseFloat(t.formData.billing_qty),billing_uom:t.formData.billing_uom,truck_no_as_per_bill:t.formData.truck_no_as_per_bill,commercial_invoice_no:t.formData.commercial_invoice_no,eway_bill_no:t.formData.eway_bill_no,bilty_no:t.formData.bilty_no,has_certificate_of_analysis:t.formData.has_certificate_of_analysis,has_certificate_of_quantity:t.formData.has_certificate_of_quantity,remarks:t.formData.remarks},r=await F.mutateAsync({poItemReceiptId:t.id,data:a});await L.mutateAsync(r.id)}J(!0),s(A?`/gate/raw-materials/edit/${o}/step5`:`/gate/raw-materials/new/step5?entryId=${o}`)}catch(t){const a=t;if(a.errors){const r={};Object.entries(a.errors).forEach(([u,c])=>{Array.isArray(c)&&c.length>0&&(r[u]=c[0])}),b(r)}else b({general:a.message||"Failed to save arrival slips"})}},w=ne(N),ie=ce(N),T=j&&!k&&(f.length===0||w);if(k||G)return i.jsx(ye,{});const _=F.isPending||L.isPending,l=R&&!$;return i.jsxs("div",{className:"space-y-6 pb-6",children:[i.jsx(me,{currentStep:H,error:ie?de():n.general||(N&&!w?B(N,"Failed to load PO receipts"):null)}),T&&!$&&i.jsx(K,{message:w?B(N,"PO receipts not found"):"No PO receipts found. Please go back to Step 3 to add PO receipts.",onFillData:O}),R&&!$&&i.jsx(K,{message:"Arrival slip not found",onFillData:O}),y.length>0&&y.every(e=>e.isSubmitted)&&i.jsxs("div",{className:"rounded-md bg-green-50 p-4 text-sm text-green-800 flex items-center gap-2",children:[i.jsx(Q,{className:"h-5 w-5"}),"All arrival slips have been submitted to QA. Click Next to proceed to Weighment."]}),i.jsxs("div",{className:"space-y-6",children:[y.map((e,t)=>i.jsxs(V,{className:e.isSubmitted||l?"opacity-75":"",children:[i.jsxs(ae,{children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs(se,{className:"flex items-center gap-2",children:[i.jsx(ge,{className:"h-5 w-5"}),i.jsxs("span",{children:["Arrival Slip ",t+1,": ",e.item_name]})]}),e.isSubmitted&&i.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800",children:[i.jsx(Q,{className:"h-3 w-3"}),"Submitted"]})]}),i.jsxs("p",{className:"text-sm text-muted-foreground",children:["PO: ",e.po_number," | Item Code: ",e.po_item_code," | Received Qty:"," ",e.received_qty," ",e.uom]})]}),i.jsx(M,{children:i.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`particulars-${e.id}`,children:["Particulars ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`particulars-${e.id}`,placeholder:"Material description",value:e.formData.particulars,onChange:a=>m(e.id,"particulars",a.target.value),disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_particulars`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_particulars`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_particulars`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`arrival_datetime-${e.id}`,children:["Arrival Date/Time ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`arrival_datetime-${e.id}`,type:"datetime-local",value:e.formData.arrival_datetime,onChange:a=>m(e.id,"arrival_datetime",a.target.value),disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_arrival_datetime`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_arrival_datetime`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_arrival_datetime`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`party_name-${e.id}`,children:["Party Name ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`party_name-${e.id}`,placeholder:"Supplier name",value:e.formData.party_name,onChange:a=>m(e.id,"party_name",a.target.value),disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_party_name`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_party_name`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_party_name`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`billing_qty-${e.id}`,children:["Billing Quantity ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`billing_qty-${e.id}`,type:"number",step:"0.001",min:"0",placeholder:"0",value:e.formData.billing_qty,onChange:a=>m(e.id,"billing_qty",a.target.value),disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_billing_qty`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_billing_qty`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_billing_qty`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`billing_uom-${e.id}`,children:["Billing UOM ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`billing_uom-${e.id}`,placeholder:"Pcs, Kg, etc.",value:e.formData.billing_uom,onChange:a=>m(e.id,"billing_uom",a.target.value),disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_billing_uom`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_billing_uom`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_billing_uom`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs(p,{htmlFor:`truck_no_as_per_bill-${e.id}`,children:["Truck No. (as per Bill) ",i.jsx("span",{className:"text-destructive",children:"*"})]}),i.jsx(h,{id:`truck_no_as_per_bill-${e.id}`,placeholder:"MH12AB1234",value:e.formData.truck_no_as_per_bill,onChange:a=>{const r=a.target.value.toUpperCase().replace(/\s/g,"");m(e.id,"truck_no_as_per_bill",r)},disabled:e.isSubmitted||_||l,className:S(n[`${e.id}_truck_no_as_per_bill`]&&"border-destructive",(e.isSubmitted||l)&&"cursor-not-allowed opacity-50")}),n[`${e.id}_truck_no_as_per_bill`]&&i.jsx("p",{className:"text-sm text-destructive",children:n[`${e.id}_truck_no_as_per_bill`]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(p,{htmlFor:`commercial_invoice_no-${e.id}`,children:"Commercial Invoice No."}),i.jsx(h,{id:`commercial_invoice_no-${e.id}`,placeholder:"Invoice number",value:e.formData.commercial_invoice_no,onChange:a=>m(e.id,"commercial_invoice_no",a.target.value),disabled:e.isSubmitted||_||l,className:e.isSubmitted||l?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(p,{htmlFor:`eway_bill_no-${e.id}`,children:"E-way Bill No."}),i.jsx(h,{id:`eway_bill_no-${e.id}`,placeholder:"E-way bill number",value:e.formData.eway_bill_no,onChange:a=>m(e.id,"eway_bill_no",a.target.value),disabled:e.isSubmitted||_||l,className:e.isSubmitted||l?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx(p,{htmlFor:`bilty_no-${e.id}`,children:"Bilty No."}),i.jsx(h,{id:`bilty_no-${e.id}`,placeholder:"Bilty/LR number",value:e.formData.bilty_no,onChange:a=>m(e.id,"bilty_no",a.target.value),disabled:e.isSubmitted||_||l,className:e.isSubmitted||l?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[i.jsx(p,{htmlFor:`remarks-${e.id}`,children:"Remarks"}),i.jsx(h,{id:`remarks-${e.id}`,placeholder:"Any additional remarks",value:e.formData.remarks,onChange:a=>m(e.id,"remarks",a.target.value),disabled:e.isSubmitted||_||l,className:e.isSubmitted||l?"cursor-not-allowed opacity-50":""})]}),i.jsxs("div",{className:"space-y-4 md:col-span-2 lg:col-span-3",children:[i.jsx(p,{children:"Certificates"}),i.jsxs("div",{className:"flex flex-wrap gap-6",children:[i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx(U,{id:`has_certificate_of_analysis-${e.id}`,checked:e.formData.has_certificate_of_analysis,onCheckedChange:a=>m(e.id,"has_certificate_of_analysis",a===!0),disabled:e.isSubmitted||_||l}),i.jsx(p,{htmlFor:`has_certificate_of_analysis-${e.id}`,className:"text-sm font-normal cursor-pointer",children:"Certificate of Analysis (COA)"})]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx(U,{id:`has_certificate_of_quantity-${e.id}`,checked:e.formData.has_certificate_of_quantity,onCheckedChange:a=>m(e.id,"has_certificate_of_quantity",a===!0),disabled:e.isSubmitted||_||l}),i.jsx(p,{htmlFor:`has_certificate_of_quantity-${e.id}`,className:"text-sm font-normal cursor-pointer",children:"Certificate of Quantity (COQ)"})]})]})]})]})})]},e.id)),y.length===0&&!T&&i.jsx(V,{children:i.jsx(M,{className:"py-8",children:i.jsxs("div",{className:"text-center text-muted-foreground",children:[i.jsx(ve,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),i.jsx("p",{children:"No PO item receipts found to create arrival slips."}),i.jsx("p",{className:"text-sm mt-2",children:"Please go back to Step 3 to add PO receipts first."})]})})})]}),i.jsx(pe,{onPrevious:z,onCancel:()=>{d.invalidateQueries({queryKey:["vehicleEntries"]}),s("/gate/raw-materials")},onNext:ee,showUpdate:!1,isSaving:_||W,isEditMode:j,isUpdateMode:!1,nextLabel:y.every(e=>e.isSubmitted)?"Next":"Submit to QA and Continue"})]})}export{Ye as default};
