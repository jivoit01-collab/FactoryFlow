import{r as N,j as e,a as te,H as re,C as D,b as _,c as P,e as F,L as c,I as p,J as b,B as I}from"./index-BJbr7dGT.js";import{E as ae,S as L}from"./status.constants-CKvLNexP.js";import{b as B}from"./validation.constants-DHFF3fUR.js";import{i as se,a as ie,g as ne,b as oe}from"./error-qMYEww3Q.js";import{u as ce}from"./useScrollToError-ByUJimjt.js";import{u as le,a as de,b as me,c as ue}from"./construction.queries-BqVfdagZ.js";import{a as pe}from"./vehicleEntry.queries-DbBx0ROr.js";import{F as he}from"./FillDataAlert-D33YVBhw.js";import{S as ve}from"./SearchableSelect-Clq-UFxm.js";import"./driver.schema-DO7pkEio.js";import"./vehicle.schema-Cw9NqPJ5.js";import{U as ge}from"./UnitSelect-CQjZWNCd.js";import{u as xe}from"./useEntryId-BeYntrIu.js";import{C as V}from"./circle-alert-DDfM1UF8.js";import{B as be}from"./building-2-BQcjawSq.js";import{P as Ne}from"./package-DfDOAGoA.js";import{F as je}from"./file-check-90pIzKK0.js";import{F as fe}from"./file-text-DOTXvyIB.js";import"./triangle-alert-Dgrezy9J.js";import"./circle-x-D-Gwxygr.js";import"./circle-check-DziCER4n.js";import"./clock-CJiAueV2.js";import"./useMutation-B7kknB8H.js";import"./plus-CkmVnUnI.js";import"./schemas-D8ebsZBL.js";import"./maintenance.queries-C3KH7nxf.js";function ye({value:h,onChange:y,placeholder:d="Select material category",disabled:m=!1,error:v,label:C,required:E=!1,initialDisplayText:S}){const[k,w]=N.useState(!1),{data:s=[],isLoading:q,isError:j}=le(k);return e.jsx(ve,{value:h||void 0,items:s,isLoading:q,isError:j,placeholder:d,disabled:m,error:v,label:C,required:E,inputId:"construction-category-select",inputClassName:"border-2 font-medium",defaultDisplayText:S,getItemKey:g=>g.id,getItemLabel:g=>g.category_name,loadingText:"Loading categories...",emptyText:"No categories available",notFoundText:"No categories found",onOpenChange:w,onItemSelect:g=>{y(g.id.toString(),g.category_name)},onClear:()=>{y("","")}})}const Ce=[{value:L.APPROVED,label:"Approved"},{value:L.PENDING,label:"Pending"},{value:L.REJECTED,label:"Rejected"}];function ze(){const h=te(),y=re(),{entryId:d,entryIdNumber:m,isEditMode:v}=xe(),C=3,E=4,S=C/E*100,k=de(m||0),w=me(m||0),{data:s,isLoading:q,error:j}=ue(v&&m?m:null),{data:g}=pe(v&&m?m:null),[O,H]=N.useState(!1),[f,Q]=N.useState(!1),[Y,J]=N.useState(!1),u=v&&!O,T=se(j),R=ie(j),[t,M]=N.useState({projectName:"",workOrderNumber:"",contractorName:"",contractorContact:"",vehicleNumber:"",materialCategory:"",materialDescription:"",quantity:"",unit:"",unitName:"",challanNumber:"",invoiceNumber:"",siteEngineer:"",securityApproval:"",remarks:""}),[a,i]=N.useState({});ce(a);const n=u&&!f&&!T||T&&!O,K=u&&g?.status!==ae.COMPLETED;N.useEffect(()=>{if(u&&s){const r=typeof s.material_category=="object"?s.material_category.id.toString():s.material_category?.toString()||"";M({projectName:s.project_name||"",workOrderNumber:s.work_order_number||"",contractorName:s.contractor_name||"",contractorContact:s.contractor_contact||"",vehicleNumber:s.vehicle_number||"",materialCategory:r,materialDescription:s.material_description||"",quantity:s.quantity?.toString()||"",unit:typeof s.unit=="object"?s.unit?.id?.toString()||"":s.unit?.toString()||"",unitName:typeof s.unit=="object"&&s.unit?.name||"",challanNumber:s.challan_number||"",invoiceNumber:s.invoice_number||"",siteEngineer:s.site_engineer||"",securityApproval:s.security_approval||"",remarks:s.remarks||""})}},[u,s]);const o=(r,l)=>{n||(M(x=>({...x,[r]:l})),a[r]&&i(x=>{const A={...x};return delete A[r],A}))},W=()=>{h(v&&d?`/gate/construction/edit/${d}/step2`:`/gate/construction/new/step2?entryId=${d}`)},G=()=>{y.invalidateQueries({queryKey:["vehicleEntries"]}),h("/gate/construction")},z=()=>{H(!0)},X=()=>{Q(!0)},Z=async()=>{if(!d||!m){i({general:"Entry ID is missing. Please go back to step 1."});return}if(u&&!f){h(`/gate/construction/edit/${d}/attachments`);return}if(i({}),!t.projectName.trim()){i({projectName:"Please enter project/work order name"});return}if(!t.contractorName.trim()){i({contractorName:"Please enter contractor name"});return}if(t.contractorContact.trim()&&!B.phone.test(t.contractorContact.trim())){i({contractorContact:"Please enter a valid 10-digit phone number"});return}if(t.vehicleNumber.trim()&&!B.vehicleNumber.test(t.vehicleNumber.trim().toUpperCase())){i({vehicleNumber:"Please enter a valid vehicle number (e.g., MH12AB1234)"});return}if(!t.materialCategory){i({materialCategory:"Please select material category"});return}if(!t.materialDescription.trim()){i({materialDescription:"Please enter material description"});return}if(!t.quantity||parseFloat(t.quantity)<=0){i({quantity:"Please enter a valid quantity"});return}if(!t.unit){i({unit:"Please select unit"});return}if(!t.siteEngineer.trim()){i({siteEngineer:"Please enter site engineer name"});return}if(!t.securityApproval){i({securityApproval:"Please select security approval status"});return}try{const r={project_name:t.projectName.trim(),work_order_number:t.workOrderNumber.trim()||void 0,contractor_name:t.contractorName.trim(),contractor_contact:t.contractorContact.trim()||void 0,vehicle_number:t.vehicleNumber.trim()||void 0,material_category:parseInt(t.materialCategory,10),material_description:t.materialDescription.trim(),quantity:parseFloat(t.quantity),unit:parseInt(t.unit),challan_number:t.challanNumber.trim()||void 0,invoice_number:t.invoiceNumber.trim()||void 0,site_engineer:t.siteEngineer.trim(),security_approval:t.securityApproval,remarks:t.remarks.trim()||void 0};v&&f?await w.mutateAsync(r):await k.mutateAsync(r),J(!0),h(v?`/gate/construction/edit/${d}/attachments`:`/gate/construction/new/attachments?entryId=${d}`)}catch(r){const l=r;if(l.errors){const x={};Object.entries(l.errors).forEach(([A,U])=>{Array.isArray(U)&&U.length>0&&(x[A]=U[0])}),i(x)}else i({general:l.message||"Failed to save construction entry"})}},ee=u&&q,$=k.isPending||w.isPending||Y;return e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h2",{className:"text-3xl font-bold tracking-tight",children:["Construction Entry - Step ",C," of ",E]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${S}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground min-w-[3rem]",children:[Math.round(S),"%"]})]})]}),R&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),ne()]}),!R&&a.general&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),a.general]}),u&&T&&!O&&e.jsx(he,{message:oe(j,"Construction entry not found"),onFillData:z}),ee?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(D,{children:[e.jsx(_,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Project & Contractor Details"]})}),e.jsx(F,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"projectName",children:["Project / Work Order Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(p,{id:"projectName",value:t.projectName,onChange:r=>o("projectName",r.target.value),placeholder:"Enter project or work order name",disabled:n,className:b("border-2 font-medium",a.projectName&&"border-destructive")}),a.projectName&&e.jsx("p",{className:"text-sm text-destructive",children:a.projectName})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"workOrderNumber",children:"Work Order Number"}),e.jsx(p,{id:"workOrderNumber",value:t.workOrderNumber,onChange:r=>o("workOrderNumber",r.target.value),placeholder:"Enter work order number (auto-generated if empty)",disabled:n,className:"border-2 font-medium"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"contractorName",children:["Contractor Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(p,{id:"contractorName",value:t.contractorName,onChange:r=>o("contractorName",r.target.value),placeholder:"Enter contractor name",disabled:n,className:b("border-2 font-medium",a.contractorName&&"border-destructive")}),a.contractorName&&e.jsx("p",{className:"text-sm text-destructive",children:a.contractorName})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"contractorContact",children:"Contractor Contact"}),e.jsx(p,{id:"contractorContact",value:t.contractorContact,onChange:r=>{const l=r.target.value.replace(/[^0-9]/g,"").slice(0,10);o("contractorContact",l)},placeholder:"9876543210",maxLength:10,disabled:n,className:b("border-2 font-medium",a.contractorContact&&"border-destructive")}),a.contractorContact&&e.jsx("p",{className:"text-sm text-destructive",children:a.contractorContact})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"vehicleNumber",children:"Vehicle Number"}),e.jsx(p,{id:"vehicleNumber",value:t.vehicleNumber,onChange:r=>{const l=r.target.value.toUpperCase().replace(/\s/g,"");o("vehicleNumber",l)},placeholder:"MH12AB1234",disabled:n,className:b("border-2 font-medium",a.vehicleNumber&&"border-destructive")}),a.vehicleNumber&&e.jsx("p",{className:"text-sm text-destructive",children:a.vehicleNumber})]})]})})]}),e.jsxs(D,{children:[e.jsx(_,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Material Details"]})}),e.jsx(F,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(ye,{value:t.materialCategory||void 0,onChange:r=>{o("materialCategory",r)},placeholder:"Select material category",disabled:n,error:a.materialCategory,label:"Material Category",required:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"quantity",children:["Quantity ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(p,{id:"quantity",type:"number",min:"0",step:"0.01",value:t.quantity,onChange:r=>o("quantity",r.target.value),placeholder:"0",disabled:n,className:b("border-2 font-medium",a.quantity&&"border-destructive")}),a.quantity&&e.jsx("p",{className:"text-sm text-destructive",children:a.quantity})]}),e.jsx(ge,{value:t.unit||void 0,onChange:(r,l)=>{o("unit",r),M(x=>({...x,unitName:l}))},placeholder:"Select unit",disabled:n,error:a.unit,label:"Unit",required:!0,initialDisplayText:t.unitName||void 0})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsxs(c,{htmlFor:"materialDescription",children:["Material Description ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("textarea",{id:"materialDescription",value:t.materialDescription,onChange:r=>o("materialDescription",r.target.value),placeholder:"Enter detailed description of materials",disabled:n,rows:3,className:b("flex w-full rounded-md border-2 border-input bg-background px-3 py-2 text-sm font-medium ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a.materialDescription&&"border-destructive")}),a.materialDescription&&e.jsx("p",{className:"text-sm text-destructive",children:a.materialDescription})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"challanNumber",children:"Challan Number"}),e.jsx(p,{id:"challanNumber",value:t.challanNumber,onChange:r=>o("challanNumber",r.target.value),placeholder:"Enter challan number",disabled:n,className:"border-2 font-medium"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"invoiceNumber",children:"Invoice Number"}),e.jsx(p,{id:"invoiceNumber",value:t.invoiceNumber,onChange:r=>o("invoiceNumber",r.target.value),placeholder:"Enter invoice number",disabled:n,className:"border-2 font-medium"})]})]})})]}),e.jsxs(D,{children:[e.jsx(_,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-5 w-5"}),"Approval & Responsibility"]})}),e.jsx(F,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"siteEngineer",children:["Site Engineer ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(p,{id:"siteEngineer",value:t.siteEngineer,onChange:r=>o("siteEngineer",r.target.value),placeholder:"Enter site engineer name",disabled:n,className:b("border-2 font-medium",a.siteEngineer&&"border-destructive")}),a.siteEngineer&&e.jsx("p",{className:"text-sm text-destructive",children:a.siteEngineer})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(c,{htmlFor:"securityApproval",children:["Security Approval ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{id:"securityApproval",className:b("flex h-10 w-full rounded-md border-2 border-input bg-background px-3 py-2 text-sm font-medium ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a.securityApproval&&"border-destructive"),value:t.securityApproval,onChange:r=>o("securityApproval",r.target.value),disabled:n,children:[e.jsx("option",{value:"",children:"Select approval status"}),Ce.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))]}),a.securityApproval&&e.jsx("p",{className:"text-sm text-destructive",children:a.securityApproval})]})]})})]}),e.jsxs(D,{children:[e.jsx(_,{children:e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Additional Information"]})}),e.jsx(F,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"remarks",children:"Remarks"}),e.jsx("textarea",{id:"remarks",value:t.remarks,onChange:r=>o("remarks",r.target.value),placeholder:"Enter any additional remarks or notes",disabled:n,rows:3,className:"flex w-full rounded-md border-2 border-input bg-background px-3 py-2 text-sm font-medium ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsx(I,{type:"button",variant:"outline",onClick:W,children:"Previous"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(I,{type:"button",variant:"outline",onClick:G,children:"Cancel"}),u&&K&&!f&&e.jsx(I,{type:"button",variant:"secondary",onClick:X,children:"Update"}),e.jsx(I,{type:"button",onClick:Z,disabled:$,children:$?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"h-4 w-4 mr-2 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Saving..."]}):u&&!f?"Next":"Save & Next"})]})]})]})}export{ze as default};
