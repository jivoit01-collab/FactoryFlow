import{y as xe,H as L,J as F,K,r as d,j as e,D as ee,m as re,n as se,o as te,p as ne,L as C,I as A,B as R,X as ye,q as ae,O as ie,C as G,b as W,c as J,T as be,e as X,M as de,U as fe,V as ue,a as Ne,W as ge}from"./index-DfliZ1OU.js";import{E as je}from"./status.constants-q2VkBYr0.js";import{a as _e,g as Ie}from"./error-qMYEww3Q.js";import{b as Pe,c as Ce,a as Ee}from"./vehicleEntry.queries-BEHxWCSE.js";import{d as Te,I as Se,a as Z}from"./driver.schema-DZt_XaHY.js";import{t as we,v as Ve}from"./vehicle.schema-BmxwMEOL.js";import{u as Q}from"./useScrollToError-n191AQtQ.js";import{S as $}from"./SearchableSelect-DtgnHOvJ.js";import{u as M,a as O}from"./useMutation-BW1s3MWF.js";import{u as oe,a as le}from"./zod-h_d7EOI4.js";import{C as De}from"./circle-alert-BrmK50Th.js";const Le=[{value:"Aadhar",label:"Aadhar"},{value:"PAN Card",label:"PAN Card"},{value:"Driving License",label:"Driving License"},{value:"Voter ID",label:"Voter ID"},{value:"Other",label:"Other"}];const Fe=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],B=xe("camera",Fe),Y={async getNames(){return(await L.get(F.DRIVER.DRIVER_NAMES)).data},async getById(r){return(await L.get(F.DRIVER.DRIVER_BY_ID(r))).data},async getList(){return(await L.get(F.DRIVER.DRIVERS)).data},async create(r){const s=new FormData;return s.append("name",r.name),s.append("mobile_no",r.mobile_no),s.append("license_no",r.license_no),s.append("id_proof_type",r.id_proof_type),s.append("id_proof_number",r.id_proof_number),r.photo&&s.append("photo",r.photo),(await L.post(F.DRIVER.DRIVERS,s,{headers:{"Content-Type":"multipart/form-data"}})).data},async update(r){const s=new FormData;return s.append("name",r.name),s.append("mobile_no",r.mobile_no),s.append("license_no",r.license_no),s.append("id_proof_type",r.id_proof_type),s.append("id_proof_number",r.id_proof_number),r.photo&&s.append("photo",r.photo),(await L.put(F.DRIVER.DRIVER_BY_ID(r.id),s,{headers:{"Content-Type":"multipart/form-data"}})).data}};function Ae(r=!0){return M({queryKey:["driverNames"],queryFn:()=>Y.getNames(),staleTime:600*1e3,enabled:r})}function Re(r,s=!0){return M({queryKey:["driver",r],queryFn:()=>Y.getById(r),staleTime:600*1e3,enabled:s&&r!==null})}function qe(){const r=K();return O({mutationFn:s=>Y.create(s),onSuccess:s=>{r.invalidateQueries({queryKey:["drivers"]}),r.invalidateQueries({queryKey:["driverNames"]}),r.invalidateQueries({queryKey:["driver",s.id]})}})}function ke(){const r=K();return O({mutationFn:s=>Y.update(s),onSuccess:s=>{r.invalidateQueries({queryKey:["drivers"]}),r.invalidateQueries({queryKey:["driverNames"]}),r.invalidateQueries({queryKey:["driver",s.id]})}})}function me({open:r,onOpenChange:s,onSuccess:x,initialData:l}){const[n,u]=d.useState({}),[j,c]=d.useState(null),v=d.useRef(null),_=d.useRef(!1),g=qe(),N=ke(),y=!!l,i=y?N:g,{register:f,handleSubmit:o,formState:{errors:t},reset:E,setError:m,setValue:h,watch:q}=oe({resolver:le(Te),defaultValues:{name:"",mobile_no:"",license_no:"",id_proof_type:"Aadhar",id_proof_number:""}}),V=q("photo"),I=q("id_proof_type"),a=d.useMemo(()=>({...t,...n}),[t,n]);Q(a),d.useEffect(()=>{r&&(u({}),_.current=!0,l?(E({name:l.name,mobile_no:l.mobile_no,license_no:l.license_no,id_proof_type:l.id_proof_type,id_proof_number:l.id_proof_number}),c(l.photo??null)):(E(),c(null)))},[r,l,E]),d.useEffect(()=>{if(_.current){_.current=!1;return}h("id_proof_number","",{shouldValidate:!1})},[I,h]),d.useEffect(()=>{if(V&&V instanceof File){const b=new FileReader;b.onloadend=()=>{c(b.result)},b.readAsDataURL(V)}},[V]);const k=b=>{const p=b.target.files?.[0];p&&h("photo",p,{shouldValidate:!0})},U=()=>{h("photo",void 0,{shouldValidate:!1}),c(null),v.current&&(v.current.value="")},w=async b=>{u({});try{const p=y?await N.mutateAsync({...b,id:l.id}):await g.mutateAsync(b);E(),c(null),s(!1),x?.(p)}catch(p){const P=p;if(P.errors){const T={};Object.entries(P.errors).forEach(([S,D])=>{if(Array.isArray(D)&&D.length>0){const ce=S==="mobile_no"?"mobile_no":S==="license_no"?"license_no":S==="id_proof_type"?"id_proof_type":S==="id_proof_number"?"id_proof_number":S;T[ce]=D[0],m(ce,{type:"server",message:D[0]})}}),u(T)}else u({general:P.message||(y?"Failed to update driver":"Failed to create driver")})}};return e.jsx(ee,{open:r,onOpenChange:s,children:e.jsxs(re,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(se,{children:[e.jsx(te,{children:y?"Update Driver":"Add New Driver"}),e.jsx(ne,{children:y?"Update the driver details below.":"Fill in the details to create a new driver. All fields are required."})]}),e.jsxs("form",{onSubmit:o(w),className:"space-y-4",children:[n.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:n.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"name",children:["Driver Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"name",placeholder:"Enter driver name",...f("name"),disabled:i.isPending,className:t.name||n.name?"border-destructive":""}),t.name&&e.jsx("p",{className:"text-sm text-destructive",children:t.name.message}),n.name&&!t.name&&e.jsx("p",{className:"text-sm text-destructive",children:n.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"mobile_no",children:["Mobile Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"mobile_no",placeholder:"9876543210",...f("mobile_no"),disabled:i.isPending,className:t.mobile_no||n.mobile_no?"border-destructive":""}),t.mobile_no&&e.jsx("p",{className:"text-sm text-destructive",children:t.mobile_no.message}),n.mobile_no&&!t.mobile_no&&e.jsx("p",{className:"text-sm text-destructive",children:n.mobile_no})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"license_no",children:["Driving License Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"license_no",placeholder:"e.g., MH0220150001234",...f("license_no",{onChange:b=>{b.target.value=b.target.value.toUpperCase()}}),disabled:i.isPending,className:t.license_no||n.license_no?"border-destructive":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Format: State code + RTO + Year + Number (e.g., MH0220150001234)"}),t.license_no&&e.jsx("p",{className:"text-sm text-destructive",children:t.license_no.message}),n.license_no&&!t.license_no&&e.jsx("p",{className:"text-sm text-destructive",children:n.license_no})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"id_proof_type",children:["ID Proof Type ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("select",{id:"id_proof_type",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",...f("id_proof_type"),disabled:i.isPending,children:Se.map(b=>e.jsx("option",{value:b,children:b},b))}),t.id_proof_type&&e.jsx("p",{className:"text-sm text-destructive",children:t.id_proof_type.message}),n.id_proof_type&&!t.id_proof_type&&e.jsx("p",{className:"text-sm text-destructive",children:n.id_proof_type})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"id_proof_number",children:["ID Proof Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"id_proof_number",placeholder:Z[I]?.placeholder||"Enter ID proof number",...f("id_proof_number",{onChange:b=>{I==="Aadhar"?b.target.value=b.target.value.replace(/[^0-9]/g,"").slice(0,12):(I==="PAN Card"||I==="Voter ID")&&(b.target.value=b.target.value.toUpperCase())}}),maxLength:Z[I]?.maxLength??50,disabled:i.isPending,className:t.id_proof_number||n.id_proof_number?"border-destructive":""}),I&&I!=="Other"&&e.jsx("p",{className:"text-xs text-muted-foreground",children:Z[I]?.message}),t.id_proof_number&&e.jsx("p",{className:"text-sm text-destructive",children:t.id_proof_number.message}),n.id_proof_number&&!t.id_proof_number&&e.jsx("p",{className:"text-sm text-destructive",children:n.id_proof_number})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Driver Photo"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{ref:v,type:"file",accept:"image/*",onChange:k,disabled:i.isPending,className:"hidden",id:"photo-upload"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(R,{type:"button",variant:"outline",onClick:()=>v.current?.click(),disabled:i.isPending,className:"w-full",children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),j?"Change Photo":"Upload Photo"]}),j&&e.jsx(R,{type:"button",variant:"outline",size:"icon",onClick:U,disabled:i.isPending,children:e.jsx(ye,{className:"h-4 w-4"})})]}),j&&e.jsxs("div",{className:"relative w-full h-48 border rounded-md overflow-hidden bg-muted",children:[e.jsx("img",{src:j,alt:"Driver photo preview",className:"w-full h-full object-cover",onError:b=>{b.currentTarget.style.display="none";const p=b.currentTarget.nextElementSibling;p&&(p.style.display="flex")}}),e.jsx("div",{className:"absolute inset-0 items-center justify-center text-muted-foreground",style:{display:"none"},children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Failed to load image"})]})})]})]})]}),e.jsxs(ae,{children:[e.jsx(R,{type:"button",variant:"outline",onClick:()=>s(!1),disabled:i.isPending,children:"Cancel"}),e.jsx(R,{type:"submit",disabled:i.isPending,children:i.isPending?y?"Updating...":"Creating...":y?"Update Driver":"Create Driver"})]})]})]})})}function Me({value:r,onChange:s,placeholder:x="Select driver",disabled:l=!1,error:n,label:u,required:j=!1}){const[c,v]=d.useState(!1),[_,g]=d.useState(null),{data:N=[],isLoading:y}=Ae(c&&!l),{data:i}=Re(_,_!==null),f=d.useRef(i),o=d.useRef(s);return d.useEffect(()=>{o.current=s},[s]),d.useEffect(()=>{i&&i!==f.current&&(f.current=i,o.current({driverId:i.id,driverName:i.name,mobileNumber:i.mobile_no,drivingLicenseNumber:i.license_no,idProofType:i.id_proof_type,idProofNumber:i.id_proof_number,driverPhoto:i.photo}))},[i]),e.jsx($,{value:r,items:N,isLoading:y,placeholder:x,disabled:l,error:n,label:u,required:j,inputId:"driver-select",getItemKey:t=>t.id,getItemLabel:t=>t.name,loadingText:"Loading drivers...",emptyText:"No drivers available",notFoundText:"No drivers found",addNewLabel:"Add New Driver",onOpenChange:v,onSelectedKeyChange:t=>{g(t),t||(f.current=void 0)},onItemSelect:t=>{g(t.id)},onClear:()=>{g(null),f.current=void 0,s({driverId:0,driverName:"",mobileNumber:"",drivingLicenseNumber:"",idProofType:"",idProofNumber:"",driverPhoto:null})},renderPopoverContent:t=>i?e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:i.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:i.mobile_no})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"License Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:i.license_no})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:i.id_proof_type})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:i.id_proof_number})]})]})}):t?e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),"Loading driver details..."]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a driver to view details."}),renderCreateDialog:(t,E,m)=>e.jsx(me,{open:t,onOpenChange:E,onSuccess:h=>{m(h.id,h.name),g(h.id)}})})}const z={async getNames(){return(await L.get(F.VEHICLE.TRANSPORTER_NAMES)).data},async getById(r){return(await L.get(F.VEHICLE.TRANSPORTER_BY_ID(r))).data},async getList(){return(await L.get(F.VEHICLE.TRANSPORTERS)).data},async create(r){const s=new URLSearchParams;return s.append("name",r.name),s.append("contact_person",r.contact_person),s.append("mobile_no",r.mobile_no),(await L.post(F.VEHICLE.TRANSPORTERS,s.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}};function Ke(r=!0){return M({queryKey:["transporterNames"],queryFn:()=>z.getNames(),staleTime:600*1e3,enabled:r})}function Ue(r,s=!0){return M({queryKey:["transporter",r],queryFn:()=>z.getById(r),staleTime:600*1e3,enabled:s&&r!==null})}function Oe(r=!0){return M({queryKey:["transporters"],queryFn:()=>z.getList(),staleTime:600*1e3,enabled:r})}function He(){const r=K();return O({mutationFn:s=>z.create(s),onSuccess:()=>{r.invalidateQueries({queryKey:["transporters"]}),r.invalidateQueries({queryKey:["transporterNames"]})}})}function Be({open:r,onOpenChange:s,onSuccess:x}){const[l,n]=d.useState({}),u=He(),{register:j,handleSubmit:c,formState:{errors:v},reset:_,setError:g}=oe({resolver:le(we),defaultValues:{name:"",contact_person:"",mobile_no:""}}),N=d.useMemo(()=>({...v,...l}),[v,l]);Q(N),d.useEffect(()=>{r&&(_(),n({}))},[r,_]);const y=async i=>{n({});try{const f=await u.mutateAsync(i);_(),s(!1),x&&x(f.name)}catch(f){const o=f;if(o.errors){const t={};Object.entries(o.errors).forEach(([E,m])=>{Array.isArray(m)&&m.length>0&&(t[E]=m[0],g(E,{type:"server",message:m[0]}))}),n(t)}else n({general:o.message||"Failed to create transporter"})}};return e.jsx(ee,{open:r,onOpenChange:s,children:e.jsxs(re,{className:"sm:max-w-[500px]",children:[e.jsxs(se,{children:[e.jsx(te,{children:"Add New Transporter"}),e.jsx(ne,{children:"Fill in the details to create a new transporter. All fields are required."})]}),e.jsxs("form",{onSubmit:c(y),className:"space-y-4",children:[l.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:l.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"name",children:["Transporter Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"name",placeholder:"Enter transporter name",...j("name"),disabled:u.isPending,className:v.name||l.name?"border-destructive":""}),v.name&&e.jsx("p",{className:"text-sm text-destructive",children:v.name.message}),l.name&&!v.name&&e.jsx("p",{className:"text-sm text-destructive",children:l.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"contact_person",children:["Contact Person ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"contact_person",placeholder:"Enter contact person name",...j("contact_person"),disabled:u.isPending,className:v.contact_person||l.contact_person?"border-destructive":""}),v.contact_person&&e.jsx("p",{className:"text-sm text-destructive",children:v.contact_person.message}),l.contact_person&&!v.contact_person&&e.jsx("p",{className:"text-sm text-destructive",children:l.contact_person})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"mobile_no",children:["Mobile Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"mobile_no",placeholder:"Enter mobile number",...j("mobile_no"),disabled:u.isPending,className:v.mobile_no||l.mobile_no?"border-destructive":""}),v.mobile_no&&e.jsx("p",{className:"text-sm text-destructive",children:v.mobile_no.message}),l.mobile_no&&!v.mobile_no&&e.jsx("p",{className:"text-sm text-destructive",children:l.mobile_no})]}),e.jsxs(ae,{children:[e.jsx(R,{type:"button",variant:"outline",onClick:()=>s(!1),disabled:u.isPending,children:"Cancel"}),e.jsx(R,{type:"submit",disabled:u.isPending,children:u.isPending?"Creating...":"Create Transporter"})]})]})]})})}function pe({value:r,onChange:s,placeholder:x="Select transporter",disabled:l=!1,error:n,label:u,required:j=!1,externalDetails:c}){const[v,_]=d.useState(!1),[g,N]=d.useState(null),{data:y=[],isLoading:i}=Ke(v&&!l),{data:f}=Ue(g,g!==null),o=c||f;return e.jsx($,{value:r,items:y,isLoading:i,placeholder:x,disabled:l,error:n,label:u,required:j,inputId:"transporter-select",getItemKey:t=>t.id,getItemLabel:t=>t.name,loadingText:"Loading transporters...",emptyText:"No transporters available",notFoundText:"No transporters found",addNewLabel:"Add New Transporter",onOpenChange:_,onSelectedKeyChange:t=>{N(t)},onItemSelect:t=>{N(t.id),s(t.name)},onClear:()=>{N(null),s("")},renderPopoverContent:t=>o?e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:o.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Contact Person:"})," ",e.jsx("span",{className:"text-muted-foreground",children:o.contact_person})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:o.mobile_no})]})]})}):t?e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),"Loading transporter details..."]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a transporter to view details."}),renderCreateDialog:(t,E,m)=>e.jsx(Be,{open:t,onOpenChange:E,onSuccess:h=>{m(0,h),s(h)}})})}const H={async getVehicleTypes(){return(await L.get(F.VEHICLE.VEHICLE_TYPES)).data},async getNames(){return(await L.get(F.VEHICLE.VEHICLE_NAMES)).data},async getById(r){return(await L.get(F.VEHICLE.VEHICLE_BY_ID(r))).data},async getList(){return(await L.get(F.VEHICLE.VEHICLES)).data},async create(r){const s=new URLSearchParams;return s.append("vehicle_number",r.vehicle_number),s.append("vehicle_type",r.vehicle_type.toString()),s.append("transporter",r.transporter.toString()),s.append("capacity_ton",r.capacity_ton),(await L.post(F.VEHICLE.VEHICLES,s.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data},async update(r){const s=new URLSearchParams;return s.append("vehicle_number",r.vehicle_number),s.append("vehicle_type",r.vehicle_type.toString()),s.append("transporter",r.transporter.toString()),s.append("capacity_ton",r.capacity_ton),(await L.put(F.VEHICLE.VEHICLE_BY_ID(r.id),s.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}};function Qe(r=!0){return M({queryKey:["vehicleTypes"],queryFn:()=>H.getVehicleTypes(),staleTime:600*1e3,enabled:r})}function $e(r=!0){return M({queryKey:["vehicleNames"],queryFn:()=>H.getNames(),staleTime:600*1e3,enabled:r})}function he(r,s=!0){return M({queryKey:["vehicle",r],queryFn:()=>H.getById(r),staleTime:600*1e3,enabled:s&&r!==null})}function Ye(){const r=K();return O({mutationFn:s=>H.create(s),onSuccess:()=>{r.invalidateQueries({queryKey:["vehicles"]}),r.invalidateQueries({queryKey:["vehicleNames"]})}})}function ze(){const r=K();return O({mutationFn:s=>H.update(s),onSuccess:s=>{r.invalidateQueries({queryKey:["vehicles"]}),r.invalidateQueries({queryKey:["vehicleNames"]}),r.invalidateQueries({queryKey:["vehicle",s.id]})}})}function Ge({value:r,onChange:s,placeholder:x="Select vehicle type",disabled:l=!1,error:n,label:u,required:j=!1}){const[c,v]=d.useState(!1),{data:_=[],isLoading:g,isError:N}=Qe(c);return e.jsx($,{value:r||void 0,items:_,isLoading:g,isError:N,placeholder:x,disabled:l,error:n,label:u,required:j,inputId:"vehicle-type-select",inputClassName:"border-2 font-medium",getItemKey:y=>y.id,getItemLabel:y=>y.name,loadingText:"Loading vehicle types...",emptyText:"No vehicle types available",notFoundText:"No vehicle types found",onOpenChange:v,onItemSelect:y=>{s(y.id,y.name)},onClear:()=>{s(0,"")}})}function ve({open:r,onOpenChange:s,onSuccess:x,initialData:l}){const[n,u]=d.useState({}),[j,c]=d.useState(null),v=Ye(),_=ze(),{data:g=[]}=Oe(r),[N,y]=d.useState(""),i=!!l,f=i?_:v,{data:o}=he(r&&i?l.id:null,r&&i),{register:t,handleSubmit:E,formState:{errors:m},reset:h,setError:q,setValue:V}=oe({resolver:le(Ve),defaultValues:{vehicle_number:"",vehicle_type:0,transporter:0,capacity_ton:""}}),[I,a]=d.useState(""),k=d.useMemo(()=>({...m,...n}),[m,n]);Q(k),d.useEffect(()=>{r&&(u({}),i||(h(),c(null),a(""),y("")))},[r,h,i]),d.useEffect(()=>{!r||!i||!o||(h({vehicle_number:o.vehicle_number,vehicle_type:o.vehicle_type?.id??0,transporter:o.transporter?.id??0,capacity_ton:o.capacity_ton??""}),y(o.vehicle_type?.id?String(o.vehicle_type.id):""),a(o.transporter?.name??""),c(o.transporter?.id??null))},[r,i,o,h]),d.useEffect(()=>{if(I&&g.length>0){const w=g.find(b=>b.name===I);w?(c(w.id),V("transporter",w.id)):(c(null),V("transporter",0))}else c(null),V("transporter",0)},[I,g,V]);const U=async w=>{if(!j){u({transporter:"Please select a transporter"});return}u({});try{const b=i?await _.mutateAsync({id:l.id,...w,transporter:j}):await v.mutateAsync({...w,transporter:j});h(),s(!1),x?.(b)}catch(b){const p=b;if(p.errors){const P={};Object.entries(p.errors).forEach(([T,S])=>{if(Array.isArray(S)&&S.length>0){const D=T==="vehicle_number"?"vehicle_number":T==="vehicle_type"?"vehicle_type":T==="capacity_ton"?"capacity_ton":T;P[D]=S[0],q(D,{type:"server",message:S[0]})}}),u(P)}else u({general:p.message||(i?"Failed to update vehicle":"Failed to create vehicle")})}};return e.jsx(ee,{open:r,onOpenChange:s,children:e.jsxs(re,{className:"sm:max-w-[500px]",children:[e.jsxs(se,{children:[e.jsx(te,{children:i?"Update Vehicle":"Add New Vehicle"}),e.jsx(ne,{children:i?"Update the vehicle details below.":"Fill in the details to create a new vehicle. All fields are required."})]}),e.jsxs("form",{onSubmit:E(U),className:"space-y-4",children:[n.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:n.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"vehicle_number",children:["Vehicle Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"vehicle_number",placeholder:"HR55AB1234",...t("vehicle_number",{onChange:w=>{w.target.value=w.target.value.toUpperCase().replace(/\s/g,"")}}),disabled:i||f.isPending,className:m.vehicle_number||n.vehicle_number?"border-destructive":""}),!i&&m.vehicle_number&&e.jsx("p",{className:"text-sm text-destructive",children:m.vehicle_number.message}),!i&&n.vehicle_number&&!m.vehicle_number&&e.jsx("p",{className:"text-sm text-destructive",children:n.vehicle_number})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Ge,{value:N||void 0,onChange:(w,b)=>{V("vehicle_type",w),y(String(w))},disabled:f.isPending,label:"Vehicle Type",required:!0,error:m.vehicle_type?.message||n.vehicle_type})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(pe,{value:I,onChange:w=>a(w),placeholder:"Select transporter",label:"Transporter",required:!0}),n.transporter&&e.jsx("p",{className:"text-sm text-destructive",children:n.transporter})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"capacity_ton",children:["Vehicle Capacity (Tons) ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"capacity_ton",type:"text",placeholder:"e.g., 18",...t("capacity_ton"),disabled:f.isPending,className:m.capacity_ton||n.capacity_ton?"border-destructive":""}),m.capacity_ton&&e.jsx("p",{className:"text-sm text-destructive",children:m.capacity_ton.message}),n.capacity_ton&&!m.capacity_ton&&e.jsx("p",{className:"text-sm text-destructive",children:n.capacity_ton})]}),e.jsxs(ae,{children:[e.jsx(R,{type:"button",variant:"outline",onClick:()=>s(!1),disabled:f.isPending,children:"Cancel"}),e.jsx(R,{type:"submit",disabled:f.isPending,children:f.isPending?i?"Updating...":"Creating...":i?"Update Vehicle":"Create Vehicle"})]})]})]})})}function We({value:r,onChange:s,placeholder:x="Select vehicle",disabled:l=!1,error:n,label:u,required:j=!1}){const[c,v]=d.useState(!1),[_,g]=d.useState(null),[N,y]=d.useState(null),{data:i=[],isLoading:f}=$e(c&&!l),{data:o}=he(_,_!==null),t=d.useRef(o),E=d.useRef(s);d.useEffect(()=>{E.current=s},[s]);const m=d.useCallback(()=>{if(o&&o!==t.current){t.current=o,y(o);const h=o.vehicle_type.name;E.current({vehicleId:o.id,vehicleNumber:o.vehicle_number,vehicleType:h,vehicleCapacity:`${o.capacity_ton} Tons`,transporterName:o.transporter?.name||"",transporterContactPerson:o.transporter?.contact_person||"",transporterMobile:o.transporter?.mobile_no||""})}},[o]);return d.useEffect(()=>{m()},[m]),e.jsx($,{value:r,items:i,isLoading:f,placeholder:x,disabled:l,error:n,label:u,required:j,inputId:"vehicle-select",getItemKey:h=>h.id,getItemLabel:h=>h.vehicle_number,loadingText:"Loading vehicles...",emptyText:"No vehicles available",notFoundText:"No vehicles found",addNewLabel:"Add New Vehicle",onOpenChange:v,onSelectedKeyChange:h=>{g(h),h||y(null)},onItemSelect:h=>{g(h.id)},onClear:()=>{g(null),y(null),s({vehicleId:0,vehicleNumber:"",vehicleType:"",vehicleCapacity:"",transporterName:"",transporterContactPerson:"",transporterMobile:""})},renderPopoverContent:h=>N?e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:N.vehicle_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Vehicle Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:N.vehicle_type.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Capacity:"})," ",e.jsxs("span",{className:"text-muted-foreground",children:[N.capacity_ton," Tons"]})]}),N.transporter&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Transporter:"})," ",e.jsx("span",{className:"text-muted-foreground",children:N.transporter.name})]})]})}):h?e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),"Loading vehicle details..."]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a vehicle to view details."}),renderCreateDialog:(h,q,V)=>e.jsx(ve,{open:h,onOpenChange:q,onSuccess:I=>{V(I.id,I.vehicle_number),g(I.id)}})})}const Je=()=>{try{return new URL(ue.apiBaseUrl).origin}catch{return ue.apiBaseUrl.replace(/\/api\/v1\/?$/,"")}};function Xe({formData:r,onFormChange:s,isReadOnly:x,isLoading:l,isSaving:n,apiErrors:u,currentStep:j,totalSteps:c,onVehicleSelect:v,onDriverSelect:_,onCancel:g,onNext:N,onUpdate:y,isEditMode:i,canUpdate:f,updateMode:o,serverError:t,headerTitle:E="Material Inward"}){const m=j/c*100,[h,q]=d.useState(!1),[V,I]=d.useState(!1);return Q(u),l?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h2",{className:"text-3xl font-bold tracking-tight",children:[E," - Step ",j," of ",c]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${m}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground min-w-[3rem]",children:[Math.round(m),"%"]})]})]}),(t||u.general)&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"}),t||u.general]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(G,{children:[e.jsx(W,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Vehicle Details"]})}),e.jsx(X,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(C,{htmlFor:"vehicle-select",children:["Vehicle Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),r.vehicleId!=0&&!x&&e.jsx(R,{type:"button",variant:"link",size:"sm",className:"px-0 h-auto",onClick:()=>I(!0),children:"Edit Vehicle"})]}),e.jsx(We,{value:r.vehicleNumber,onChange:a=>{x||v({vehicleId:a.vehicleId,vehicleNumber:a.vehicleNumber,vehicleType:a.vehicleType,vehicleCapacity:a.vehicleCapacity,transporterName:a.transporterName,transporterContactPerson:a.transporterContactPerson,transporterMobile:a.transporterMobile})},placeholder:"Enter vehicle number",required:!0,error:u.vehicle,disabled:x})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(pe,{value:r.transporterName,onChange:()=>{},placeholder:"Auto-filled from vehicle",label:"Transporter Name",required:!0,disabled:!0,externalDetails:r.transporterName?{name:r.transporterName,contact_person:r.transporterContactPerson,mobile_no:r.transporterMobile}:null})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"vehicleType",children:["Vehicle Type ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"vehicleType",value:r.vehicleType,disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"vehicleCapacity",children:"Vehicle Capacity"}),e.jsx(A,{id:"vehicleCapacity",placeholder:"e.g., 10 Tons / 50 CBM",value:r.vehicleCapacity,onChange:a=>s("vehicleCapacity",a.target.value),disabled:!0})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(C,{htmlFor:"gpsId",children:"GPS ID (if available)"}),e.jsx(A,{id:"gpsId",placeholder:"GPS tracking ID",value:r.gpsId,onChange:a=>s("gpsId",a.target.value),disabled:x||n,className:de(x&&"cursor-not-allowed opacity-50")})]})]})})]}),e.jsxs(G,{children:[e.jsx(W,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Driver Information"]})}),e.jsx(X,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(C,{htmlFor:"driver-select",children:["Driver Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),r.driverId!=0&&!x&&e.jsx(R,{type:"button",variant:"link",size:"sm",className:"px-0 h-auto",onClick:()=>q(!0),children:"Edit Driver"})]}),e.jsx(Me,{value:r.driverName,onChange:a=>{x||_({driverId:a.driverId,driverName:a.driverName,mobileNumber:a.mobileNumber,drivingLicenseNumber:a.drivingLicenseNumber,idProofType:a.idProofType,idProofNumber:a.idProofNumber,driverPhoto:a.driverPhoto})},placeholder:"Enter driver name or license number",required:!0,error:u.driver,disabled:x||n})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"mobileNumber",children:["Mobile Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"mobileNumber",placeholder:"+91 9876543210",value:r.mobileNumber,onChange:a=>s("mobileNumber",a.target.value),disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"drivingLicenseNumber",children:["Driving License Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"drivingLicenseNumber",placeholder:"DL number",value:r.drivingLicenseNumber,onChange:a=>s("drivingLicenseNumber",a.target.value),disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"idProofType",children:["ID Proof Type ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{id:"idProofType",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:r.idProofType,onChange:a=>s("idProofType",a.target.value),disabled:!0,children:[e.jsx("option",{value:"",children:"Select ID proof type"}),Le.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(C,{htmlFor:"idProofNumber",children:["ID Proof Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(A,{id:"idProofNumber",placeholder:"ID number",value:r.idProofNumber,onChange:a=>s("idProofNumber",a.target.value),disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Driver Photo"}),r.driverPhoto?e.jsxs("div",{className:"relative w-full h-48 border rounded-md overflow-hidden bg-muted",children:[e.jsx("img",{src:r.driverPhoto.startsWith("http")?r.driverPhoto:`${Je()}${r.driverPhoto}`,alt:"Driver photo",className:"w-full h-full object-cover",onError:a=>{a.currentTarget.style.display="none";const k=a.currentTarget.nextElementSibling;k&&(k.style.display="flex")}}),e.jsx("div",{className:"absolute inset-0 items-center justify-center text-muted-foreground",style:{display:"none"},children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Photo not available"})]})})]}):e.jsx("div",{className:"w-full h-48 border rounded-md flex items-center justify-center bg-muted text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No photo available"})]})})]})]})})]}),e.jsxs(G,{children:[e.jsx(W,{children:e.jsx(J,{children:"Remarks"})}),e.jsx(X,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"remarks",children:"Additional Remarks (Optional)"}),e.jsx("textarea",{id:"remarks",rows:3,className:de("flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",u.entry_no&&"border-destructive",x&&"cursor-not-allowed opacity-50"),placeholder:"Enter any additional remarks or notes...",value:r.remarks,onChange:a=>s("remarks",a.target.value),disabled:x||n}),u.remarks&&e.jsx("p",{className:"text-sm text-destructive",children:u.remarks}),u.entry_no&&e.jsx("p",{className:"text-sm text-destructive",children:u.entry_no})]})})]})]}),e.jsx(me,{open:h,onOpenChange:q,initialData:{id:r.driverId,name:r.driverName,mobile_no:r.mobileNumber,license_no:r.drivingLicenseNumber,id_proof_type:r.idProofType,id_proof_number:r.idProofNumber,photo:r.driverPhoto},onSuccess:a=>{_({driverId:a.id,driverName:a.name,mobileNumber:a.mobile_no,drivingLicenseNumber:a.license_no,idProofType:a.id_proof_type,idProofNumber:a.id_proof_number,driverPhoto:a.photo})}}),e.jsx(ve,{open:V,onOpenChange:I,initialData:{id:r.vehicleId},onSuccess:a=>{v({vehicleId:a.id,vehicleNumber:a.vehicle_number,vehicleType:a.vehicle_type?.name??"",vehicleCapacity:a.capacity_ton?`${a.capacity_ton} Tons`:"",transporterName:a.transporter?.name??"",transporterContactPerson:a.transporter?.contact_person??"",transporterMobile:a.transporter?.mobile_no??""})}}),e.jsxs("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:justify-end",children:[e.jsx(R,{type:"button",variant:"outline",onClick:g,children:"Cancel"}),i?e.jsxs(e.Fragment,{children:[f&&!o&&y&&e.jsx(R,{type:"button",onClick:y,children:"Update"}),e.jsx(R,{type:"button",onClick:N,disabled:n,children:o?n?"Saving...":"Save and Next →":"Next →"})]}):e.jsx(R,{type:"button",onClick:N,disabled:n,children:n?"Saving...":"Save and Next →"})]})]})}function dr({config:r}){const s=Ne(),x=K(),{entryId:l}=ge(),n=!!l,u=Pe(),j=Ce(),{data:c,isLoading:v,error:_}=Ee(l?parseInt(l):null),g=_e(_),[N,y]=d.useState(!1),[i,f]=d.useState(!1),[o,t]=d.useState({vehicleId:0,vehicleNumber:"",vehicleType:"",transporterName:"",transporterContactPerson:"",transporterMobile:"",vehicleCapacity:"",gpsId:"",driverId:0,driverName:"",mobileNumber:"",drivingLicenseNumber:"",idProofType:"",idProofNumber:"",driverPhoto:null,remarks:""}),[E,m]=d.useState({});d.useEffect(()=>{n&&c&&t({vehicleId:c.vehicle?.id||0,vehicleNumber:c.vehicle?.vehicle_number||"",vehicleType:c.vehicle?.vehicle_type?.name||"",transporterName:c.vehicle?.transporter?.name||"",transporterContactPerson:c.vehicle?.transporter?.contact_person||"",transporterMobile:c.vehicle?.transporter?.mobile_no||"",vehicleCapacity:c.vehicle?.capacity_ton?`${c.vehicle.capacity_ton} Tons`:"",gpsId:"",driverId:c.driver?.id||0,driverName:c.driver?.name||"",mobileNumber:c.driver?.mobile_no||"",drivingLicenseNumber:c.driver?.license_no||"",idProofType:c.driver?.id_proof_type||"",idProofNumber:c.driver?.id_proof_number||"",driverPhoto:c.driver?.photo||null,remarks:c.remarks||""})},[n,c]);const h=(p,P)=>{n&&!N||(t(T=>({...T,[p]:P})),E[p]&&m(T=>{const S={...T};return delete S[p],S}))},q=p=>{t(P=>({...P,vehicleId:p.vehicleId,vehicleNumber:p.vehicleNumber,vehicleType:p.vehicleType,vehicleCapacity:p.vehicleCapacity,transporterName:p.transporterName,transporterContactPerson:p.transporterContactPerson,transporterMobile:p.transporterMobile}))},V=p=>{t(P=>({...P,driverId:p.driverId,driverName:p.driverName,mobileNumber:p.mobileNumber,drivingLicenseNumber:p.drivingLicenseNumber,idProofType:p.idProofType,idProofNumber:p.idProofNumber,driverPhoto:p.driverPhoto}))},I=()=>{x.invalidateQueries({queryKey:["vehicleEntries"]}),s(r.routePrefix)},a=async()=>{if(n&&!N&&l){s(`${r.routePrefix}/edit/${l}/step2`);return}if(m({}),!o.vehicleId){m({vehicle:"Please select a vehicle"});return}if(!o.driverId){m({driver:"Please select a driver"});return}k()},k=async()=>{try{const p=new Date().getFullYear(),P=Date.now().toString().slice(-4),T=`GE-${p}-${P}`,S=await u.mutateAsync({entry_no:T,vehicle:o.vehicleId,driver:o.driverId,remarks:o.remarks||void 0,entry_type:r.entryType});f(!0),s(`${r.routePrefix}/edit/${S.id}/step2`)}catch(p){const P=p;if(P.errors){const T={};Object.entries(P.errors).forEach(([S,D])=>{Array.isArray(D)&&D.length>0&&(T[S]=D[0])}),m(T)}else m({general:P.message||"Failed to create vehicle entry"})}},U=async()=>{if(l){if(m({}),!o.vehicleId){m({vehicle:"Please select a vehicle"});return}if(!o.driverId){m({driver:"Please select a driver"});return}try{await j.mutateAsync({id:parseInt(l),data:{vehicle:o.vehicleId,driver:o.driverId,remarks:o.remarks||void 0}}),f(!0),s(`${r.routePrefix}/edit/${l}/step2`)}catch(p){const P=p;if(P.errors){const T={};Object.entries(P.errors).forEach(([S,D])=>{Array.isArray(D)&&D.length>0&&(T[S]=D[0])}),m(T)}else m({general:P.message||"Failed to update vehicle entry"})}}},w=n&&c?.status===je.DRAFT,b=n;return e.jsx(Xe,{formData:o,onFormChange:h,isReadOnly:b,isLoading:n&&v,isSaving:u.isPending||j.isPending||i,apiErrors:E,currentStep:1,totalSteps:r.totalSteps,onVehicleSelect:q,onDriverSelect:V,onCancel:I,onNext:a,onUpdate:U,isEditMode:n,canUpdate:w,updateMode:N,serverError:g?Ie():null,headerTitle:r.headerTitle})}export{dr as S};
