import{H as G,J,r as m,j as e,a as me,K as pe,B as q,C as xe,b as he,c as _e,e as fe,L as z,I as B,M as k,N as ve,O as Ne,k as ge}from"./index-C2mIzQGa.js";import{i as ye,a as je,g as be,b as Z}from"./error-qMYEww3Q.js";import{S as Ce,u as we}from"./SearchableSelect-DWy99MGV.js";import{u as Pe}from"./useScrollToError-BArmGyd9.js";import{u as Y}from"./useMutation-BgZEu4WU.js";import{u as Oe,a as $e}from"./poReceipt.queries-C_9ZB7n3.js";import{F as Se}from"./FillDataAlert-BbPMz1kd.js";import{S as qe}from"./StepHeader-CitUYnnt.js";import{S as Ee}from"./StepLoadingSpinner-nOJq6MmQ.js";import"./driver.schema-DZt_XaHY.js";import"./vehicle.schema-BmxwMEOL.js";import{W as Re}from"./wizard.constants-DfnuBX7K.js";import{u as De}from"./useEntryId-B2S9w5kc.js";import{P as Le}from"./plus-BiPwkm4Y.js";import{A as Me}from"./arrow-left-B83fu_yA.js";import{P as Ae}from"./package-nT2w0Nlt.js";import{T as Qe}from"./trash-2-DkcXUPfg.js";import{C as X}from"./circle-alert-CaWuRL_0.js";import"./validation.constants-C18ePHzl.js";import"./schemas-D8ebsZBL.js";const F={async getOpenPOs(i){return(await G.get(J.PO.OPEN_POS(i))).data},async getVendors(){return(await G.get(J.PO.VENDORS)).data}};function ke(i,g=!0){return Y({queryKey:["openPOs",i],queryFn:()=>F.getOpenPOs(i),enabled:g&&!!i})}function Te(i=!0){return Y({queryKey:["vendors"],queryFn:()=>F.getVendors(),enabled:i,staleTime:300*1e3})}function Ve({value:i,onChange:g,placeholder:h="Search vendor by name or code",disabled:P=!1,error:C,label:E,required:w=!1}){const[j,b]=m.useState(!1),{data:O=[],isLoading:y}=Te(j);return e.jsx(Ce,{value:i,items:O,isLoading:y,placeholder:h,disabled:P,error:C,label:E,required:w,inputId:"vendor-select",getItemKey:d=>d.vendor_code,getItemLabel:d=>`${d.vendor_name} (${d.vendor_code})`,filterFn:(d,v)=>d.vendor_name.toLowerCase().includes(v.toLowerCase())||d.vendor_code.toLowerCase().includes(v.toLowerCase()),renderItem:d=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:d.vendor_name}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",d.vendor_code,")"]})]}),loadingText:"Loading vendors...",emptyText:"No vendors available",notFoundText:"No vendors found",onOpenChange:b,onItemSelect:d=>{g(d)},onClear:()=>{g(null)}})}function dt(){const i=me(),g=pe(),{entryId:h,entryIdNumber:P,isEditMode:C}=De(),E=Re.STEPS.PO_RECEIPT,w=m.useId(),j=m.useRef(1),{data:b=[],isLoading:O,error:y}=Oe(C&&P?P:null),[d,v]=m.useState(!1),[p,T]=m.useState(!1),[M,V]=m.useState(!1),c=C&&!d,[N,_]=m.useState([{id:"po-initial-1",supplierName:"",supplierCode:"",poNumber:"",items:[]}]),[R,D]=m.useState(null),[L,$]=m.useState({}),[f,o]=m.useState({});Pe(f);const[n,x]=m.useState({}),A=(t,s)=>{c&&!p||(_(l=>l.map(r=>r.id===t?{...r,supplierName:s}:r)),f[`${t}_supplierName`]&&o(l=>{const r={...l};return delete r[`${t}_supplierName`],r}))},ee=(t,s)=>{c&&!n[t]&&!p||(_(l=>l.map(r=>r.id===t?{...r,supplierCode:s}:r)),f[`${t}_supplierCode`]&&o(l=>{const r={...l};return delete r[`${t}_supplierCode`],r}))},te=(t,s)=>{if(c&&!n[t]&&!p)return;_(r=>r.map(a=>a.id===t?{...a,supplierCode:s?.vendor_code||"",supplierName:s?.vendor_name||"",poNumber:"",items:[]}:a));const l=[`${t}_supplierCode`,`${t}_supplierName`,`${t}_poNumber`];o(r=>{const a={...r};return l.forEach(u=>delete a[u]),a})},se=t=>{if(c&&!n[t]&&!p)return;N.find(l=>l.id===t)?.supplierCode&&D(t)},re=(t,s)=>{c&&!n[t]&&!p||(_(l=>l.map(r=>r.id===t?{...r,poNumber:s.po_number,supplierName:s.supplier_name,supplierCode:s.supplier_code,items:s.items.map(a=>{const u=parseFloat(a.ordered_qty),S=parseFloat(a.received_qty||"0"),Q=parseFloat(a.remaining_qty);return{po_item_code:a.po_item_code,item_name:a.item_name,ordered_qty:u,received_qty:S,received_qty_now:0,remaining_qty_initial:Q,remaining_qty:Q,uom:a.uom}})}:r)),D(null),$(l=>({...l,[t]:""})))},ne=(t,s,l)=>{if(c&&!n[t]&&!p)return;const r=parseFloat(l)||0;_(a=>a.map(u=>u.id===t?{...u,items:u.items.map(S=>{if(S.po_item_code===s){const Q=Math.max(0,S.remaining_qty_initial-r);return{...S,received_qty_now:r,remaining_qty:Q}}return S})}:u)),r>0?o(a=>{const u={...a};return delete u[`${t}_item_${s}`],delete u[`${t}_received`],u}):f[`${t}_item_${s}`]&&o(a=>{const u={...a};return delete u[`${t}_item_${s}`],u})},ie=()=>{const t=Object.values(n).some(l=>l===!0);if(c&&!d&&!t)return;j.current+=1;const s=`${w}-po-${j.current}`;_(l=>[...l,{id:s,supplierName:"",supplierCode:"",poNumber:"",items:[]}]),o({})},ae=t=>{const s=Object.values(n).some(r=>r===!0),l=n[t]||!1;c&&!d&&!s&&!l&&!p||N.length!==1&&(_(r=>r.filter(a=>a.id!==t)),n[t]&&x(r=>{const a={...r};return delete a[t],a}),$(r=>{const a={...r};return delete a[t],a}))},le=()=>{v(!0),j.current+=1,_([{id:`${w}-po-${j.current}`,supplierName:"",supplierCode:"",poNumber:"",items:[]}]),o({})},de=t=>{x(s=>({...s,[t]:!0})),_(s=>s.map(l=>l.id===t?{...l,supplierName:"",supplierCode:"",poNumber:"",items:[]}:l)),o({})};m.useEffect(()=>{if(c&&b.length>0){const t=b.map((s,l)=>({id:`po-${s.po_number}-${l}`,supplierName:s.supplier_name,supplierCode:s.supplier_code,poNumber:s.po_number,items:s.items.map(r=>{const a=r.ordered_qty,u=r.received_qty;return{po_item_code:r.po_item_code,item_name:r.item_name,ordered_qty:a,received_qty:0,received_qty_now:u,remaining_qty_initial:a,remaining_qty:a-u,uom:r.uom}})}));_(t)}},[c,b]);const ce=()=>{i(C&&h?`/gate/raw-materials/edit/${h}/step2`:`/gate/raw-materials/new/step2?entryId=${h}`)},K=$e(P||0),oe=async()=>{if(!h){o({general:"Entry ID is missing. Please go back to step 1."});return}if(c&&!p){i(`/gate/raw-materials/edit/${h}/step4`);return}for(const t of N){if(!t.supplierName.trim()){o({[`${t.id}_supplierName`]:"Please enter supplier name"});return}if(!t.supplierCode.trim()){o({[`${t.id}_supplierCode`]:"Please enter supplier code"});return}if(!t.poNumber){o({[`${t.id}_poNumber`]:"Please select a PO"});return}if(t.items.length===0){o({[`${t.id}_items`]:"Please select a PO to load items"});return}if(!t.items.some(r=>r.received_qty_now>0)){const r={[`${t.id}_received`]:"Please enter received quantities for at least one item"};t.items.forEach(a=>{(!a.received_qty_now||a.received_qty_now<=0)&&(r[`${t.id}_item_${a.po_item_code}`]="Please enter received quantity")}),o(r);return}const l=t.items.filter(r=>r.received_qty_now>r.remaining_qty_initial);if(l.length>0){const r={};l.forEach(a=>{r[`${t.id}_item_${a.po_item_code}`]=`Cannot exceed remaining quantity (${a.remaining_qty_initial} ${a.uom})`}),o(r);return}}o({});try{for(const t of N)await K.mutateAsync({po_number:t.poNumber,supplier_code:t.supplierCode,supplier_name:t.supplierName,items:t.items.filter(s=>s.received_qty_now>0).map(s=>({po_item_code:s.po_item_code,item_name:s.item_name,ordered_qty:s.ordered_qty,received_qty:s.received_qty_now,uom:s.uom}))});V(!0),i(C?`/gate/raw-materials/edit/${h}/step4`:`/gate/raw-materials/new/step4?entryId=${h}`)}catch(t){const s=t;if(s.errors){const l={};Object.entries(s.errors).forEach(([r,a])=>{Array.isArray(a)&&a.length>0&&(l[r]=a[0])}),o(l)}else o({general:s.message||"Failed to save PO receipts"})}},I=ye(y),H=je(y),U=b.length>0,W=c&&!O&&(!U||I),ue=c&&U&&!p&&!d||c&&W&&!d;return c&&O?e.jsx(Ee,{}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsx(qe,{currentStep:E,error:H?be():f.general||(y&&!I?Z(y,"Failed to load PO receipts"):null)}),W&&!d&&!H&&e.jsx(Se,{message:I?Z(y,"PO receipts not found"):"No PO receipts found for this entry.",onFillData:le}),e.jsxs("div",{className:"space-y-6",children:[N.map(t=>e.jsx(Ke,{poForm:t,isReadOnly:ue,fillDataMode:n[t.id]||!1,onSupplierNameChange:s=>A(t.id,s),onSupplierCodeChange:s=>ee(t.id,s),onVendorSelect:s=>te(t.id,s),onPOFocus:()=>se(t.id),onPOSelect:s=>re(t.id,s),onReceivedQtyChange:(s,l)=>ne(t.id,s,l),onRemove:()=>ae(t.id),canRemove:N.length>1,apiErrors:f,openPODropdown:R===t.id,onClosePODropdown:()=>D(null),poSearchTerm:L[t.id]||"",onPOSearchChange:s=>$(l=>({...l,[t.id]:s})),onFillData:()=>de(t.id)},t.id)),(()=>{const t=Object.values(n).some(s=>s===!0);return!c||d||t})()&&e.jsx("div",{className:"flex justify-center",children:e.jsxs(q,{type:"button",variant:"outline",onClick:ie,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Add New PO"]})})]}),e.jsxs("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:justify-between",children:[e.jsxs(q,{type:"button",variant:"outline",onClick:ce,children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Previous"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(q,{type:"button",variant:"outline",onClick:()=>{g.invalidateQueries({queryKey:["vehicleEntries"]}),i("/gate/raw-materials")},children:"Cancel"}),e.jsx(q,{type:"button",onClick:oe,disabled:K.isPending||M,children:c&&!p&&!d?"Next →":K.isPending||M?"Saving...":"Save and Next →"})]})]})]})}function Ke({poForm:i,isReadOnly:g,fillDataMode:h,onSupplierNameChange:P,onSupplierCodeChange:C,onVendorSelect:E,onPOFocus:w,onPOSelect:j,onReceivedQtyChange:b,onRemove:O,canRemove:y,apiErrors:d,openPODropdown:v,onClosePODropdown:p,poSearchTerm:T,onPOSearchChange:M,onFillData:V}){const c=m.useRef(null),N=we(T,100),_=v&&!!i.supplierCode,{data:R=[],isLoading:D,error:L}=ke(i.supplierCode||void 0,_),$=!!(L&&(()=>{const n=L,x=n.message?.toLowerCase()||"",A=n.response?.data?.detail?.toLowerCase()||"";return n.status===400||x.includes("required")||x.includes("invalid")||A.includes("required")||A.includes("invalid")})()),f=g||$&&!h,o=m.useMemo(()=>{if(!N.trim())return R;const n=N.toLowerCase();return R.filter(x=>x.po_number.toLowerCase().includes(n)||x.supplier_name.toLowerCase().includes(n))},[R,N]);return m.useEffect(()=>{const n=x=>{c.current&&!c.current.contains(x.target)&&p()};if(v)return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[v,p]),e.jsxs(xe,{children:[e.jsx(he,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(_e,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"}),"Supplier & Purchase Order"]}),y&&e.jsxs(q,{type:"button",variant:"outline",size:"sm",onClick:O,children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Remove"]})]})}),e.jsx(fe,{children:e.jsxs("div",{className:"space-y-4",children:[$&&!h&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-4 text-sm text-destructive",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:(()=>{const n=L;return n.response?.data?.detail||n.message||"Error loading purchase orders"})()})]}),e.jsx(q,{onClick:V,size:"sm",children:"Fill Data"})]})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(Ve,{label:"Supplier",required:!0,value:i.supplierCode,onChange:E,disabled:f,error:d[`${i.id}_supplierCode`]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(z,{htmlFor:`po-number-${i.id}`,children:["PO Number ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{ref:c,className:"relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx(B,{id:`po-number-${i.id}`,placeholder:"Click to select PO",value:i.poNumber,onFocus:w,onChange:n=>{M(n.target.value),n.target.value&&w()},disabled:f||!i.supplierCode,className:k("pr-10",d[`${i.id}_poNumber`]&&"border-destructive",(!i.supplierCode||f)&&"cursor-not-allowed opacity-50")}),e.jsx(ve,{className:k("absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground pointer-events-none transition-transform",v&&"rotate-180")})]}),v&&i.supplierCode&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-lg max-h-60 overflow-auto",children:D?e.jsx("div",{className:"flex items-center justify-center p-4",children:e.jsx(Ne,{className:"h-4 w-4 animate-spin text-muted-foreground"})}):o.length===0?e.jsx("div",{className:"p-4 text-sm text-muted-foreground text-center",children:T?"No POs found":"Enter supplier code and click to load POs"}):e.jsx("div",{className:"py-1",children:o.map(n=>e.jsxs("button",{type:"button",className:k("w-full text-left px-4 py-2 hover:bg-accent focus:bg-accent focus:outline-none flex items-center justify-between",i.poNumber===n.po_number&&"bg-accent"),onClick:()=>j(n),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.po_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:n.supplier_name})]}),i.poNumber===n.po_number&&e.jsx(ge,{className:"h-4 w-4 text-primary"})]},n.po_number))})})]}),d[`${i.id}_poNumber`]&&e.jsx("p",{className:"text-sm text-destructive",children:d[`${i.id}_poNumber`]}),!i.supplierCode&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please select a supplier first to load POs"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:`supplier-name-${i.id}`,children:"Supplier Name"}),e.jsx(B,{id:`supplier-name-${i.id}`,placeholder:"Auto-filled from supplier selection",value:i.supplierName,readOnly:!0,disabled:!0,className:"bg-muted"}),d[`${i.id}_supplierName`]&&e.jsx("p",{className:"text-sm text-destructive",children:d[`${i.id}_supplierName`]})]}),i.items.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(z,{className:"text-base font-semibold",children:"Items"}),d[`${i.id}_received`]&&e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),d[`${i.id}_received`]]})]}),e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-[800px]",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"PO Item Code"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Item Name"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Ordered Qty"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Received Qty"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Received Now"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Remaining Qty"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Unit of Measurement"})]})}),e.jsx("tbody",{children:i.items.map(n=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-3 text-sm",children:n.po_item_code}),e.jsx("td",{className:"p-3 text-sm",children:n.item_name}),e.jsx("td",{className:"p-3 text-sm",children:n.ordered_qty}),e.jsx("td",{className:"p-3 text-sm text-muted-foreground",children:n.received_qty>0?n.received_qty:"-"}),e.jsxs("td",{className:"p-3 text-sm",children:[e.jsx(B,{type:"number",step:"0.001",min:"0",max:n.remaining_qty_initial,placeholder:"0.000",value:n.received_qty_now||"",onChange:x=>b(n.po_item_code,x.target.value),disabled:f,className:k("w-24",d[`${i.id}_item_${n.po_item_code}`]&&"border-destructive",f&&"cursor-not-allowed opacity-50")}),d[`${i.id}_item_${n.po_item_code}`]&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:d[`${i.id}_item_${n.po_item_code}`]})]}),e.jsx("td",{className:"p-3 text-sm font-medium",children:n.remaining_qty}),e.jsx("td",{className:"p-3 text-sm",children:n.uom})]},n.po_item_code))})]})})})]})]})})]})}export{dt as default};
