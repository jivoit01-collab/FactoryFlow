import{y as ie,F as Ae,G as ke,am as we,r as N,av as g,a as Ce,Q as Se,j as e,B as y,au as Ie,J as M,C as B,b as Q,c as q,e as U,L as _,I as x,as as ae}from"./index-FTIaQgW5.js";import{F as L}from"./status.constants-Dr0xsafU.js";import{u as Ee}from"./useScrollToError-Bl7nvqHc.js";import{u as Pe}from"./useMutation-BQU46QGt.js";import{f as Re,g as Te,h as Oe,i as Me,j as Le,k as Fe,l as De}from"./inspection.queries-aSIVUUk6.js";import{u as Ve,M as Be}from"./MaterialTypeSelect-BjW7OVad.js";import{W as I,a as H,F as $}from"./qc.constants-Df-o2KBv.js";import{A as te}from"./arrow-left-W805IoU0.js";import{C as Qe}from"./circle-alert-BN4aLgiR.js";import{F as qe}from"./file-text-C43-TAyn.js";import{C as re}from"./circle-check-Bl6EaNhP.js";import{C as Ue}from"./circle-x-DPVka7m7.js";import{S as He}from"./send-buL6urAC.js";import"./triangle-alert-DwAJckdW.js";import"./clock-CjpRzroy.js";import"./SearchableSelect-3dXhh_Hs.js";import"./plus-Broj2zbo.js";import"./materialType.queries-XSEvsNiy.js";import"./user-check-CUYSprdx.js";const $e=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],We=ie("pencil",$e);const Ke=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ze=ie("save",Ke),Ge={async getById(n){return(await Ae.get(ke.QUALITY_CONTROL_V2.ARRIVAL_SLIP_BY_ID(n))).data}},ne={all:["qc-arrivalSlips"],detail:n=>[...ne.all,"detail",n]};function Ye(n){return Pe({queryKey:ne.detail(n),queryFn:()=>Ge.getById(n),enabled:!!n})}function Je(n){const{hasAnyPermission:f}=we();return N.useMemo(()=>{const F=f([g.INSPECTION.CREATE]),b=f([g.INSPECTION.CREATE,g.INSPECTION.EDIT]),A=f([g.INSPECTION.SUBMIT]),k=f([g.APPROVAL.APPROVE_AS_CHEMIST]),E=f([g.APPROVAL.APPROVE_AS_QAM]),a=f([g.APPROVAL.REJECT,g.APPROVAL.APPROVE_AS_CHEMIST,g.APPROVAL.APPROVE_AS_QAM]),P=!n||n.workflow_status===I.DRAFT,m=n?.workflow_status===I.SUBMITTED,D=n?.workflow_status===I.QA_CHEMIST_APPROVED,i=n?.is_locked??!1,R=n?.workflow_status===I.QAM_APPROVED||n?.workflow_status===I.COMPLETED;return{canCreateInspection:F,canEditInspection:b,canSubmitInspection:A,canApproveAsChemist:k,canApproveAsQAM:E,canReject:a,showSaveButton:!i&&P&&b,showSubmitButton:n&&P&&!i&&A,showChemistApproval:m&&k,showQAMApproval:D&&E,showRejectButton:(m||D)&&a,canEditFields:!i&&P&&b,isCompleted:R,isLocked:i}},[n,f])}function vs(){const n=Ce(),{slipId:f,inspectionId:F}=Se(),b=window.location.pathname.includes("/new"),A=f?parseInt(f):F?parseInt(F):null,[k,E]=N.useState(!1),{data:a,isLoading:P}=Re(A),{data:m,isLoading:D}=Ye(b&&!a?A:null),[i,R]=N.useState({inspection_date:new Date().toISOString().split("T")[0],description_of_material:"",sap_code:"",supplier_name:"",manufacturer_name:"",supplier_batch_lot_no:"",unit_packing:"",purchase_order_no:"",invoice_bill_no:"",vehicle_no:"",material_type_id:0,remarks:""}),[T,W]=N.useState({}),[O,le]=N.useState(""),[K,ce]=N.useState(L.ACCEPTED),[o,p]=N.useState({});Ee(o);const{data:C=[]}=Ve(i.material_type_id||null),z=Te(),G=Oe(),Y=Me(),J=Le(),X=Fe(),Z=De();N.useEffect(()=>{if(a){R({inspection_date:a.inspection_date,description_of_material:a.description_of_material,sap_code:a.sap_code,supplier_name:a.supplier_name,manufacturer_name:a.manufacturer_name,supplier_batch_lot_no:a.supplier_batch_lot_no,unit_packing:a.unit_packing,purchase_order_no:a.purchase_order_no,invoice_bill_no:a.invoice_bill_no,vehicle_no:a.vehicle_no,material_type_id:a.material_type,remarks:a.remarks});const s={};a.parameter_results?.forEach(t=>{s[t.parameter_master]={result_value:t.result_value,result_numeric:t.result_numeric||void 0,is_within_spec:t.is_within_spec??void 0,remarks:t.remarks}}),W(s)}},[a]),N.useEffect(()=>{m&&!a&&b&&R(s=>({...s,description_of_material:m.item_name||s.description_of_material,sap_code:m.po_item_code||s.sap_code,supplier_name:m.party_name||s.supplier_name,unit_packing:m.billing_qty&&m.billing_uom?`${m.billing_qty} ${m.billing_uom}`:s.unit_packing,vehicle_no:m.truck_no_as_per_bill||s.vehicle_no,invoice_bill_no:m.commercial_invoice_no||s.invoice_bill_no,remarks:m.remarks||s.remarks}))},[m,a,b]);const j=(s,t)=>{R(v=>({...v,[s]:t})),o[s]&&p(v=>{const c={...v};return delete c[s],c})},S=(s,t,v)=>{W(h=>({...h,[s]:{...h[s],result_value:h[s]?.result_value||"",remarks:h[s]?.remarks||"",[t]:v}}));const c=`param_${s}`;o[c]&&p(h=>{const d={...h};return delete d[c],d})},oe=async()=>{if(A)try{p({});const s={};i.material_type_id||(s.material_type_id="Please select a material type"),i.supplier_batch_lot_no?.trim()||(s.supplier_batch_lot_no="Supplier Batch/Lot No. is required"),i.purchase_order_no?.trim()||(s.purchase_order_no="Purchase Order No. is required");const t=C.filter(c=>c.is_mandatory);for(const c of t)T[c.id]?.result_value?.trim()||(s[`param_${c.id}`]=`${c.parameter_name} result is required`);if(Object.keys(s).length>0){p(s);return}let v=a?.id;if(a||(v=(await z.mutateAsync({slipId:A,data:i})).id),v&&Object.keys(T).length>0){const c=Object.entries(T).map(([h,d])=>({parameter_master_id:parseInt(h),result_value:d.result_value||"",result_numeric:d.result_numeric,is_within_spec:d.is_within_spec??!0,remarks:d.remarks||""}));await G.mutateAsync({inspectionId:v,results:c})}E(!1)}catch(s){p({general:s.message||"Failed to save inspection"})}},de=async()=>{if(!a){p({general:"Please save the inspection first"});return}try{p({}),await Y.mutateAsync(a.id)}catch(s){p({general:s.message||"Failed to submit inspection"})}},me=async()=>{if(a)try{p({}),await J.mutateAsync({id:a.id,data:{remarks:O}})}catch(s){p({general:s.message||"Failed to approve"})}},pe=async()=>{if(a)try{p({}),await X.mutateAsync({id:a.id,data:{remarks:O,final_status:K}})}catch(s){p({general:s.message||"Failed to approve"})}},ue=async()=>{if(a){if(!O.trim()){p({approval_remarks:"Please provide a reason for rejection"});return}try{p({}),await Z.mutateAsync({id:a.id,data:{remarks:O}})}catch(s){p({general:s.message||"Failed to reject"})}}},{canEditInspection:_e,showSubmitButton:he,showChemistApproval:xe,showQAMApproval:ve,showRejectButton:je,canEditFields:fe,isLocked:ge}=Je(a),Ne=!a||a.workflow_status===I.DRAFT,l=fe&&(!a||k),be=a&&Ne&&_e&&!k&&!ge,ye=he&&!k,ee=xe,V=ve,se=je,r=z.isPending||G.isPending||Y.isPending||J.isPending||X.isPending||Z.isPending;return P||D?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>n("/qc/pending"),children:e.jsx(te,{className:"h-4 w-4"})}),e.jsxs("h2",{className:"text-3xl font-bold tracking-tight flex items-center gap-3",children:[e.jsx(Ie,{className:"h-8 w-8"}),b?"New Inspection":"Inspection Details"]})]}),a&&e.jsxs("div",{className:"flex items-center gap-4 ml-10",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Report No: ",a.report_no]}),e.jsx("span",{className:M("px-2 py-1 rounded-full text-xs font-medium",H[a.workflow_status].bgColor,H[a.workflow_status].color),children:H[a.workflow_status].label}),a.final_status!==L.PENDING&&e.jsx("span",{className:M("px-2 py-1 rounded-full text-xs font-medium",$[a.final_status].bgColor,$[a.final_status].color),children:$[a.final_status].label})]})]})}),o.general&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4"}),o.general]}),e.jsxs(B,{children:[e.jsx(Q,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"Inspection Information"]})}),e.jsx(U,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Description of Material"}),e.jsx(x,{value:i.description_of_material||"",onChange:s=>j("description_of_material",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"SAP Code"}),e.jsx(x,{value:i.sap_code||"",onChange:s=>j("sap_code",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Supplier Name"}),e.jsx(x,{value:i.supplier_name||"",onChange:s=>j("supplier_name",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Unit Packing"}),e.jsx(x,{value:i.unit_packing||"",onChange:s=>j("unit_packing",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Vehicle No."}),e.jsx(x,{value:i.vehicle_no||"",onChange:s=>j("vehicle_no",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Invoice/Bill No."}),e.jsx(x,{value:i.invoice_bill_no||"",onChange:s=>j("invoice_bill_no",s.target.value),disabled:!l||r})]}),e.jsx(Be,{label:"Material Type",required:!0,value:i.material_type_id||void 0,onChange:s=>j("material_type_id",s?.id||0),disabled:!l||r||!!a,error:o.material_type_id}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Inspection Date"}),e.jsx(x,{type:"date",value:i.inspection_date||"",onChange:s=>j("inspection_date",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Manufacturer Name"}),e.jsx(x,{value:i.manufacturer_name||"",onChange:s=>j("manufacturer_name",s.target.value),disabled:!l||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{children:["Supplier Batch/Lot No. ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{value:i.supplier_batch_lot_no||"",onChange:s=>j("supplier_batch_lot_no",s.target.value),disabled:!l||r,className:o.supplier_batch_lot_no?"border-destructive":""}),o.supplier_batch_lot_no&&e.jsx("p",{className:"text-sm text-destructive",children:o.supplier_batch_lot_no})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{children:["Purchase Order No. ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(x,{value:i.purchase_order_no||"",onChange:s=>j("purchase_order_no",s.target.value),disabled:!l||r,className:o.purchase_order_no?"border-destructive":""}),o.purchase_order_no&&e.jsx("p",{className:"text-sm text-destructive",children:o.purchase_order_no})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx(_,{children:"Remarks"}),e.jsx(ae,{value:i.remarks||"",onChange:s=>j("remarks",s.target.value),disabled:!l||r,rows:2})]})]})})]}),((a?.parameter_results?.length??0)>0||C.length>0)&&e.jsxs(B,{children:[e.jsx(Q,{children:e.jsx(q,{children:"QC Parameters"})}),e.jsxs(U,{children:[e.jsx("div",{className:"md:hidden space-y-4",children:(a?.parameter_results||C).map(s=>{const t="parameter_master"in s?s.parameter_master:s.id,v=s.parameter_name,c=s.standard_value,h="is_mandatory"in s?s.is_mandatory:C.find(u=>u.id===t)?.is_mandatory??!1,d=o[`param_${t}`],w=T[t]||{result_value:"",is_within_spec:!0,remarks:""};return e.jsxs("div",{className:M("border rounded-lg p-3 space-y-3",d&&"border-destructive"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-medium text-sm",children:[v,h&&e.jsx("span",{className:"text-destructive",children:" *"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:w.is_within_spec??!0,onChange:u=>S(t,"is_within_spec",u.target.checked),disabled:!l||r,className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-muted-foreground",children:"Within Spec"})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Standard: ",c]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(_,{className:"text-xs",children:["Result",h&&e.jsx("span",{className:"text-destructive",children:" *"})]}),e.jsx(x,{value:w.result_value,onChange:u=>S(t,"result_value",u.target.value),disabled:!l||r,className:M("w-full",d&&"border-destructive")}),d&&e.jsx("p",{className:"text-xs text-destructive",children:d})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(_,{className:"text-xs",children:"Remarks"}),e.jsx(x,{value:w.remarks,onChange:u=>S(t,"remarks",u.target.value),disabled:!l||r,className:"w-full",placeholder:"Optional"})]})]},t)})}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"text-left p-3 font-medium",children:"Parameter"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Standard Value"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Result"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"Within Spec"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Remarks"})]})}),e.jsx("tbody",{children:(a?.parameter_results||C).map(s=>{const t="parameter_master"in s?s.parameter_master:s.id,v=s.parameter_name,c=s.standard_value,h="is_mandatory"in s?s.is_mandatory:C.find(u=>u.id===t)?.is_mandatory??!1,d=o[`param_${t}`],w=T[t]||{result_value:"",is_within_spec:!0,remarks:""};return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"p-3",children:e.jsxs("span",{className:"font-medium",children:[v,h&&e.jsx("span",{className:"text-destructive",children:" *"})]})}),e.jsx("td",{className:"p-3 text-muted-foreground",children:c}),e.jsxs("td",{className:"p-3",children:[e.jsx(x,{value:w.result_value,onChange:u=>S(t,"result_value",u.target.value),disabled:!l||r,className:M("w-full",d&&"border-destructive")}),d&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:d})]}),e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:w.is_within_spec??!0,onChange:u=>S(t,"is_within_spec",u.target.checked),disabled:!l||r,className:"h-4 w-4 rounded border-gray-300"})}),e.jsx("td",{className:"p-3",children:e.jsx(x,{value:w.remarks,onChange:u=>S(t,"remarks",u.target.value),disabled:!l||r,className:"w-full",placeholder:"Optional"})})]},t)})})]})})]})]}),(ee||V||se)&&e.jsxs(B,{className:"border-primary/50",children:[e.jsx(Q,{children:e.jsx(q,{children:"Approval"})}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Remarks"}),e.jsx(ae,{value:O,onChange:s=>le(s.target.value),placeholder:"Enter approval/rejection remarks",rows:3}),o.approval_remarks&&e.jsx("p",{className:"text-sm text-destructive",children:o.approval_remarks})]}),V&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Final Status"}),e.jsxs("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:K,onChange:s=>ce(s.target.value),children:[e.jsx("option",{value:L.ACCEPTED,children:"Accepted"}),e.jsx("option",{value:L.REJECTED,children:"Rejected"}),e.jsx("option",{value:L.HOLD,children:"Hold"})]})]}),e.jsxs("div",{className:"flex gap-4",children:[ee&&e.jsxs(y,{onClick:me,disabled:r,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Approve as Chemist"]}),V&&e.jsxs(y,{onClick:pe,disabled:r,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Approve as Manager"]}),se&&e.jsxs(y,{variant:"destructive",onClick:ue,disabled:r,children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]})]}),e.jsxs("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:justify-between",children:[e.jsxs(y,{variant:"outline",onClick:()=>n("/qc/pending"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsxs("div",{className:"flex gap-4",children:[be&&e.jsxs(y,{variant:"outline",onClick:()=>E(!0),children:[e.jsx(We,{className:"h-4 w-4 mr-2"}),"Update"]}),l&&e.jsxs(y,{onClick:oe,disabled:r,children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),r?"Saving...":"Save"]}),ye&&!k&&e.jsxs(y,{onClick:de,disabled:r,children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),"Submit for Approval"]})]})]})]})}export{vs as default};
