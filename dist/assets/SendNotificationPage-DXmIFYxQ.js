import{H as L,J as M,r,j as e,C as R,b as I,c as U,d as O,e as P,L as m,I as f,as as q,B as K,O as D,P as V,at as W}from"./index-_Sfdy-kJ.js";import{B as F}from"./badge-gDK2lZvz.js";import{u as J}from"./useScrollToError-BaiV-2ma.js";import{u as $,a as z}from"./useMutation-pgUcGbpY.js";import{C as X}from"./circle-alert-g97mPIxl.js";import{S as Z}from"./send-CdawGwpj.js";import{U as ee}from"./users-DiG97AVY.js";import{C as te}from"./circle-check-D0318yXf.js";import{S as se}from"./search-NtfP0T3E.js";const ae={async send(l){return(await L.post(M.NOTIFICATIONS.SEND,l)).data}},ie={async getUsers(){return(await L.get(M.ACCOUNTS.USERS)).data}},re={users:["company-users"]};function le(){return $({queryKey:re.users,queryFn:()=>ie.getUsers(),staleTime:300*1e3})}function ne(){return z({mutationFn:l=>ae.send(l)})}const ce=[{value:"GENERAL_ANNOUNCEMENT",label:"General Announcement"},{value:"GATE_ENTRY_CREATED",label:"Gate Entry Created"},{value:"GATE_ENTRY_STATUS_CHANGED",label:"Gate Entry Status Changed"},{value:"SECURITY_CHECK_DONE",label:"Security Check Done"},{value:"WEIGHMENT_RECORDED",label:"Weighment Recorded"},{value:"ARRIVAL_SLIP_SUBMITTED",label:"Arrival Slip Submitted"},{value:"QC_INSPECTION_SUBMITTED",label:"QC Inspection Submitted"},{value:"QC_CHEMIST_APPROVED",label:"QA Chemist Approved"},{value:"QC_QAM_APPROVED",label:"QAM Approved"},{value:"QC_REJECTED",label:"QC Rejected"},{value:"QC_COMPLETED",label:"QC Completed"},{value:"GRPO_POSTED",label:"GRPO Posted"},{value:"GRPO_FAILED",label:"GRPO Failed"}];function ge(){const[l,N]=r.useState(""),[g,y]=r.useState(""),[E,S]=r.useState("GENERAL_ANNOUNCEMENT"),[j,_]=r.useState(""),[c,T]=r.useState("all"),[n,x]=r.useState([]),[o,A]=r.useState(""),[d,k]=r.useState(""),[a,u]=r.useState({});J(a);const{data:h=[],isLoading:G}=le(),w=ne(),v=r.useMemo(()=>{if(!d.trim())return h;const t=d.toLowerCase();return h.filter(s=>s.full_name.toLowerCase().includes(t)||s.email.toLowerCase().includes(t))},[h,d]),Q=t=>{x(s=>s.includes(t)?s.filter(i=>i!==t):[...s,t]),a.recipients&&u(s=>{const i={...s};return delete i.recipients,i})},B=()=>{x(v.map(t=>t.id))},H=()=>{x([])},p=(t,s)=>{switch(a[t]&&u(i=>{const C={...i};return delete C[t],C}),t){case"title":N(s);break;case"body":y(s);break;case"click_action_url":_(s);break;case"role_filter":A(s);break}},Y=async()=>{const t={};if(l.trim()||(t.title="Title is required"),g.trim()||(t.body="Body is required"),c==="specific"&&n.length===0&&(t.recipients="Select at least one recipient"),Object.keys(t).length>0){u(t);return}const s={title:l.trim(),body:g.trim(),notification_type:E};j.trim()&&(s.click_action_url=j.trim()),c==="specific"?s.recipient_user_ids=n:o.trim()&&(s.role_filter=o.trim());try{u({});const i=await w.mutateAsync(s);W.success(i.message),N(""),y(""),S("GENERAL_ANNOUNCEMENT"),_(""),x([]),A(""),k(""),T("all")}catch(i){u({general:i.message||"Failed to send notification"})}},b=w.isPending;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Send Notification"}),e.jsx("p",{className:"text-muted-foreground",children:"Broadcast a notification to users in your company"})]}),a.general&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 shrink-0"}),a.general]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[1fr_400px]",children:[e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(U,{children:"Notification Details"}),e.jsx(O,{children:"Compose the notification to send"})]}),e.jsxs(P,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{htmlFor:"title",children:["Title ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(f,{id:"title",placeholder:"e.g. Maintenance Scheduled",value:l,onChange:t=>p("title",t.target.value),className:a.title?"border-destructive":""}),a.title&&e.jsx("p",{className:"text-sm text-destructive",children:a.title})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{htmlFor:"body",children:["Body ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(q,{id:"body",placeholder:"Write the notification message...",rows:4,value:g,onChange:t=>p("body",t.target.value),className:a.body?"border-destructive":""}),a.body&&e.jsx("p",{className:"text-sm text-destructive",children:a.body})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"notification_type",children:"Notification Type"}),e.jsx("select",{id:"notification_type",value:E,onChange:t=>S(t.target.value),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:ce.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"click_action_url",children:"Click Action URL"}),e.jsx(f,{id:"click_action_url",placeholder:"e.g. /announcements",value:j,onChange:t=>p("click_action_url",t.target.value)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Frontend route to redirect when the notification is clicked"})]}),c==="all"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"role_filter",children:"Role Filter"}),e.jsx(f,{id:"role_filter",placeholder:"e.g. QC",value:o,onChange:t=>p("role_filter",t.target.value)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Leave empty to broadcast to all users, or enter a role to filter recipients"})]}),e.jsx("div",{className:"pt-2",children:e.jsxs(K,{onClick:Y,disabled:b,className:"w-full sm:w-auto",children:[b?e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Z,{className:"mr-2 h-4 w-4"}),b?"Sending...":"Send Notification"]})})]})]}),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Recipients"]}),e.jsx(O,{children:"Choose who receives this notification"})]}),e.jsxs(P,{className:"space-y-4",children:[e.jsx("div",{className:"flex gap-1 rounded-lg border bg-muted p-1",children:[{key:"all",label:"All Users"},{key:"specific",label:"Specific Users"}].map(({key:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>T(t),className:`flex-1 rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${c===t?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"}`,children:s},t))}),c==="all"?e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-dashed p-4",children:[e.jsx(te,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o.trim()?`Notification will be sent to all users with role "${o.trim()}"`:"Notification will be sent to all users in the company"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(f,{placeholder:"Search users...",value:d,onChange:t=>k(t.target.value),className:"pl-9"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[n.length," selected"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:B,className:"text-xs text-primary hover:underline",children:"Select all"}),e.jsx("button",{type:"button",onClick:H,className:"text-xs text-primary hover:underline",children:"Clear"})]})]}),a.recipients&&e.jsx("p",{className:"text-sm text-destructive",children:a.recipients}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto rounded-md border",children:G?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(D,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):v.length===0?e.jsx("div",{className:"py-8 text-center text-sm text-muted-foreground",children:d?"No users match your search":"No users found"}):e.jsx("div",{className:"divide-y",children:v.map(t=>e.jsxs("div",{onClick:()=>Q(t.id),className:"flex cursor-pointer items-center gap-3 px-3 py-2.5 hover:bg-accent transition-colors",children:[e.jsx(V,{checked:n.includes(t.id)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:t.full_name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:t.email})]})]},t.id))})}),n.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[n.slice(0,5).map(t=>{const s=h.find(i=>i.id===t);return s?e.jsx(F,{variant:"secondary",className:"text-xs",children:s.full_name},t):null}),n.length>5&&e.jsxs(F,{variant:"outline",className:"text-xs",children:["+",n.length-5," more"]})]})]})]})]})]})]})}export{ge as default};
