import{r as j,j as e,C as v,e as y,B as h,a as E,W as k,ao as R,ap as D}from"./index-CNJik9Bh.js";import{c as F,b as I}from"./status.constants-MU3oKHc-.js";import{e as T,f as O,g as G,h as L}from"./grpo.queries-C2TMtU-d.js";import{P as U}from"./paperclip-33xZiK1l.js";import{C as b}from"./circle-alert-B-5U1cYA.js";import{U as $}from"./upload-L-RjCSE_.js";import{F as H}from"./file-text-DpLW8JCX.js";import{E as z}from"./external-link-D3DOoelL.js";import{R as _,S as M}from"./shield-x-C9-MDhK3.js";import{T as B}from"./trash-2-DPsNdUAM.js";import{A as w}from"./arrow-left-DKuf5-od.js";import"./triangle-alert-Cb6fLCmv.js";import"./circle-x-DJPltSGa.js";import"./circle-check-Bx53qSBq.js";import"./clock-CHlw3red.js";import"./useMutation-CvzAhSVt.js";const q=r=>{if(!r)return"-";try{return new Date(r).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return r}};function V({postingId:r,attachments:n,canManage:c}){const s=j.useRef(null),[m,i]=j.useState(null),[g,p]=j.useState(null),[x,u]=j.useState(null),l=T(r),o=O(r),A=G(r),P=async t=>{const a=t.target.files;if(!(!a||a.length===0)){i(null);for(const d of Array.from(a))try{await l.mutateAsync(d)}catch(f){i(f.message||`Failed to upload ${d.name}`)}s.current&&(s.current.value="")}},S=async t=>{p(t);try{await o.mutateAsync(t)}catch(a){i(a.message||"Failed to delete attachment")}finally{p(null)}},C=async t=>{u(t),i(null);try{await A.mutateAsync(t)}catch(a){i(a.message||"Failed to retry attachment upload")}finally{u(null)}};return e.jsx(v,{children:e.jsxs(y,{className:"p-4 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h3",{className:"font-semibold flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Attachments",n.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground font-normal",children:["(",n.length,")"]})]})}),m&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-md bg-destructive/5 border border-destructive/20",children:[e.jsx(b,{className:"h-4 w-4 text-destructive flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-destructive",children:m})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed border-muted-foreground/25 p-6 text-center cursor-pointer hover:border-primary/50 transition-colors",onClick:()=>s.current?.click(),children:[e.jsx($,{className:"h-8 w-8 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Click to upload files"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Invoices, challans, and other documents"})]}),l.isPending&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Uploading..."]})]}),e.jsx("input",{ref:s,type:"file",multiple:!0,className:"hidden",onChange:P})]}),n.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-2",children:"No attachments uploaded."}),n.length>0&&e.jsx("div",{className:"space-y-2",children:n.map(t=>{const a=F[t.sap_attachment_status],d=t.sap_attachment_status==="FAILED",f=g===t.id,N=x===t.id;return e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-md border bg-muted/30",children:[e.jsx(H,{className:"h-5 w-5 text-muted-foreground flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("a",{href:t.file,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-medium truncate hover:underline flex items-center gap-1",children:[t.original_filename,e.jsx(z,{className:"h-3 w-3 flex-shrink-0"})]})}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[a&&e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-medium ${a.bgColor} ${a.color}`,children:[e.jsx(a.icon,{className:"h-3 w-3"}),a.label]}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:q(t.uploaded_at)})]}),d&&t.sap_error_message&&e.jsx("p",{className:"text-xs text-destructive",children:t.sap_error_message})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[d&&c&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>C(t.id),disabled:N,title:"Retry SAP upload",children:e.jsx(_,{className:`h-3.5 w-3.5 ${N?"animate-spin":""}`})}),c&&e.jsx(h,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>S(t.id),disabled:f,title:"Delete attachment",children:f?e.jsx("span",{className:"h-3.5 w-3.5 animate-spin rounded-full border-2 border-current border-t-transparent"}):e.jsx(B,{className:"h-3.5 w-3.5"})})]})]},t.id)})})]})})}const W=r=>{if(!r)return"-";try{return new Date(r).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return r}};function ce(){const r=E(),{postingId:n}=k(),c=n?parseInt(n,10):null,{data:s,isLoading:m,error:i,refetch:g}=L(c),p=R(D.MANAGE_ATTACHMENTS),x=i,u=x?.status===403,l=s?I[s.status]:null;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>r("/grpo/history"),children:e.jsx(w,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Posting Detail"})]}),u&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-destructive/50 bg-destructive/5",children:[e.jsx(M,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-destructive",children:"Permission Denied"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:x?.message||"You do not have permission to view this posting."})]})]}),i&&!u&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-yellow-500/50 bg-yellow-50 dark:bg-yellow-900/10",children:[e.jsx(b,{className:"h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-yellow-800 dark:text-yellow-400",children:"Failed to Load"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:x?.message||"An error occurred while loading posting detail."})]}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>g(),children:e.jsx(_,{className:"h-4 w-4"})})]}),m&&e.jsx("div",{className:"flex items-center justify-center h-48",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}),!m&&!i&&s&&e.jsxs(e.Fragment,{children:[e.jsx(v,{children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",children:"Posting Information"}),l&&e.jsx("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium ${l.bgColor} ${l.color}`,children:l.label})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Entry No"}),e.jsx("p",{className:"font-medium",children:s.entry_no})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"PO Number"}),e.jsx("p",{className:"font-medium",children:s.po_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"SAP Doc Number"}),e.jsx("p",{className:"font-medium",children:s.sap_doc_num??"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"SAP Doc Entry"}),e.jsx("p",{className:"font-medium",children:s.sap_doc_entry??"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Value"}),e.jsx("p",{className:"font-medium",children:s.sap_doc_total?parseFloat(s.sap_doc_total).toLocaleString("en-IN",{style:"currency",currency:"INR"}):"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Posted At"}),e.jsx("p",{className:"font-medium",children:W(s.posted_at)})]})]}),s.error_message&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-md bg-destructive/5 border border-destructive/20",children:[e.jsx(b,{className:"h-4 w-4 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:"Error"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.error_message})]})]})]})}),s.lines&&s.lines.length>0&&e.jsx(v,{children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsx("h3",{className:"font-semibold",children:"Posted Items"}),e.jsx("div",{className:"space-y-2",children:s.lines.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md border bg-muted/30",children:[e.jsx("div",{children:e.jsxs("p",{className:"text-sm font-medium",children:[o.item_code," - ",o.item_name]})}),e.jsx("span",{className:"text-sm font-semibold",children:o.quantity_posted})]},o.id))})]})}),s.status==="POSTED"&&e.jsx(V,{postingId:s.id,attachments:s.attachments||[],canManage:p}),e.jsxs(h,{variant:"outline",onClick:()=>r("/grpo/history"),children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Back to History"]})]})]})}export{ce as default};
