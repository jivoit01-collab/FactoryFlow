import{j as e,B as j,L as h,I as p,r as k,a as te,W as ae,C as re,e as ce,D as T,m as L,n as G,o as I,p as $,q as V}from"./index-CNJik9Bh.js";import{G as ne,F as z}from"./status.constants-MU3oKHc-.js";import{b as ie,c as le,d as oe}from"./grpo.queries-C2TMtU-d.js";import{P as de}from"./plus-BJzDLdE5.js";import{T as me}from"./trash-2-DPsNdUAM.js";import{S as xe}from"./SearchableSelect-D-qlCXhi.js";import{A as ue}from"./arrow-left-DKuf5-od.js";import{R as Q,S as he}from"./shield-x-C9-MDhK3.js";import{C as W}from"./circle-alert-B-5U1cYA.js";import{P as pe}from"./package-9Ijk1eZt.js";import{C as B}from"./circle-check-Bx53qSBq.js";import"./triangle-alert-Cb6fLCmv.js";import"./circle-x-DJPltSGa.js";import"./clock-CHlw3red.js";import"./useMutation-CvzAhSVt.js";const U=parseInt("2",10);function ge({charges:g,onChange:f,disabled:u}){const C=()=>{f([...g,{expense_code:0,amount:0,remarks:"",tax_code:""}])},w=d=>{f(g.filter((i,l)=>l!==d))},_=(d,i,l)=>{const v=g.map((N,n)=>n!==d?N:{...N,[i]:l});f(v)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Extra Charges"}),e.jsxs(j,{type:"button",variant:"outline",size:"sm",onClick:C,disabled:u,className:"h-7 text-xs",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Add Charge"]})]}),g.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:'No extra charges. Click "Add Charge" to add freight, handling, or other expenses.'}),g.map((d,i)=>e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3 rounded-md border bg-muted/20 sm:grid-cols-5 sm:items-end",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Expense Code"}),e.jsx(p,{type:"number",min:0,value:d.expense_code||"",onChange:l=>_(i,"expense_code",parseInt(l.target.value)||0),placeholder:"Code",className:"h-8 text-sm",disabled:u})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Amount"}),e.jsx(p,{type:"number",min:0,step:"any",value:d.amount||"",onChange:l=>_(i,"amount",parseFloat(l.target.value)||0),placeholder:"0.00",className:"h-8 text-sm",disabled:u})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Remarks"}),e.jsx(p,{value:d.remarks||"",onChange:l=>_(i,"remarks",l.target.value),placeholder:"e.g. Freight",className:"h-8 text-sm",disabled:u})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Tax Code"}),e.jsx(p,{value:d.tax_code||"",onChange:l=>_(i,"tax_code",l.target.value),placeholder:"e.g. GST18",className:"h-8 text-sm",disabled:u})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>w(i),disabled:u,className:"h-8 w-8 p-0 text-destructive hover:text-destructive",children:e.jsx(me,{className:"h-4 w-4"})})})]},i))]})}function _e({value:g,onChange:f,placeholder:u="Select warehouse",disabled:C=!1,error:w,label:_,required:d=!1}){const[i,l]=k.useState(!1),{data:v=[],isLoading:N}=ie(i);return e.jsx(xe,{value:g,items:v,isLoading:N,placeholder:u,disabled:C,error:w,label:_,required:d,inputId:"warehouse-select",inputClassName:"h-8 text-sm",getItemKey:n=>n.warehouse_code,getItemLabel:n=>`${n.warehouse_name} (${n.warehouse_code})`,filterFn:(n,o)=>n.warehouse_name.toLowerCase().includes(o.toLowerCase())||n.warehouse_code.toLowerCase().includes(o.toLowerCase()),renderItem:n=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm",children:n.warehouse_name}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",n.warehouse_code,")"]})]}),loadingText:"Loading warehouses...",emptyText:"No warehouses available",notFoundText:"No warehouses found",onOpenChange:l,onItemSelect:n=>{f(n.warehouse_code)},onClear:()=>{f("")}})}function Ae(){const g=te(),{vehicleEntryId:f}=ae(),u=f?parseInt(f,10):null,{data:C=[],isLoading:w,error:_,refetch:d}=le(u),i=oe(),[l,v]=k.useState({}),[N,n]=k.useState({}),[o,S]=k.useState(null),[F,q]=k.useState(null),A=_,E=A?.status===403,b=k.useCallback(s=>{if(l[s.po_receipt_id])return l[s.po_receipt_id];const r={};return s.items.forEach(a=>{r[a.po_item_receipt_id]={accepted_qty:a.received_qty,unit_price:a.unit_price?parseFloat(a.unit_price):void 0,tax_code:a.tax_code||void 0,gl_account:a.gl_account||void 0,variety:void 0}}),{items:r,warehouseCode:s.items[0]?.warehouse_code||"",comments:"",vendorRef:s.vendor_ref||"",extraCharges:[]}},[l]),P=()=>({items:{},warehouseCode:"",comments:"",vendorRef:"",extraCharges:[]}),H=(s,r,a)=>{const t=a===""?0:parseFloat(a);v(x=>{const m=x[s]||P(),O=m.items[r]||{accepted_qty:0};return{...x,[s]:{...m,items:{...m.items,[r]:{...O,accepted_qty:isNaN(t)?0:t}}}}});const c=`item_${r}`;N[c]&&n(x=>{const m={...x};return delete m[c],m})},R=(s,r,a,t)=>{v(c=>{const x=c[s]||P(),m=x.items[r]||{accepted_qty:0};return{...c,[s]:{...x,items:{...x.items,[r]:{...m,[a]:t}}}}})},K=(s,r)=>{v(a=>{const t=a[s]||P();return{...a,[s]:{...t,warehouseCode:r}}})},M=(s,r)=>{v(a=>{const t=a[s]||P();return{...a,[s]:{...t,comments:r}}})},J=(s,r)=>{v(a=>{const t=a[s]||P();return{...a,[s]:{...t,vendorRef:r}}})},X=(s,r)=>{v(a=>{const t=a[s]||P();return{...a,[s]:{...t,extraCharges:r}}})},Y=s=>{const r=b(s),a={};return s.items.forEach(c=>{const m=r.items[c.po_item_receipt_id]?.accepted_qty??c.received_qty;m<0&&(a[`item_${c.po_item_receipt_id}`]="Cannot be negative"),m>c.received_qty&&(a[`item_${c.po_item_receipt_id}`]=`Cannot exceed received qty (${c.received_qty})`)}),s.items.some(c=>(r.items[c.po_item_receipt_id]?.accepted_qty??c.received_qty)>0)||(a.general="At least one item must have accepted quantity greater than 0"),n(a),Object.keys(a).length===0},Z=s=>{Y(s)&&S(s)},ee=async()=>{if(!o||!u)return;const s=b(o),r=o.items.map(a=>{const t=s.items[a.po_item_receipt_id];return{po_item_receipt_id:a.po_item_receipt_id,accepted_qty:t?.accepted_qty??a.received_qty,unit_price:t?.unit_price,tax_code:t?.tax_code||void 0,gl_account:t?.gl_account||void 0,variety:t?.variety||void 0}});try{n({});const a=await i.mutateAsync({vehicle_entry_id:u,po_receipt_id:o.po_receipt_id,items:r,branch_id:o.branch_id||U,warehouse_code:s.warehouseCode||void 0,comments:s.comments||void 0,vendor_ref:s.vendorRef||void 0,extra_charges:s.extraCharges.length>0?s.extraCharges:void 0});S(null),q(a)}catch(a){S(null),n({general:a.message||"Failed to post GRPO"})}},se=C.length>0?C[0].entry_no:"";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(j,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>g("/grpo/pending"),children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:se||"GRPO Preview"})]}),e.jsx("p",{className:"text-muted-foreground",children:"Review and post goods receipt for each purchase order"})]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>d(),className:"w-full sm:w-auto",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),E&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-destructive/50 bg-destructive/5",children:[e.jsx(he,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-destructive",children:"Permission Denied"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:A?.message||"You do not have permission to preview GRPO data."})]})]}),_&&!E&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-yellow-500/50 bg-yellow-50 dark:bg-yellow-900/10",children:[e.jsx(W,{className:"h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-yellow-800 dark:text-yellow-400",children:"Failed to Load"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:A?.message||"An error occurred while loading preview data."})]}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>d(),children:e.jsx(Q,{className:"h-4 w-4"})})]}),N.general&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-destructive/50 bg-destructive/5",children:[e.jsx(W,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-destructive",children:N.general})]}),w&&e.jsx("div",{className:"flex items-center justify-center h-48",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}),!w&&!_&&C.length===0&&e.jsx("div",{className:"flex items-center justify-center h-24 text-sm text-muted-foreground border rounded-lg",children:"No purchase orders found for this entry."}),!w&&!_&&C.map(s=>{const r=s.grpo_status===ne.POSTED,a=b(s);return e.jsx(re,{className:r?"opacity-60":"",children:e.jsxs(ce,{className:"p-4 space-y-4",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-semibold",children:s.po_number}),r&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",children:[e.jsx(B,{className:"h-3 w-3"}),"Posted (SAP #",s.sap_doc_num,")"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.supplier_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Invoice: ",s.invoice_no||"-"," | Challan: ",s.challan_no||"-",s.branch_id!=null&&` | Branch: ${s.branch_id}`]})]})}),!r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Items"}),s.items.map(t=>{const c=a.items[t.po_item_receipt_id]||{accepted_qty:t.received_qty},x=c.accepted_qty,m=Math.max(0,t.received_qty-x),O=`item_${t.po_item_receipt_id}`;return e.jsxs("div",{className:"p-3 rounded-md border bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium",children:[t.item_code," - ",t.item_name]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Received: ",t.received_qty," ",t.uom]})]}),e.jsx("span",{className:`text-[10px] rounded-full px-1.5 py-0.5 font-medium ${t.qc_status===z.ACCEPTED?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":t.qc_status===z.REJECTED?"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400":"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300"}`,children:t.qc_status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Accepted Qty"}),e.jsx(p,{type:"number",min:0,max:t.received_qty,step:"any",value:x,onChange:y=>H(s.po_receipt_id,t.po_item_receipt_id,y.target.value),className:"h-8 text-sm"}),N[O]&&e.jsx("p",{className:"text-xs text-destructive",children:N[O]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Rejected Qty"}),e.jsx(p,{type:"number",value:m.toFixed(3),readOnly:!0,disabled:!0,className:"h-8 text-sm bg-muted"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:grid-cols-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Unit Price"}),e.jsx(p,{type:"number",min:0,step:"any",value:c.unit_price??"",onChange:y=>{const D=y.target.value;R(s.po_receipt_id,t.po_item_receipt_id,"unit_price",D===""?void 0:parseFloat(D)||0)},placeholder:"0.00",className:"h-8 text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Tax Code"}),e.jsx(p,{value:c.tax_code??"",onChange:y=>R(s.po_receipt_id,t.po_item_receipt_id,"tax_code",y.target.value||void 0),placeholder:"e.g. GST18",className:"h-8 text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"G/L Account"}),e.jsx(p,{value:c.gl_account??"",onChange:y=>R(s.po_receipt_id,t.po_item_receipt_id,"gl_account",y.target.value||void 0),placeholder:"Account code",className:"h-8 text-sm"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Variety"}),e.jsx(p,{value:c.variety??"",onChange:y=>R(s.po_receipt_id,t.po_item_receipt_id,"variety",y.target.value||void 0),placeholder:"e.g. TMT-500D",className:"h-8 text-sm"})]})]})]},t.po_item_receipt_id)})]}),e.jsxs("div",{className:"border-t pt-4 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{className:"text-xs",children:"Vendor Reference"}),e.jsx(p,{value:a.vendorRef,onChange:t=>J(s.po_receipt_id,t.target.value),placeholder:"Invoice / challan number",className:"h-8 text-sm"})]}),e.jsx(_e,{label:"Warehouse Code",value:a.warehouseCode,onChange:t=>K(s.po_receipt_id,t),placeholder:"Select warehouse"}),e.jsxs("div",{className:"space-y-1 sm:col-span-2",children:[e.jsx(h,{className:"text-xs",children:"Comments"}),e.jsx(p,{value:a.comments,onChange:t=>M(s.po_receipt_id,t.target.value),placeholder:"Optional remarks",className:"h-8 text-sm"})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsx(ge,{charges:a.extraCharges,onChange:t=>X(s.po_receipt_id,t)})}),e.jsxs("div",{className:"border-t pt-4 flex justify-end gap-2",children:[e.jsx(j,{variant:"outline",size:"sm",onClick:()=>g("/grpo/pending"),children:"Cancel"}),e.jsx(j,{size:"sm",onClick:()=>Z(s),disabled:i.isPending,children:i.isPending?"Posting...":"Post GRPO"})]})]})]})},s.po_receipt_id)}),e.jsx(T,{open:!!o,onOpenChange:()=>S(null),children:e.jsxs(L,{className:"max-w-md",children:[e.jsxs(G,{children:[e.jsx(I,{children:"Confirm GRPO Posting"}),e.jsx($,{children:"Review the details below before posting to SAP."})]}),o&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"PO:"})," ",e.jsx("span",{className:"font-medium",children:o.po_number})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Supplier:"})," ",e.jsx("span",{className:"font-medium",children:o.supplier_name})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Branch ID:"})," ",e.jsx("span",{className:"font-medium",children:o.branch_id||U})]}),(()=>{const s=b(o);return e.jsxs(e.Fragment,{children:[s.vendorRef&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Vendor Ref:"})," ",e.jsx("span",{className:"font-medium",children:s.vendorRef})]}),s.warehouseCode&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Warehouse:"})," ",e.jsx("span",{className:"font-medium",children:s.warehouseCode})]})]})})(),e.jsx("div",{className:"border-t pt-3 space-y-2",children:o.items.map(s=>{const t=b(o).items[s.po_item_receipt_id]?.accepted_qty??s.received_qty;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:s.item_name}),e.jsxs("span",{className:"font-medium",children:[t," ",s.uom]})]},s.po_item_receipt_id)})}),(()=>{const s=b(o);if(s.extraCharges.length===0)return null;const r=s.extraCharges.reduce((a,t)=>a+(t.amount||0),0);return e.jsxs("div",{className:"border-t pt-3 text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Extra Charges:"})," ",e.jsxs("span",{className:"font-medium",children:[s.extraCharges.length," charge(s), total"," ",r.toLocaleString("en-IN",{style:"currency",currency:"INR"})]})]})})()]}),e.jsxs(V,{children:[e.jsx(j,{variant:"outline",onClick:()=>S(null),children:"Cancel"}),e.jsx(j,{onClick:ee,disabled:i.isPending,children:i.isPending?"Posting...":"Confirm Post"})]})]})}),e.jsx(T,{open:!!F,onOpenChange:()=>q(null),children:e.jsxs(L,{className:"max-w-sm",children:[e.jsxs(G,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-green-600"}),"Success"]}),e.jsx($,{children:"GRPO posted successfully to SAP."})]}),F&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"SAP Document Number"}),e.jsx("span",{className:"font-semibold",children:F.sap_doc_num})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Value"}),e.jsx("span",{className:"font-semibold",children:F.sap_doc_total?.toLocaleString("en-IN",{style:"currency",currency:"INR"})})]})]}),e.jsxs(V,{className:"flex-col gap-2 sm:flex-col",children:[e.jsx(j,{variant:"outline",className:"w-full",onClick:()=>{q(null),g("/grpo/history")},children:"View History"}),e.jsx(j,{className:"w-full",onClick:()=>{q(null),d()},children:"Done"})]})]})})]})}export{Ae as default};
