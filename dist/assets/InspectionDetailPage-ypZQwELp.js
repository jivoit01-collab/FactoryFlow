import{y as de,F as Se,G as Pe,al as Ie,r as y,au as b,a as Re,Q as Oe,j as e,B as E,at as Te,J as P,C as q,b as H,c as $,e as W,L as x,I as v,ar as le}from"./index-Dm3Xfjnt.js";import{F as D}from"./status.constants-7P9dQP1S.js";import{u as Me}from"./useScrollToError-uCbWP-L8.js";import{u as Fe}from"./useMutation-C59p_qU8.js";import{c as Le,d as Be,e as De,f as Ve,g as Qe,h as Ue,i as Ge}from"./inspection.queries-D2PHidgF.js";import{u as qe,M as He}from"./MaterialTypeSelect-BadZ-Cga.js";import{a as O,W as K,F as z}from"./qc.constants-BchmX-Kf.js";import{A as ce}from"./arrow-left-RhgS-m-T.js";import{C as $e}from"./circle-alert-CkjslOaL.js";import{F as We}from"./file-text-BURbwi2j.js";import{C as oe}from"./circle-check-4K5RQOA0.js";import{C as Ke}from"./circle-x-gTIzRI_j.js";import{S as ze}from"./send-DUKN0Er9.js";import"./triangle-alert-C6MTrmF-.js";import"./clock-xVG4dxTu.js";import"./SearchableSelect-kktrv1CU.js";import"./plus-dJ8NaNTB.js";import"./materialType.queries-DTWaJOtO.js";import"./user-check-DTF_egBE.js";const Je=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],Ye=de("pencil",Je);const Xe=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],Ze=de("save",Xe),es={async getById(o){return(await Se.get(Pe.QUALITY_CONTROL_V2.ARRIVAL_SLIP_BY_ID(o))).data}},ue={all:["qc-arrivalSlips"],detail:o=>[...ue.all,"detail",o]};function ss(o){return Fe({queryKey:ue.detail(o),queryFn:()=>es.getById(o),enabled:!!o})}function as(o){const{hasAnyPermission:N}=Ie();return y.useMemo(()=>{const V=N([b.INSPECTION.CREATE]),A=N([b.INSPECTION.CREATE,b.INSPECTION.EDIT]),w=N([b.INSPECTION.SUBMIT]),k=N([b.APPROVAL.APPROVE_AS_CHEMIST]),T=N([b.APPROVAL.APPROVE_AS_QAM]),a=N([b.APPROVAL.REJECT,b.APPROVAL.APPROVE_AS_CHEMIST,b.APPROVAL.APPROVE_AS_QAM]),M=!o||o.workflow_status===O.DRAFT,_=o?.workflow_status===O.SUBMITTED,Q=o?.workflow_status===O.QA_CHEMIST_APPROVED,l=o?.is_locked??!1,F=o?.workflow_status===O.QAM_APPROVED||o?.workflow_status===O.REJECTED;return{canCreateInspection:V,canEditInspection:A,canSubmitInspection:w,canApproveAsChemist:k,canApproveAsQAM:T,canReject:a,showSaveButton:!l&&M&&A,showSubmitButton:o&&M&&!l&&w,showChemistApproval:_&&k,showQAMApproval:Q&&T,showRejectButton:(_||Q)&&a,canEditFields:!l&&M&&A,isCompleted:F,isLocked:l}},[o,N])}function bs(){const o=Re(),{slipId:N,inspectionId:V}=Oe(),A=window.location.pathname.includes("/new"),w=N?parseInt(N):V?parseInt(V):null,[k,T]=y.useState(!1),{data:a,isLoading:M}=Le(w),{data:_,isLoading:Q}=ss(A&&!a?w:null),[l,F]=y.useState({inspection_date:new Date().toISOString().split("T")[0],description_of_material:"",sap_code:"",supplier_name:"",manufacturer_name:"",supplier_batch_lot_no:"",unit_packing:"",purchase_order_no:"",invoice_bill_no:"",vehicle_no:"",material_type_id:0,remarks:""}),[L,J]=y.useState({}),[B,me]=y.useState(""),[Y,pe]=y.useState(D.ACCEPTED),[m,h]=y.useState({});Me(m);const{data:I=[]}=qe(l.material_type_id||null),X=Be(),Z=De(),ee=Ve(),se=Qe(),ae=Ue(),te=Ge();y.useEffect(()=>{if(a){F({inspection_date:a.inspection_date,description_of_material:a.description_of_material,sap_code:a.sap_code,supplier_name:a.supplier_name,manufacturer_name:a.manufacturer_name,supplier_batch_lot_no:a.supplier_batch_lot_no,unit_packing:a.unit_packing,purchase_order_no:a.purchase_order_no,invoice_bill_no:a.invoice_bill_no,vehicle_no:a.vehicle_no,material_type_id:a.material_type,remarks:a.remarks});const s={};a.parameter_results?.forEach(t=>{s[t.parameter_master]={result_value:t.result_value,result_numeric:t.result_numeric||void 0,is_within_spec:t.is_within_spec??void 0,remarks:t.remarks}}),J(s)}},[a]),y.useEffect(()=>{_&&!a&&A&&F(s=>({...s,description_of_material:_.item_name||s.description_of_material,sap_code:_.po_item_code||s.sap_code,supplier_name:_.party_name||s.supplier_name,unit_packing:_.billing_qty&&_.billing_uom?`${_.billing_qty} ${_.billing_uom}`:s.unit_packing,vehicle_no:_.truck_no_as_per_bill||s.vehicle_no,invoice_bill_no:_.commercial_invoice_no||s.invoice_bill_no,remarks:_.remarks||s.remarks}))},[_,a,A]);const j=(s,t)=>{F(u=>({...u,[s]:t})),m[s]&&h(u=>{const n={...u};return delete n[s],n})},C=(s,t,u)=>{J(r=>({...r,[s]:{...r[s],result_value:r[s]?.result_value||"",remarks:r[s]?.remarks||"",[t]:u}}));const n=`param_${s}`;m[n]&&h(r=>{const p={...r};return delete p[n],p})},U=(s,t,u,n,r)=>{if(C(s,"result_value",t),u==="NUMERIC"||u==="RANGE"){const p=parseFloat(t);if(!isNaN(p)&&(C(s,"result_numeric",p),u==="RANGE"&&n!=null&&r!=null)){const R=typeof n=="string"?parseFloat(n):n,S=typeof r=="string"?parseFloat(r):r;!isNaN(R)&&!isNaN(S)&&C(s,"is_within_spec",p>=R&&p<=S)}}else u==="BOOLEAN"&&C(s,"is_within_spec",t==="Pass")},re=s=>{switch(s){case"NUMERIC":return"Enter numeric value";case"RANGE":return"Enter numeric value";case"BOOLEAN":return"Select Pass or Fail";default:return"Enter text value"}},_e=async()=>{if(w)try{h({});const s={};l.material_type_id||(s.material_type_id="Please select a material type"),l.supplier_batch_lot_no?.trim()||(s.supplier_batch_lot_no="Supplier Batch/Lot No. is required"),l.purchase_order_no?.trim()||(s.purchase_order_no="Purchase Order No. is required");const t=I.filter(n=>n.is_mandatory);for(const n of t)L[n.id]?.result_value?.trim()||(s[`param_${n.id}`]=`${n.parameter_name} result is required`);if(Object.keys(s).length>0){h(s);return}let u=a?.id;if(a||(u=(await X.mutateAsync({slipId:w,data:l})).id),u&&Object.keys(L).length>0){const n=Object.entries(L).map(([r,p])=>({parameter_master_id:parseInt(r),result_value:p.result_value||"",result_numeric:p.result_numeric,is_within_spec:p.is_within_spec??!0,remarks:p.remarks||""}));await Z.mutateAsync({inspectionId:u,results:n})}T(!1)}catch(s){h({general:s.message||"Failed to save inspection"})}},he=async()=>{if(!a){h({general:"Please save the inspection first"});return}try{h({}),await ee.mutateAsync(a.id)}catch(s){h({general:s.message||"Failed to submit inspection"})}},xe=async()=>{if(a)try{h({}),await se.mutateAsync({id:a.id,data:{remarks:B}})}catch(s){h({general:s.message||"Failed to approve"})}},ve=async()=>{if(a)try{h({}),await ae.mutateAsync({id:a.id,data:{remarks:B,final_status:Y}})}catch(s){h({general:s.message||"Failed to approve"})}},je=async()=>{if(a){if(!B.trim()){h({approval_remarks:"Please provide a reason for rejection"});return}try{h({}),await te.mutateAsync({id:a.id,data:{remarks:B}})}catch(s){h({general:s.message||"Failed to reject"})}}},{canEditInspection:Ne,showSubmitButton:fe,showChemistApproval:ge,showQAMApproval:be,showRejectButton:ye,canEditFields:Ae,isLocked:Ce}=as(a),Ee=!a||a.workflow_status===O.DRAFT,c=Ae&&(!a||k),we=a&&Ee&&Ne&&!k&&!Ce,ke=fe&&!k,ie=ge,G=be,ne=ye,i=X.isPending||Z.isPending||ee.isPending||se.isPending||ae.isPending||te.isPending;return M||Q?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>o("/qc/pending"),children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsxs("h2",{className:"text-3xl font-bold tracking-tight flex items-center gap-3",children:[e.jsx(Te,{className:"h-8 w-8"}),A?"New Inspection":"Inspection Details"]})]}),a&&e.jsxs("div",{className:"flex items-center gap-4 ml-10",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Report No: ",a.report_no]}),e.jsx("span",{className:P("px-2 py-1 rounded-full text-xs font-medium",K[a.workflow_status].bgColor,K[a.workflow_status].color),children:K[a.workflow_status].label}),a.final_status!==D.PENDING&&e.jsx("span",{className:P("px-2 py-1 rounded-full text-xs font-medium",z[a.final_status].bgColor,z[a.final_status].color),children:z[a.final_status].label})]})]})}),m.general&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),m.general]}),e.jsxs(q,{children:[e.jsx(H,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-5 w-5"}),"Inspection Information"]})}),e.jsx(W,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Description of Material"}),e.jsx(v,{value:l.description_of_material||"",onChange:s=>j("description_of_material",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"SAP Code"}),e.jsx(v,{value:l.sap_code||"",onChange:s=>j("sap_code",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Supplier Name"}),e.jsx(v,{value:l.supplier_name||"",onChange:s=>j("supplier_name",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Unit Packing"}),e.jsx(v,{value:l.unit_packing||"",onChange:s=>j("unit_packing",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Vehicle No."}),e.jsx(v,{value:l.vehicle_no||"",onChange:s=>j("vehicle_no",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Invoice/Bill No."}),e.jsx(v,{value:l.invoice_bill_no||"",onChange:s=>j("invoice_bill_no",s.target.value),disabled:!c||i})]}),e.jsx(He,{label:"Material Type",required:!0,value:l.material_type_id||void 0,onChange:s=>j("material_type_id",s?.id||0),disabled:!c||i||!!a,error:m.material_type_id}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Inspection Date"}),e.jsx(v,{type:"date",value:l.inspection_date||"",onChange:s=>j("inspection_date",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Manufacturer Name"}),e.jsx(v,{value:l.manufacturer_name||"",onChange:s=>j("manufacturer_name",s.target.value),disabled:!c||i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{children:["Supplier Batch/Lot No. ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{value:l.supplier_batch_lot_no||"",onChange:s=>j("supplier_batch_lot_no",s.target.value),disabled:!c||i,className:m.supplier_batch_lot_no?"border-destructive":""}),m.supplier_batch_lot_no&&e.jsx("p",{className:"text-sm text-destructive",children:m.supplier_batch_lot_no})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{children:["Purchase Order No. ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(v,{value:l.purchase_order_no||"",onChange:s=>j("purchase_order_no",s.target.value),disabled:!c||i,className:m.purchase_order_no?"border-destructive":""}),m.purchase_order_no&&e.jsx("p",{className:"text-sm text-destructive",children:m.purchase_order_no})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx(x,{children:"Remarks"}),e.jsx(le,{value:l.remarks||"",onChange:s=>j("remarks",s.target.value),disabled:!c||i,rows:2})]})]})})]}),((a?.parameter_results?.length??0)>0||I.length>0)&&e.jsxs(q,{children:[e.jsx(H,{children:e.jsx($,{children:"QC Parameters"})}),e.jsxs(W,{children:[e.jsx("div",{className:"md:hidden space-y-4",children:(a?.parameter_results||I).map(s=>{const t="parameter_master"in s?s.parameter_master:s.id,u=s.parameter_name,n=s.standard_value,r=s.parameter_type,p=s.min_value,R=s.max_value,S="is_mandatory"in s?s.is_mandatory:I.find(d=>d.id===t)?.is_mandatory??!1,f=m[`param_${t}`],g=L[t]||{result_value:"",is_within_spec:!0,remarks:""};return e.jsxs("div",{className:P("border rounded-lg p-3 space-y-3",f&&"border-destructive"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-medium text-sm",children:[u,S&&e.jsx("span",{className:"text-destructive",children:" *"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:g.is_within_spec??!0,onChange:d=>C(t,"is_within_spec",d.target.checked),disabled:!c||i||r==="BOOLEAN"||r==="RANGE",className:"h-4 w-4 rounded border-gray-300"}),e.jsx("span",{className:"text-muted-foreground",children:"Within Spec"})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Standard: ",n]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(x,{className:"text-xs",children:["Result",S&&e.jsx("span",{className:"text-destructive",children:" *"})]}),r==="BOOLEAN"?e.jsxs("select",{value:g.result_value,onChange:d=>U(t,d.target.value,r),disabled:!c||i,className:P("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",f&&"border-destructive"),children:[e.jsx("option",{value:"",children:"Select Pass or Fail"}),e.jsx("option",{value:"Pass",children:"Pass"}),e.jsx("option",{value:"Fail",children:"Fail"})]}):e.jsx(v,{type:r==="NUMERIC"||r==="RANGE"?"number":"text",step:r==="NUMERIC"||r==="RANGE"?"any":void 0,value:g.result_value,onChange:d=>U(t,d.target.value,r,p,R),disabled:!c||i,className:P("w-full",f&&"border-destructive"),placeholder:re(r)}),f&&e.jsx("p",{className:"text-xs text-destructive",children:f})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(x,{className:"text-xs",children:"Remarks"}),e.jsx(v,{value:g.remarks,onChange:d=>C(t,"remarks",d.target.value),disabled:!c||i,className:"w-full",placeholder:"Optional"})]})]},t)})}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"text-left p-3 font-medium",children:"Parameter"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Standard Value"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Result"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"Within Spec"}),e.jsx("th",{className:"text-left p-3 font-medium",children:"Remarks"})]})}),e.jsx("tbody",{children:(a?.parameter_results||I).map(s=>{const t="parameter_master"in s?s.parameter_master:s.id,u=s.parameter_name,n=s.standard_value,r=s.parameter_type,p=s.min_value,R=s.max_value,S="is_mandatory"in s?s.is_mandatory:I.find(d=>d.id===t)?.is_mandatory??!1,f=m[`param_${t}`],g=L[t]||{result_value:"",is_within_spec:!0,remarks:""};return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"p-3",children:e.jsxs("span",{className:"font-medium",children:[u,S&&e.jsx("span",{className:"text-destructive",children:" *"})]})}),e.jsx("td",{className:"p-3 text-muted-foreground",children:n}),e.jsxs("td",{className:"p-3",children:[r==="BOOLEAN"?e.jsxs("select",{value:g.result_value,onChange:d=>U(t,d.target.value,r),disabled:!c||i,className:P("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",f&&"border-destructive"),children:[e.jsx("option",{value:"",children:"Select Pass or Fail"}),e.jsx("option",{value:"Pass",children:"Pass"}),e.jsx("option",{value:"Fail",children:"Fail"})]}):e.jsx(v,{type:r==="NUMERIC"||r==="RANGE"?"number":"text",step:r==="NUMERIC"||r==="RANGE"?"any":void 0,value:g.result_value,onChange:d=>U(t,d.target.value,r,p,R),disabled:!c||i,className:P("w-full",f&&"border-destructive"),placeholder:re(r)}),f&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:f})]}),e.jsx("td",{className:"p-3 text-center",children:e.jsx("input",{type:"checkbox",checked:g.is_within_spec??!0,onChange:d=>C(t,"is_within_spec",d.target.checked),disabled:!c||i||r==="BOOLEAN"||r==="RANGE",className:"h-4 w-4 rounded border-gray-300"})}),e.jsx("td",{className:"p-3",children:e.jsx(v,{value:g.remarks,onChange:d=>C(t,"remarks",d.target.value),disabled:!c||i,className:"w-full",placeholder:"Optional"})})]},t)})})]})})]})]}),(ie||G||ne)&&e.jsxs(q,{className:"border-primary/50",children:[e.jsx(H,{children:e.jsx($,{children:"Approval"})}),e.jsxs(W,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Remarks"}),e.jsx(le,{value:B,onChange:s=>me(s.target.value),placeholder:"Enter approval/rejection remarks",rows:3}),m.approval_remarks&&e.jsx("p",{className:"text-sm text-destructive",children:m.approval_remarks})]}),G&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Final Status"}),e.jsxs("select",{className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:Y,onChange:s=>pe(s.target.value),children:[e.jsx("option",{value:D.ACCEPTED,children:"Accepted"}),e.jsx("option",{value:D.REJECTED,children:"Rejected"}),e.jsx("option",{value:D.HOLD,children:"Hold"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[ie&&e.jsxs(E,{onClick:xe,disabled:i,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Approve as Chemist"]}),G&&e.jsxs(E,{onClick:ve,disabled:i,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Approve as Manager"]}),ne&&e.jsxs(E,{variant:"destructive",onClick:je,disabled:i,children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]})]}),e.jsxs("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:justify-between",children:[e.jsxs(E,{variant:"outline",onClick:()=>o("/qc/pending"),children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsxs("div",{className:"flex gap-4",children:[we&&e.jsxs(E,{variant:"outline",onClick:()=>T(!0),children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Update"]}),c&&e.jsxs(E,{onClick:_e,disabled:i,children:[e.jsx(Ze,{className:"h-4 w-4 mr-2"}),i?"Saving...":"Save"]}),ke&&!k&&e.jsxs(E,{onClick:he,disabled:i,children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Submit for Approval"]})]})]})]})}export{bs as default};
