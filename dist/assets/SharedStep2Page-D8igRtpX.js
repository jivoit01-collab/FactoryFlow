import{y as W,j as e,B as j,C as Z,b as J,c as X,e as ee,L as b,M as p,I as E,K as D,a as te,r as y}from"./index-C2mIzQGa.js";import{E as se}from"./status.constants-z4kJtZ2y.js";import{g as ie,a as re,V as $,T as le}from"./vehicle.constants-Cygh0PaO.js";import{i as ne,a as ae,g as oe,b as de}from"./error-qMYEww3Q.js";import{a as ce,u as ue}from"./useMutation-BgZEu4WU.js";import{s as H}from"./securityCheck.api-DPVelv5D.js";import{a as me}from"./vehicleEntry.queries-DXGsKb_A.js";import{W as he}from"./wizard.constants-DfnuBX7K.js";import"./driver.schema-DZt_XaHY.js";import"./vehicle.schema-BmxwMEOL.js";import{u as xe}from"./useScrollToError-BArmGyd9.js";import{C as L}from"./circle-alert-CaWuRL_0.js";import{C as fe}from"./clock-RFu7WkNY.js";import{u as be}from"./useEntryId-B2S9w5kc.js";const ve=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],pe=W("shield",ve);function Y(s){const i=s.getHours().toString().padStart(2,"0"),n=s.getMinutes().toString().padStart(2,"0");return`${i}:${n}`}function ye(s){try{const i=new Date(s);return isNaN(i.getTime())?null:Y(i)}catch{return null}}function I(){return Y(new Date)}function Ne(s){return ye(s)||""}const ge=s=>{if(!s)return"";const[i,n]=s.split(":"),u=parseInt(i)%12||12,r=parseInt(i)>=12?"PM":"AM";return`${u}:${n} ${r}`};function je({formData:s,onFormChange:i,isReadOnly:n,isLoading:u,isSaving:r,apiErrors:t,currentStep:T,totalSteps:C,onPrevious:o,onCancel:B,onNext:N,onUpdate:w,isEditMode:_,canUpdate:F,updateMode:g,showFillDataAlert:q=!1,onFillData:A,fillDataMessage:M="Security check not found",serverError:d,headerTitle:k="Material Inward"}){const S=T/C*100;return xe(t),u?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h2",{className:"text-3xl font-bold tracking-tight",children:[k," - Step ",T," of ",C]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${S}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground min-w-[3rem]",children:[Math.round(S),"%"]})]})]}),(d||t.general)&&e.jsxs("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),d||t.general]}),q&&A&&e.jsx("div",{className:"rounded-md bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-400"}),e.jsx("p",{className:"text-sm font-medium text-yellow-800 dark:text-yellow-200",children:M})]}),e.jsx(j,{size:"sm",variant:"outline",onClick:A,children:"Fill Data"})]})}),e.jsx("div",{className:"space-y-6",children:e.jsxs(Z,{children:[e.jsx(J,{children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Security Checks"]})}),e.jsxs(ee,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"vehicleCondition",children:["Vehicle Condition ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{id:"vehicleCondition",className:p("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t.vehicleCondition&&"border-destructive"),value:s.vehicleCondition,onChange:l=>i("vehicleCondition",l.target.value),disabled:n||r,children:[e.jsx("option",{value:"",children:"Select condition"}),e.jsx("option",{value:"Empty",children:"Empty"}),e.jsx("option",{value:"Loaded",children:"Loaded"}),e.jsx("option",{value:"Partially Loaded",children:"Partially Loaded"})]}),t.vehicleCondition&&e.jsx("p",{className:"text-sm text-destructive",children:t.vehicleCondition}),t.vehicle_condition_ok&&e.jsx("p",{className:"text-sm text-destructive",children:t.vehicle_condition_ok})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"fireExtinguisherAvailable",children:["Fire Extinguisher Available ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{id:"fireExtinguisherAvailable",className:p("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t.fireExtinguisherAvailable&&"border-destructive"),value:s.fireExtinguisherAvailable,onChange:l=>i("fireExtinguisherAvailable",l.target.value),disabled:n||r,children:[e.jsx("option",{value:"",children:"Select option"}),e.jsx("option",{value:"Yes",children:"Yes"}),e.jsx("option",{value:"No",children:"No"})]}),t.fireExtinguisherAvailable&&e.jsx("p",{className:"text-sm text-destructive",children:t.fireExtinguisherAvailable}),t.fire_extinguisher_available&&e.jsx("p",{className:"text-sm text-destructive",children:t.fire_extinguisher_available})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"tyreCondition",children:["Tyre Condition ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("select",{id:"tyreCondition",className:p("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t.tyreCondition&&"border-destructive"),value:s.tyreCondition,onChange:l=>i("tyreCondition",l.target.value),disabled:n||r,children:[e.jsx("option",{value:"",children:"Select condition"}),e.jsx("option",{value:"Good",children:"Good"}),e.jsx("option",{value:"Fair",children:"Fair"}),e.jsx("option",{value:"Poor",children:"Poor"}),e.jsx("option",{value:"Needs Replacement",children:"Needs Replacement"})]}),t.tyreCondition&&e.jsx("p",{className:"text-sm text-destructive",children:t.tyreCondition}),t.tyre_condition_ok&&e.jsx("p",{className:"text-sm text-destructive",children:t.tyre_condition_ok})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"sealNumberBefore",children:"Seal Number (Before)"}),e.jsx(E,{id:"sealNumberBefore",placeholder:"Enter seal number",value:s.sealNumberBefore,onChange:l=>i("sealNumberBefore",l.target.value),disabled:n||r,className:p(t.sealNumberBefore||t.seal_no_before?"border-destructive":"")}),t.sealNumberBefore&&e.jsx("p",{className:"text-sm text-destructive",children:t.sealNumberBefore}),t.seal_no_before&&e.jsx("p",{className:"text-sm text-destructive",children:t.seal_no_before})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"sealNumberAfter",children:"Seal Number (After)"}),e.jsx(E,{id:"sealNumberAfter",placeholder:"Enter seal number after inspection",value:s.sealNumberAfter,onChange:l=>i("sealNumberAfter",l.target.value),disabled:n||r,className:p(t.seal_no_after?"border-destructive":"")}),t.seal_no_after&&e.jsx("p",{className:"text-sm text-destructive",children:t.seal_no_after})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"alcoholTestRequired",children:"Alcohol Test Required"}),e.jsxs("select",{id:"alcoholTestRequired",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:s.alcoholTestRequired,onChange:l=>i("alcoholTestRequired",l.target.value),disabled:n||r,children:[e.jsx("option",{value:"Not Required",children:"Not Required"}),e.jsx("option",{value:"Required",children:"Required"}),e.jsx("option",{value:"Passed",children:"Passed"}),e.jsx("option",{value:"Failed",children:"Failed"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"entryTime",children:["Entry Time ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(E,{id:"entryTime",type:"time",value:s.entryTime,onChange:l=>i("entryTime",l.target.value),disabled:n||r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"inspectedByName",children:["Inspected By Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(E,{id:"inspectedByName",placeholder:"Enter inspector name",value:s.inspectedByName,onChange:l=>i("inspectedByName",l.target.value),disabled:n||r,className:p(t.inspectedByName||t.inspected_by_name?"border-destructive":"")}),t.inspectedByName&&e.jsx("p",{className:"text-sm text-destructive",children:t.inspectedByName}),t.inspected_by_name&&e.jsx("p",{className:"text-sm text-destructive",children:t.inspected_by_name})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(b,{htmlFor:"remarks",children:"Remarks"}),e.jsx("textarea",{id:"remarks",rows:3,className:p("flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t.remarks&&"border-destructive"),placeholder:"Enter any additional remarks...",value:s.remarks,onChange:l=>i("remarks",l.target.value),disabled:n||r}),t.remarks&&e.jsx("p",{className:"text-sm text-destructive",children:t.remarks})]})]}),e.jsx("div",{className:"mt-4 rounded-md bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:"Entry Time (Auto-captured)"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:ge(s.entryTime)})]})]})})]})]})}),e.jsxs("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:justify-end",children:[e.jsx(j,{type:"button",variant:"outline",onClick:o,children:"← Previous"}),e.jsx(j,{type:"button",variant:"outline",onClick:B,children:"Cancel"}),_?e.jsxs(e.Fragment,{children:[F&&!g&&w&&e.jsx(j,{type:"button",onClick:w,children:"Update"}),e.jsx(j,{type:"button",onClick:N,disabled:r,children:g?r?"Saving...":"Save and Next →":"Next →"})]}):e.jsx(j,{type:"button",onClick:N,disabled:r,children:r?"Saving...":"Save and Next →"})]})]})}function Ce(s){return ue({queryKey:["securityCheck",s],queryFn:()=>H.get(s),enabled:!!s})}function _e(s){const i=D();return ce({mutationFn:n=>H.create(s,n),onSuccess:()=>{i.invalidateQueries({queryKey:["securityCheck"]}),i.invalidateQueries({queryKey:["vehicleEntries"]}),i.invalidateQueries({queryKey:["gateEntryFullView"]})}})}function Le({config:s}){const i=te(),n=D(),{entryId:u,entryIdNumber:r,isEditMode:t}=be(),T=s.totalSteps===5?he.STEPS.SECURITY_CHECK:2,C=_e(r||0),{data:o,isLoading:B,error:N}=Ce(t&&r?r:null),{data:w}=me(t&&r?r:null),[_,F]=y.useState(!1),[g,q]=y.useState(!1),[A,M]=y.useState(!1),d=t&&!_,k=ne(N),S=ae(N),l=d&&!g&&!k||k&&!_,K=d&&w?.status!==se.COMPLETED,[a,P]=y.useState({vehicleCondition:"",fireExtinguisherAvailable:"",tyreCondition:"",sealNumberBefore:"",sealNumberAfter:"",alcoholTestRequired:"Not Required",entryTime:"",inspectedByName:"",remarks:""}),[R,x]=y.useState({});y.useEffect(()=>{d||P(c=>({...c,entryTime:I()}))},[d]),y.useEffect(()=>{if(d&&o){const c=ie(o.vehicle_condition_ok),f=re(o.tyre_condition_ok),m=o.fire_extinguisher_available?"Yes":"No";let h="Not Required";o.alcohol_test_done&&(h=o.alcohol_test_passed?"Passed":"Failed");let v="";o.inspection_time&&(v=Ne(o.inspection_time)||I()),P({vehicleCondition:c,fireExtinguisherAvailable:m,tyreCondition:f,sealNumberBefore:o.seal_no_before||"",sealNumberAfter:o.seal_no_after||"",alcoholTestRequired:h,entryTime:v,inspectedByName:o.inspected_by_name||"",remarks:o.remarks||""})}},[d,o]);const V=(c,f)=>{P(m=>({...m,[c]:f})),R[c]&&x(m=>{const h={...m};return delete h[c],h})},Q=()=>{i(t&&u?`${s.routePrefix}/edit/${u}/step1`:`${s.routePrefix}/new`)},U=()=>{n.invalidateQueries({queryKey:["vehicleEntries"]}),i(s.routePrefix)},O=()=>{F(!0),P(c=>({...c,entryTime:I()}))},G=()=>{q(!0)},z=async()=>{if(!u){x({general:"Entry ID is missing. Please go back to step 1."});return}if(d&&!g){i(`${s.routePrefix}/edit/${u}/step3`);return}if(x({}),!a.vehicleCondition){x({vehicleCondition:"Please select vehicle condition"});return}if(!a.fireExtinguisherAvailable){x({fireExtinguisherAvailable:"Please select fire extinguisher availability"});return}if(!a.tyreCondition){x({tyreCondition:"Please select tyre condition"});return}if(!a.inspectedByName){x({inspectedByName:"Please enter inspector name"});return}try{const c=a.vehicleCondition===$.EMPTY||a.vehicleCondition===$.LOADED,f=a.tyreCondition===le.GOOD||a.tyreCondition==="Fair",m=a.fireExtinguisherAvailable==="Yes",h=a.alcoholTestRequired!=="Not Required",v=a.alcoholTestRequired==="Passed";await C.mutateAsync({vehicle_condition_ok:c,tyre_condition_ok:f,fire_extinguisher_available:m,seal_no_before:a.sealNumberBefore||"",seal_no_after:a.sealNumberAfter||void 0,alcohol_test_done:h,alcohol_test_passed:h?v:void 0,inspected_by_name:a.inspectedByName,remarks:a.remarks||void 0}),M(!0),i(t?`${s.routePrefix}/edit/${u}/step3`:`${s.routePrefix}/new/step3?entryId=${u}`)}catch(c){const f=c;if(f.errors){const m={};Object.entries(f.errors).forEach(([h,v])=>{Array.isArray(v)&&v.length>0&&(m[h]=v[0])}),x(m)}else x({general:f.message||"Failed to save security checks"})}};return e.jsx(je,{formData:a,onFormChange:V,isReadOnly:l,isLoading:d&&B,isSaving:C.isPending||A,apiErrors:R,currentStep:T,totalSteps:s.totalSteps,onPrevious:Q,onCancel:U,onNext:z,onUpdate:G,isEditMode:d,canUpdate:K,updateMode:g,showFillDataAlert:d&&k&&!_,onFillData:O,fillDataMessage:de(N,"Security check not found"),serverError:S?oe():null,headerTitle:s.headerTitle})}export{Le as S};
