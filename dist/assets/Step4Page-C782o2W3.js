import{H as C,J as M,K as I,a as B,r as u,j as e,C as J,b as Y,c as Z,e as z,L as f,I as x,M as v}from"./index-F6OBckJL.js";import{E as X}from"./status.constants-CKMj_z5Z.js";import{i as ee,a as te,g as ie,b as D}from"./error-qMYEww3Q.js";import{u as se}from"./useScrollToError-qt_-pvL9.js";import{a as re}from"./vehicleEntry.queries-BuZTdfbx.js";import{a as ae,u as ne}from"./useMutation-T_ZIEmkq.js";import{F as oe}from"./FillDataAlert-CJKpK4EC.js";import{S as ce}from"./StepFooter-ZgbD6JqJ.js";import{S as de}from"./StepHeader-Cpn-j-Of.js";import{S as ge}from"./StepLoadingSpinner-k9cM7DBp.js";import"./driver.schema-DZt_XaHY.js";import"./vehicle.schema-BmxwMEOL.js";import{W as me}from"./wizard.constants-DfnuBX7K.js";import{u as le}from"./useEntryId-DsmGe3N_.js";import{S as he}from"./scale-BIhQedGq.js";import"./triangle-alert-BmmP914E.js";import"./circle-x-DzWBPv38.js";import"./circle-check-wmO4DyML.js";import"./clock-Dx5ax5P4.js";import"./circle-alert-DlEMDmI_.js";import"./arrow-left-ETA-Rmsf.js";import"./validation.constants-C18ePHzl.js";import"./schemas-D8ebsZBL.js";const k={async get(s){const n=await C.get(M.WEIGHMENT.GET(s));return Array.isArray(n.data)?n.data.length===0?null:n.data[0]:n.data},async create(s,n){return(await C.post(M.WEIGHMENT.CREATE(s),n)).data}};function ue(s){return ne({queryKey:["weighment",s],queryFn:()=>k.get(s),enabled:!!s})}function pe(s){const n=I();return ae({mutationFn:c=>k.create(s,c),onSuccess:()=>{n.invalidateQueries({queryKey:["weighment"]}),n.invalidateQueries({queryKey:["gateEntryFullView"]})}})}function Oe(){const s=B(),n=I(),{entryId:c,entryIdNumber:w,isEditMode:p}=le(),A=me.STEPS.WEIGHMENT,l=pe(w||0),{data:a,isLoading:F,error:T}=ue(p&&w?w:null),{data:P}=re(p&&w?w:null),[r,b]=u.useState({grossWeight:"0",tareWeight:"0",weighbridgeTicketNo:"",firstWeighmentTime:"",secondWeighmentTime:""}),_=u.useMemo(()=>{const t=parseFloat(r.grossWeight)||0,o=parseFloat(r.tareWeight)||0;return Math.max(0,t-o).toFixed(3)},[r.grossWeight,r.tareWeight]),[i,W]=u.useState({});se(i);const[E,$]=u.useState(!1),[N,q]=u.useState(!1),[O,U]=u.useState(!1),g=p&&!E;u.useEffect(()=>{if(g&&a){let t=a.first_weighment_time?a.first_weighment_time.slice(11,16):"",o=a.second_weighment_time?a.second_weighment_time.slice(11,16):"";if(!t&&!o&&a.remarks){const m=a.remarks.match(/First weighment:\s*([\d:]+)/i),h=a.remarks.match(/Second weighment:\s*([\d:]+)/i);m&&(t=m[1]),h&&(o=h[1])}b({grossWeight:a.gross_weight||"0",tareWeight:a.tare_weight||"0",weighbridgeTicketNo:a.weighbridge_slip_no||"",firstWeighmentTime:t,secondWeighmentTime:o})}},[g,a]);const y=(t,o)=>{g&&!N||(b(m=>({...m,[t]:o})),i[t]&&W(m=>{const h={...m};return delete h[t],h}))},G=()=>{$(!0),b({grossWeight:"0",tareWeight:"0",weighbridgeTicketNo:"",firstWeighmentTime:"",secondWeighmentTime:""}),W({})},H=()=>{s(p&&c?`/gate/raw-materials/edit/${c}/step4`:`/gate/raw-materials/new/step4?entryId=${c}`)},L=async()=>{if(!c){W({general:"Entry ID is missing. Please go back to step 1."});return}if(g&&!N){s(`/gate/raw-materials/edit/${c}/attachments`);return}W({});try{const t={gross_weight:parseFloat(r.grossWeight)||0,tare_weight:parseFloat(r.tareWeight)||0,weighbridge_slip_no:r.weighbridgeTicketNo||"",first_weighment_time:r.firstWeighmentTime?`${new Date().toISOString().slice(0,10)}T${r.firstWeighmentTime}:00`:void 0,second_weighment_time:r.secondWeighmentTime?`${new Date().toISOString().slice(0,10)}T${r.secondWeighmentTime}:00`:void 0};await l.mutateAsync(t),U(!0),s(p?`/gate/raw-materials/edit/${c}/attachments`:`/gate/raw-materials/new/attachments?entryId=${c}`)}catch(t){const o=t;if(o.errors){const m={};Object.entries(o.errors).forEach(([h,S])=>{Array.isArray(S)&&S.length>0&&(m[h]=S[0])}),W(m)}else W({general:o.message||"Failed to save weighment details"})}},j=ee(T),K=te(T),Q=g&&!F&&(!a||j),d=g&&!!a&&!E&&!N||j&&!E,R=g&&P?.status!==X.COMPLETED&&!!a,V=()=>{q(!0)};return p&&F?e.jsx(ge,{}):e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsx(de,{currentStep:A,error:K?ie():i.general||(T&&!j?D(T,"Failed to load weighment data"):null)}),Q&&!E&&e.jsx(oe,{message:j?D(T,"Weighment not found"):"No weighment data found for this entry.",onFillData:G}),e.jsx("div",{className:"space-y-6",children:e.jsxs(J,{children:[e.jsx(Y,{children:e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),"Weighment Details"]})}),e.jsx(z,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"grossWeight",children:"Gross Weight"}),e.jsx(x,{id:"grossWeight",type:"number",step:"0.001",min:"0",placeholder:"0",value:r.grossWeight,onChange:t=>y("grossWeight",t.target.value),disabled:d||l.isPending,className:v(i.grossWeight&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.grossWeight&&e.jsx("p",{className:"text-sm text-destructive",children:i.grossWeight})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"tareWeight",children:"Tare Weight"}),e.jsx(x,{id:"tareWeight",type:"number",step:"0.001",min:"0",placeholder:"0",value:r.tareWeight,onChange:t=>y("tareWeight",t.target.value),disabled:d||l.isPending,className:v(i.tareWeight&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.tareWeight&&e.jsx("p",{className:"text-sm text-destructive",children:i.tareWeight})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"netWeight",children:"Net Weight"}),e.jsx(x,{id:"netWeight",type:"text",placeholder:"Auto-calculated",value:_==="0.000"?"":_,readOnly:!0,disabled:!0,className:"bg-muted cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-calculated"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"weighbridgeTicketNo",children:"Weighbridge Ticket No."}),e.jsx(x,{id:"weighbridgeTicketNo",placeholder:"WB-2026-001",value:r.weighbridgeTicketNo,onChange:t=>y("weighbridgeTicketNo",t.target.value),disabled:d||l.isPending,className:v(i.weighbridgeTicketNo&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.weighbridgeTicketNo&&e.jsx("p",{className:"text-sm text-destructive",children:i.weighbridgeTicketNo})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"firstWeighmentTime",children:"First Weighment Time"}),e.jsx(x,{id:"firstWeighmentTime",type:"time",placeholder:"--:--",value:r.firstWeighmentTime,onChange:t=>y("firstWeighmentTime",t.target.value),disabled:d||l.isPending,className:v(i.firstWeighmentTime&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.firstWeighmentTime&&e.jsx("p",{className:"text-sm text-destructive",children:i.firstWeighmentTime})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"secondWeighmentTime",children:"Second Weighment Time"}),e.jsx(x,{id:"secondWeighmentTime",type:"time",placeholder:"--:--",value:r.secondWeighmentTime,onChange:t=>y("secondWeighmentTime",t.target.value),disabled:d||l.isPending,className:v(i.secondWeighmentTime&&"border-destructive",d&&"cursor-not-allowed opacity-50")}),i.secondWeighmentTime&&e.jsx("p",{className:"text-sm text-destructive",children:i.secondWeighmentTime})]})]})})]})}),e.jsx(ce,{onPrevious:H,onCancel:()=>{n.invalidateQueries({queryKey:["vehicleEntries"]}),s("/gate/raw-materials")},onNext:L,showUpdate:g&&R&&!N,onUpdate:V,isSaving:l.isPending||O,isEditMode:g,isUpdateMode:N})]})}export{Oe as default};
