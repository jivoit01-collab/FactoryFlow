import{r as _,j as e,D as V,m as F,n as O,o as q,p as M,L as b,I as y,M as w,q as R,B as C,a as G,E as H,C as k,b as L,c as E,e as I,U as z}from"./index-CNJik9Bh.js";import{b as A}from"./validation.constants-C18ePHzl.js";import{u as K}from"./useScrollToError-BmYURm0f.js";import{e as Y,f as $,g as J,h as Q,P as S,i as W}from"./personGateIn.queries-CU6JjoqY.js";import{I as X,a as T}from"./driver.schema-DZt_XaHY.js";import{G as Z}from"./GateSelect-BEqphXCe.js";import{S as U}from"./SearchableSelect-D-qlCXhi.js";import{C as ee}from"./ContractorSelect-_uJwSl2k.js";import{A as se}from"./arrow-left-DKuf5-od.js";import{C as re}from"./circle-alert-B-5U1cYA.js";import{U as ie}from"./users-Ba-HMNC7.js";import{C as te}from"./clock-CHlw3red.js";import"./useMutation-CvzAhSVt.js";import"./schemas-D8ebsZBL.js";import"./plus-BJzDLdE5.js";function ae({open:h,onOpenChange:v,onSuccess:j,defaultContractorId:n}){const[p,r]=_.useState({}),[o,d]=_.useState({name:"",contractor:n||0,mobile:"",id_proof_no:"",skill_type:"",permit_valid_till:""}),f=Y();_.useEffect(()=>{h&&(d({name:"",contractor:n||0,mobile:"",id_proof_no:"",skill_type:"",permit_valid_till:""}),r({}))},[h,n]);const t=async s=>{s.preventDefault();const i={};if(o.name.trim()||(i.name="Name is required"),o.contractor||(i.contractor="Contractor is required"),o.mobile?.trim()&&!A.phone.test(o.mobile.trim())&&(i.mobile="Please enter a valid 10-digit phone number"),Object.keys(i).length>0){r(i);return}r({});try{const c=await f.mutateAsync({name:o.name,contractor:o.contractor,mobile:o.mobile||void 0,id_proof_no:o.id_proof_no||void 0,skill_type:o.skill_type||void 0,permit_valid_till:o.permit_valid_till||void 0,is_active:!0});v(!1),j?.(c)}catch(c){const g=c;if(g.errors){const N={};Object.entries(g.errors).forEach(([u,m])=>{Array.isArray(m)&&m.length>0&&(N[u]=m[0])}),r(N)}else r({general:g.message||"Failed to create labour"})}};return e.jsx(V,{open:h,onOpenChange:v,children:e.jsxs(F,{className:"sm:max-w-[500px]",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Add New Labour"}),e.jsx(M,{children:"Fill in the details to register a new labour."})]}),e.jsxs("form",{onSubmit:t,className:"space-y-4",children:[p.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:p.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"name",children:["Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(y,{id:"name",placeholder:"Enter labour name",value:o.name,onChange:s=>d(i=>({...i,name:s.target.value})),disabled:f.isPending,className:p.name?"border-destructive":""}),p.name&&e.jsx("p",{className:"text-sm text-destructive",children:p.name})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(ee,{value:o.contractor?String(o.contractor):void 0,onChange:s=>{d(i=>({...i,contractor:s}))},disabled:f.isPending,label:"Contractor",required:!0,error:p.contractor})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"mobile",children:"Mobile"}),e.jsx(y,{id:"mobile",placeholder:"9876543210",value:o.mobile,onChange:s=>{const i=s.target.value.replace(/[^0-9]/g,"").slice(0,10);d(c=>({...c,mobile:i})),p.mobile&&r(c=>{const g={...c};return delete g.mobile,g})},maxLength:10,disabled:f.isPending,className:w(p.mobile&&"border-destructive")}),p.mobile&&e.jsx("p",{className:"text-sm text-destructive",children:p.mobile})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"skill_type",children:"Skill Type"}),e.jsx(y,{id:"skill_type",placeholder:"e.g., Electrician, Plumber",value:o.skill_type,onChange:s=>d(i=>({...i,skill_type:s.target.value})),disabled:f.isPending})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_no",children:"ID Proof Number"}),e.jsx(y,{id:"id_proof_no",placeholder:"ID number",value:o.id_proof_no,onChange:s=>d(i=>({...i,id_proof_no:s.target.value})),disabled:f.isPending})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"permit_valid_till",children:"Permit Valid Till"}),e.jsx(y,{id:"permit_valid_till",type:"date",value:o.permit_valid_till,onChange:s=>d(i=>({...i,permit_valid_till:s.target.value})),disabled:f.isPending})]})]}),e.jsxs(R,{children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:f.isPending,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:f.isPending,children:f.isPending?"Creating...":"Create Labour"})]})]})]})})}function oe({open:h,onOpenChange:v,onSuccess:j}){const[n,p]=_.useState({}),[r,o]=_.useState({name:"",mobile:"",company_name:"",id_proof_type:"",id_proof_no:""}),d=$();_.useEffect(()=>{h&&(o({name:"",mobile:"",company_name:"",id_proof_type:"",id_proof_no:""}),p({}))},[h]);const f=async t=>{t.preventDefault();const s={};if(r.name.trim()||(s.name="Name is required"),r.mobile?.trim()&&!A.phone.test(r.mobile.trim())&&(s.mobile="Please enter a valid 10-digit phone number"),r.id_proof_type&&r.id_proof_no?.trim()){const i=r.id_proof_type,c=T[i];c?.pattern&&!c.pattern.test(r.id_proof_no.trim().toUpperCase())&&(s.id_proof_no=c.message)}if(Object.keys(s).length>0){p(s);return}p({});try{const i=await d.mutateAsync({name:r.name,mobile:r.mobile||void 0,company_name:r.company_name||void 0,id_proof_type:r.id_proof_type||void 0,id_proof_no:r.id_proof_no||void 0});v(!1),j?.(i)}catch(i){const c=i;if(c.errors){const g={};Object.entries(c.errors).forEach(([N,u])=>{Array.isArray(u)&&u.length>0&&(g[N]=u[0])}),p(g)}else p({general:c.message||"Failed to create visitor"})}};return e.jsx(V,{open:h,onOpenChange:v,children:e.jsxs(F,{className:"sm:max-w-[500px]",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Add New Visitor"}),e.jsx(M,{children:"Fill in the details to register a new visitor."})]}),e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[n.general&&e.jsx("div",{className:"rounded-md bg-destructive/15 p-3 text-sm text-destructive",children:n.general}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"name",children:["Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(y,{id:"name",placeholder:"Enter visitor name",value:r.name,onChange:t=>o(s=>({...s,name:t.target.value})),disabled:d.isPending,className:n.name?"border-destructive":""}),n.name&&e.jsx("p",{className:"text-sm text-destructive",children:n.name})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"mobile",children:"Mobile"}),e.jsx(y,{id:"mobile",placeholder:"9876543210",value:r.mobile,onChange:t=>{const s=t.target.value.replace(/[^0-9]/g,"").slice(0,10);o(i=>({...i,mobile:s})),n.mobile&&p(i=>{const c={...i};return delete c.mobile,c})},maxLength:10,disabled:d.isPending,className:w(n.mobile&&"border-destructive")}),n.mobile&&e.jsx("p",{className:"text-sm text-destructive",children:n.mobile})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"company_name",children:"Company"}),e.jsx(y,{id:"company_name",placeholder:"Company name",value:r.company_name,onChange:t=>o(s=>({...s,company_name:t.target.value})),disabled:d.isPending})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_type",children:"ID Proof Type"}),e.jsxs("select",{id:"id_proof_type",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:r.id_proof_type,onChange:t=>{o(s=>({...s,id_proof_type:t.target.value,id_proof_no:""})),n.id_proof_no&&p(s=>{const i={...s};return delete i.id_proof_no,i})},disabled:d.isPending,children:[e.jsx("option",{value:"",children:"Select type"}),X.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"id_proof_no",children:"ID Proof Number"}),e.jsx(y,{id:"id_proof_no",placeholder:T[r.id_proof_type]?.placeholder||"ID number",value:r.id_proof_no,onChange:t=>{let s=t.target.value;r.id_proof_type==="Aadhar"?s=s.replace(/[^0-9]/g,"").slice(0,12):(r.id_proof_type==="PAN Card"||r.id_proof_type==="Voter ID")&&(s=s.toUpperCase()),o(i=>({...i,id_proof_no:s})),n.id_proof_no&&p(i=>{const c={...i};return delete c.id_proof_no,c})},maxLength:r.id_proof_type==="Aadhar"?12:r.id_proof_type==="PAN Card"||r.id_proof_type==="Voter ID"?10:50,disabled:d.isPending||!r.id_proof_type,className:w(n.id_proof_no&&"border-destructive")}),n.id_proof_no&&e.jsx("p",{className:"text-sm text-destructive",children:n.id_proof_no})]})]}),e.jsxs(R,{children:[e.jsx(C,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:d.isPending,children:"Cancel"}),e.jsx(C,{type:"submit",disabled:d.isPending,children:d.isPending?"Creating...":"Create Visitor"})]})]})]})})}function le({value:h,onChange:v,contractorId:j,placeholder:n="Select labour",disabled:p=!1,error:r,label:o,required:d=!1}){const[f,t]=_.useState(!1),[s,i]=_.useState(null),{data:c=[],isLoading:g,isError:N}=J(void 0,j,f&&!p),u=_.useMemo(()=>c.filter(m=>m.is_active),[c]);return e.jsx(U,{value:h?String(h):void 0,items:u,isLoading:g,isError:N,placeholder:n,disabled:p,error:r,label:o,required:d,inputId:"labour-select",getItemKey:m=>m.id,getItemLabel:m=>m.name,filterFn:(m,l)=>{const a=l.toLowerCase();return m.name.toLowerCase().includes(a)||(m.skill_type?.toLowerCase().includes(a)??!1)||(m.contractor_name?.toLowerCase().includes(a)??!1)},renderItem:m=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:m.name}),m.skill_type&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",m.skill_type,")"]})]}),renderPopoverContent:()=>s?e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.name})]}),s.contractor_name&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Contractor:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.contractor_name})]}),s.mobile&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.mobile})]}),s.skill_type&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Skill Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.skill_type})]}),s.id_proof_no&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.id_proof_no})]}),s.permit_valid_till&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Permit Valid Till:"})," ",e.jsx("span",{className:"text-muted-foreground",children:s.permit_valid_till})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a labour to view details."}),loadingText:"Loading labours...",emptyText:"No labours available",notFoundText:"No labours found",addNewLabel:"Add New Labour",onOpenChange:t,onItemSelect:m=>{i(m),v(m)},onClear:()=>{i(null),v(null)},renderCreateDialog:(m,l,a)=>e.jsx(ae,{open:m,onOpenChange:l,onSuccess:x=>{a(x.id,x.name),i(x),v(x)},defaultContractorId:j})})}function ne({value:h,onChange:v,placeholder:j="Select visitor",disabled:n=!1,error:p,label:r,required:o=!1}){const[d,f]=_.useState(!1),[t,s]=_.useState(null),{data:i=[],isLoading:c,isError:g}=Q(void 0,d&&!n),N=_.useMemo(()=>i.filter(u=>!u.blacklisted),[i]);return e.jsx(U,{value:h?String(h):void 0,items:N,isLoading:c,isError:g,placeholder:j,disabled:n,error:p,label:r,required:o,inputId:"visitor-select",getItemKey:u=>u.id,getItemLabel:u=>u.name,filterFn:(u,m)=>{const l=m.toLowerCase();return u.name.toLowerCase().includes(l)||(u.company_name?.toLowerCase().includes(l)??!1)},renderItem:u=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:u.name}),u.company_name&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",u.company_name,")"]})]}),renderPopoverContent:()=>t?e.jsxs("div",{className:"space-y-1.5 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",e.jsx("span",{className:"text-muted-foreground",children:t.name})]}),t.mobile&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Mobile:"})," ",e.jsx("span",{className:"text-muted-foreground",children:t.mobile})]}),t.company_name&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Company:"})," ",e.jsx("span",{className:"text-muted-foreground",children:t.company_name})]}),t.id_proof_type&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Type:"})," ",e.jsx("span",{className:"text-muted-foreground",children:t.id_proof_type})]}),t.id_proof_no&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"ID Proof Number:"})," ",e.jsx("span",{className:"text-muted-foreground",children:t.id_proof_no})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Please select a visitor to view details."}),loadingText:"Loading visitors...",emptyText:"No visitors available",notFoundText:"No visitors found",addNewLabel:"Add New Visitor",onOpenChange:f,onItemSelect:u=>{s(u),v(u)},onClear:()=>{s(null),v(null)},renderCreateDialog:(u,m,l)=>e.jsx(oe,{open:u,onOpenChange:m,onSuccess:a=>{l(a.id,a.name),s(a),v(a)}})})}function de(){const h=new Date,v=h.getTimezoneOffset();return new Date(h.getTime()-v*6e4).toISOString().slice(0,16)}function Pe(){const h=G(),[v]=H(),j=v.get("type"),[n,p]=_.useState(j||"visitor"),[r,o]=_.useState({person_type:j==="labour"?S.LABOUR:S.VISITOR,visitor:null,labour:null,gate_in:null,purpose:"",vehicle_no:"",remarks:"",actual_entry_time:de()}),[d,f]=_.useState(null),[t,s]=_.useState({});K(t);const i=W(),c=l=>{p(l),f(null),o(a=>({...a,person_type:l==="labour"?S.LABOUR:S.VISITOR,visitor:null,labour:null})),s({})},g=l=>{f(l),o(a=>({...a,visitor:l?.id||null,labour:null})),t.visitor&&s(a=>{const x={...a};return delete x.visitor,x})},N=l=>{f(l),o(a=>({...a,labour:l?.id||null,visitor:null})),t.labour&&s(a=>{const x={...a};return delete x.labour,x})},u=l=>{o(a=>({...a,gate_in:l?.id||null})),t.gate_in&&s(a=>{const x={...a};return delete x.gate_in,x})},m=async()=>{const l={};if(r.person_type||(l.person_type="Person type is required"),r.gate_in||(l.gate_in="Gate is required"),n==="visitor"&&!r.visitor&&(l.visitor="Please select a visitor"),n==="labour"&&!r.labour&&(l.labour="Please select a labour"),r.vehicle_no.trim()&&!A.vehicleNumber.test(r.vehicle_no.trim().toUpperCase())&&(l.vehicle_no="Please enter a valid vehicle number (e.g., MH12AB1234, DL1LAB1234)"),Object.keys(l).length>0){s(l);return}try{const a={person_type:r.person_type,gate_in:r.gate_in,purpose:r.purpose||void 0,vehicle_no:r.vehicle_no||void 0,remarks:r.remarks||void 0,actual_entry_time:r.actual_entry_time?new Date(r.actual_entry_time).toISOString():void 0};n==="visitor"?a.visitor=r.visitor:a.labour=r.labour;const x=await i.mutateAsync(a);h(`/gate/visitor-labour/entry/${x.id}`)}catch(a){const x=a,P={};x.errors&&Object.entries(x.errors).forEach(([B,D])=>{Array.isArray(D)&&D.length>0&&(P[B]=D[0])}),x.message&&(P.general=x.message),s(P)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>h("/gate/visitor-labour"),children:e.jsx(se,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"New Entry"}),e.jsx("p",{className:"text-muted-foreground",children:"Create a new gate entry for visitor or labour"})]})]}),t.general&&e.jsx("div",{className:"rounded-lg border border-destructive/50 bg-destructive/10 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(re,{className:"h-5 w-5 text-destructive flex-shrink-0"}),e.jsx("p",{className:"text-sm font-medium text-destructive",children:t.general})]})}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsx(E,{className:"text-base",children:"Person Type"})}),e.jsx(I,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(C,{variant:n==="visitor"?"default":"outline",onClick:()=>c("visitor"),className:"flex-1",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Visitor"]}),e.jsxs(C,{variant:n==="labour"?"default":"outline",onClick:()=>c("labour"),className:"flex-1",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Labour"]})]})})]}),e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsxs(E,{className:"text-base",children:["Select ",n==="visitor"?"Visitor":"Labour"]})}),e.jsxs(I,{className:"space-y-3",children:[n==="visitor"?e.jsx(ne,{value:r.visitor,onChange:g,label:"Visitor",placeholder:"Search and select visitor...",error:t.visitor,required:!0}):e.jsx(le,{value:r.labour,onChange:N,label:"Labour",placeholder:"Search and select labour...",error:t.labour,required:!0}),d&&e.jsx("div",{className:"p-3 rounded-lg border-2 border-primary bg-primary/5",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:d.name}),"company_name"in d&&d.company_name&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.company_name}),"skill_type"in d&&d.skill_type&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d.skill_type})]})})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(L,{className:"pb-3",children:e.jsx(E,{className:"text-base",children:"Entry Details"})}),e.jsxs(I,{className:"space-y-4",children:[e.jsx(Z,{value:r.gate_in,onChange:u,label:"Entry Gate",placeholder:"Select gate...",error:t.gate_in,required:!0}),e.jsxs("div",{children:[e.jsxs(b,{children:[e.jsx(te,{className:"h-3.5 w-3.5 inline mr-1"}),"Entry Time"]}),e.jsx(y,{type:"datetime-local",value:r.actual_entry_time,onChange:l=>o(a=>({...a,actual_entry_time:l.target.value})),className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Purpose of Visit"}),e.jsx(y,{value:r.purpose,onChange:l=>o(a=>({...a,purpose:l.target.value})),placeholder:"e.g., Meeting with HR, Daily work",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Vehicle Number"}),e.jsx(y,{value:r.vehicle_no,onChange:l=>{const a=l.target.value.toUpperCase().replace(/\s/g,"");o(x=>({...x,vehicle_no:a})),t.vehicle_no&&s(x=>{const P={...x};return delete P.vehicle_no,P})},placeholder:"MH12AB1234",className:w("mt-1",t.vehicle_no&&"border-destructive")}),t.vehicle_no&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:t.vehicle_no})]}),e.jsxs("div",{children:[e.jsx(b,{children:"Remarks"}),e.jsx("textarea",{value:r.remarks,onChange:l=>o(a=>({...a,remarks:l.target.value})),placeholder:"Any additional notes...",className:"mt-1 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",rows:3})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{variant:"outline",onClick:()=>h("/gate/visitor-labour"),className:"flex-1",children:"Cancel"}),e.jsx(C,{onClick:m,disabled:i.isPending,className:"flex-1",children:i.isPending?"Creating...":"Create Entry"})]})]})]})]})}export{Pe as default};
