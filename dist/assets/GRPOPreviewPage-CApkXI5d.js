import{r as p,j as e,a as J,Q as M,B as l,C as X,e as Y,L as k,I as O,D as R,m as D,n as A,o as E,p as L,q as I}from"./index-Dm3Xfjnt.js";import{G as Z,F}from"./status.constants-7P9dQP1S.js";import{b as ee,c as se,d as te}from"./grpo.queries-D2KwP9mG.js";import{S as re}from"./SearchableSelect-kktrv1CU.js";import{A as ae}from"./arrow-left-RhgS-m-T.js";import{R as T,S as ne}from"./shield-x-DW_E62g4.js";import{C as G}from"./circle-alert-CkjslOaL.js";import{P as ie}from"./package-D3LQ7hzY.js";import{C as Q}from"./circle-check-4K5RQOA0.js";import"./triangle-alert-C6MTrmF-.js";import"./circle-x-gTIzRI_j.js";import"./clock-xVG4dxTu.js";import"./useMutation-C59p_qU8.js";import"./plus-dJ8NaNTB.js";const ce=parseInt("2",10);function oe({value:g,onChange:j,placeholder:f="Select warehouse",disabled:u=!1,error:_,label:h,required:N=!1}){const[m,v]=p.useState(!1),{data:y=[],isLoading:x}=ee(m);return e.jsx(re,{value:g,items:y,isLoading:x,placeholder:f,disabled:u,error:_,label:h,required:N,inputId:"warehouse-select",inputClassName:"h-8 text-sm",getItemKey:n=>n.warehouse_code,getItemLabel:n=>`${n.warehouse_name} (${n.warehouse_code})`,filterFn:(n,c)=>n.warehouse_name.toLowerCase().includes(c.toLowerCase())||n.warehouse_code.toLowerCase().includes(c.toLowerCase()),renderItem:n=>e.jsxs("div",{children:[e.jsx("span",{className:"text-sm",children:n.warehouse_name}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",n.warehouse_code,")"]})]}),loadingText:"Loading warehouses...",emptyText:"No warehouses available",notFoundText:"No warehouses found",onOpenChange:v,onItemSelect:n=>{j(n.warehouse_code)},onClear:()=>{j("")}})}function we(){const g=J(),{vehicleEntryId:j}=M(),f=j?parseInt(j,10):null,{data:u=[],isLoading:_,error:h,refetch:N}=se(f),m=te(),[v,y]=p.useState({}),[x,n]=p.useState({}),[c,w]=p.useState(null),[b,C]=p.useState(null),S=h,q=S?.status===403,P=p.useCallback(s=>{if(v[s.po_receipt_id])return v[s.po_receipt_id];const a={};return s.items.forEach(t=>{a[t.po_item_receipt_id]=t.received_qty}),{items:a,warehouseCode:"",comments:""}},[v]),$=(s,a,t)=>{const r=t===""?0:parseFloat(t);y(o=>{const d=o[s]||{items:{},warehouseCode:"",comments:""};return{...o,[s]:{...d,items:{...d.items,[a]:isNaN(r)?0:r}}}});const i=`item_${a}`;x[i]&&n(o=>{const d={...o};return delete d[i],d})},z=(s,a)=>{y(t=>{const r=t[s]||{items:{},warehouseCode:"",comments:""};return{...t,[s]:{...r,warehouseCode:a}}})},V=(s,a)=>{y(t=>{const r=t[s]||{items:{},warehouseCode:"",comments:""};return{...t,[s]:{...r,comments:a}}})},W=s=>{const a=P(s),t={};return s.items.forEach(i=>{const o=a.items[i.po_item_receipt_id]??i.received_qty;o<0&&(t[`item_${i.po_item_receipt_id}`]="Cannot be negative"),o>i.received_qty&&(t[`item_${i.po_item_receipt_id}`]=`Cannot exceed received qty (${i.received_qty})`)}),s.items.some(i=>(a.items[i.po_item_receipt_id]??i.received_qty)>0)||(t.general="At least one item must have accepted quantity greater than 0"),n(t),Object.keys(t).length===0},B=s=>{W(s)&&w(s)},H=async()=>{if(!c||!f)return;const s=P(c),a=c.items.map(t=>({po_item_receipt_id:t.po_item_receipt_id,accepted_qty:s.items[t.po_item_receipt_id]??t.received_qty}));try{n({});const t=await m.mutateAsync({vehicle_entry_id:f,po_receipt_id:c.po_receipt_id,items:a,branch_id:ce,warehouse_code:s.warehouseCode||void 0,comments:s.comments||void 0});w(null),C(t)}catch(t){w(null),n({general:t.message||"Failed to post GRPO"})}},K=u.length>0?u[0].entry_no:"";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(l,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>g("/grpo/pending"),children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:K||"GRPO Preview"})]}),e.jsx("p",{className:"text-muted-foreground",children:"Review and post goods receipt for each purchase order"})]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>N(),className:"w-full sm:w-auto",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),q&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-destructive/50 bg-destructive/5",children:[e.jsx(ne,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-destructive",children:"Permission Denied"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:S?.message||"You do not have permission to preview GRPO data."})]})]}),h&&!q&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-yellow-500/50 bg-yellow-50 dark:bg-yellow-900/10",children:[e.jsx(G,{className:"h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-yellow-800 dark:text-yellow-400",children:"Failed to Load"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:S?.message||"An error occurred while loading preview data."})]}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>N(),children:e.jsx(T,{className:"h-4 w-4"})})]}),x.general&&e.jsxs("div",{className:"flex items-start gap-3 p-4 rounded-lg border border-destructive/50 bg-destructive/5",children:[e.jsx(G,{className:"h-5 w-5 text-destructive flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-destructive",children:x.general})]}),_&&e.jsx("div",{className:"flex items-center justify-center h-48",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}),!_&&!h&&u.length===0&&e.jsx("div",{className:"flex items-center justify-center h-24 text-sm text-muted-foreground border rounded-lg",children:"No purchase orders found for this entry."}),!_&&!h&&u.map(s=>{const a=s.grpo_status===Z.POSTED,t=P(s);return e.jsx(X,{className:a?"opacity-60":"",children:e.jsxs(Y,{className:"p-4 space-y-4",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-semibold",children:s.po_number}),a&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",children:[e.jsx(Q,{className:"h-3 w-3"}),"Posted (SAP #",s.sap_doc_num,")"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.supplier_name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Invoice: ",s.invoice_no," | Challan: ",s.challan_no]})]})}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Items"}),s.items.map(r=>{const i=t.items[r.po_item_receipt_id]??r.received_qty,o=Math.max(0,r.received_qty-i),d=`item_${r.po_item_receipt_id}`;return e.jsxs("div",{className:"p-3 rounded-md border bg-muted/30 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium",children:[r.item_code," - ",r.item_name]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Received: ",r.received_qty," ",r.uom]})]}),e.jsx("span",{className:`text-[10px] rounded-full px-1.5 py-0.5 font-medium ${r.qc_status===F.ACCEPTED?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":r.qc_status===F.REJECTED?"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400":"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300"}`,children:r.qc_status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(k,{className:"text-xs",children:"Accepted Qty"}),e.jsx(O,{type:"number",min:0,max:r.received_qty,step:"any",value:i,onChange:U=>$(s.po_receipt_id,r.po_item_receipt_id,U.target.value),className:"h-8 text-sm"}),x[d]&&e.jsx("p",{className:"text-xs text-destructive",children:x[d]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(k,{className:"text-xs",children:"Rejected Qty"}),e.jsx(O,{type:"number",value:o.toFixed(3),readOnly:!0,disabled:!0,className:"h-8 text-sm bg-muted"})]})]})]},r.po_item_receipt_id)})]}),e.jsxs("div",{className:"border-t pt-4 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsx(oe,{label:"Warehouse Code",value:t.warehouseCode,onChange:r=>z(s.po_receipt_id,r),placeholder:"Select warehouse"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(k,{className:"text-xs",children:"Comments"}),e.jsx(O,{value:t.comments,onChange:r=>V(s.po_receipt_id,r.target.value),placeholder:"Optional remarks",className:"h-8 text-sm"})]})]}),e.jsxs("div",{className:"border-t pt-4 flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",size:"sm",onClick:()=>g("/grpo/pending"),children:"Cancel"}),e.jsx(l,{size:"sm",onClick:()=>B(s),disabled:m.isPending,children:m.isPending?"Posting...":"Post GRPO"})]})]})]})},s.po_receipt_id)}),e.jsx(R,{open:!!c,onOpenChange:()=>w(null),children:e.jsxs(D,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(E,{children:"Confirm GRPO Posting"}),e.jsx(L,{children:"Review the quantities below before posting to SAP."})]}),c&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"PO:"})," ",e.jsx("span",{className:"font-medium",children:c.po_number})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Supplier:"})," ",e.jsx("span",{className:"font-medium",children:c.supplier_name})]}),e.jsx("div",{className:"border-t pt-3 space-y-2",children:c.items.map(s=>{const t=P(c).items[s.po_item_receipt_id]??s.received_qty;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:s.item_name}),e.jsxs("span",{className:"font-medium",children:[t," ",s.uom]})]},s.po_item_receipt_id)})})]}),e.jsxs(I,{children:[e.jsx(l,{variant:"outline",onClick:()=>w(null),children:"Cancel"}),e.jsx(l,{onClick:H,disabled:m.isPending,children:m.isPending?"Posting...":"Confirm Post"})]})]})}),e.jsx(R,{open:!!b,onOpenChange:()=>C(null),children:e.jsxs(D,{className:"max-w-sm",children:[e.jsxs(A,{children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5 text-green-600"}),"Success"]}),e.jsx(L,{children:"GRPO posted successfully to SAP."})]}),b&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"SAP Document Number"}),e.jsx("span",{className:"font-semibold",children:b.sap_doc_num})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Value"}),e.jsx("span",{className:"font-semibold",children:b.sap_doc_total?.toLocaleString("en-IN",{style:"currency",currency:"INR"})})]})]}),e.jsxs(I,{className:"flex-col gap-2 sm:flex-col",children:[e.jsx(l,{variant:"outline",className:"w-full",onClick:()=>{C(null),g("/grpo/history")},children:"View History"}),e.jsx(l,{className:"w-full",onClick:()=>{C(null),N()},children:"Done"})]})]})})]})}export{we as default};
