import{y as F,a as q,W as V,r as c,j as e,B as m,C as N,e as y,al as b,L as w,I as E,M as W,am as a}from"./index-DcDZk0Ze.js";import{B as A}from"./badge-Ce0H-TIr.js";import{w as Y,x as H,y as J,P as I}from"./personGateIn.queries-6WOKRFQk.js";import{G as K}from"./GateSelect-BaI-3TAW.js";import{A as Q}from"./arrow-left-Do7ni92_.js";import{U as X}from"./users-B_Cs0K3w.js";import{L as _}from"./log-in-BnSks5pE.js";import{C as Z}from"./clock-BJCtD_-t.js";import{S as ee}from"./search-BuDSPJxu.js";import{C as te}from"./circle-check-D4IQpWN7.js";import"./useMutation-BN6FooZ9.js";import"./SearchableSelect-8Ls5hP1n.js";import"./plus-CZjyi12_.js";const se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}]],re=F("circle-minus",se);function ae(){const x=new Date,h=x.getTimezoneOffset();return new Date(x.getTime()-h*6e4).toISOString().slice(0,16)}function ge(){const x=q(),{contractorId:h}=V(),n=h?Number(h):null,[u,P]=c.useState(""),[r,$]=c.useState(null),[v,B]=c.useState(ae()),[D,f]=c.useState(new Set),[d,p]=c.useState(null),{data:i,isLoading:T,isError:M}=Y(n),k=H(),S=J(),o=c.useMemo(()=>{if(!i?.labours)return[];if(!u.trim())return i.labours;const t=u.toLowerCase();return i.labours.filter(s=>s.name.toLowerCase().includes(t)||s.mobile?.toLowerCase().includes(t)||s.skill_type?.toLowerCase().includes(t))},[i?.labours,u]),j=c.useMemo(()=>o.filter(t=>t.is_inside),[o]),g=c.useMemo(()=>o.filter(t=>!t.is_inside),[o]),C=()=>{if(v)return new Date(v).toISOString()},O=async t=>{if(!r){a.error("Please select a gate first");return}if(n){f(s=>new Set(s).add(t.id));try{const l=(await k.mutateAsync({contractor_id:n,gate_in:r.id,person_type:I.LABOUR,actual_entry_time:C(),labours:[{labour_id:t.id}]})).results[0];l?.status==="created"?a.success(`${t.name} entered`):a.warning(`${t.name}: ${l?.reason||"Skipped"}`)}catch{a.error(`Failed to create entry for ${t.name}`)}finally{f(s=>{const l=new Set(s);return l.delete(t.id),l})}}},z=async t=>{if(!r){a.error("Please select a gate first");return}if(n){f(s=>new Set(s).add(t.id));try{const l=(await S.mutateAsync({contractor_id:n,gate_out:r.id,labours:[{labour_id:t.id}]})).results[0];l?.status==="exited"?a.success(`${t.name} exited`):a.warning(`${t.name}: ${l?.reason||"Skipped"}`)}catch{a.error(`Failed to mark exit for ${t.name}`)}finally{f(s=>{const l=new Set(s);return l.delete(t.id),l})}}},G=async()=>{if(!r){a.error("Please select a gate first");return}if(!(!n||g.length===0)){p("entry");try{const t=await k.mutateAsync({contractor_id:n,gate_in:r.id,person_type:I.LABOUR,actual_entry_time:C(),labours:g.map(s=>({labour_id:s.id}))});a.success(`${t.total_created} entered${t.total_skipped>0?`, ${t.total_skipped} skipped`:""}`)}catch{a.error("Bulk entry failed")}finally{p(null)}}},U=async()=>{if(!r){a.error("Please select a gate first");return}if(!(!n||j.length===0)){p("exit");try{const t=await S.mutateAsync({contractor_id:n,gate_out:r.id,labours:j.map(s=>({labour_id:s.id}))});a.success(`${t.total_exited} exited${t.total_skipped>0?`, ${t.total_skipped} skipped`:""}`)}catch{a.error("Bulk exit failed")}finally{p(null)}}},R=t=>{if(!t)return"-";try{return new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return t}},L=t=>{if(!t)return!1;try{return new Date(t)<new Date}catch{return!1}};return n?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>x("/gate/visitor-labour/contractors"),children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:i?.contractor_name||"Contractor Labours"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage labour entry and exit for this contractor"})]})]})}),i&&e.jsxs("div",{className:"grid gap-4 grid-cols-2 sm:grid-cols-3",children:[e.jsx(N,{children:e.jsx(y,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:i.total_active_labours}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Active"})]})]})})}),e.jsx(N,{children:e.jsx(y,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:i.total_currently_inside}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Currently Inside"})]})]})})}),e.jsx(N,{children:e.jsx(y,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{className:"h-5 w-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-gray-500",children:i.total_active_labours-i.total_currently_inside}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Outside"})]})]})})})]}),e.jsx(N,{children:e.jsxs(y,{className:"pt-6",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-end",children:[e.jsxs("div",{className:"w-full sm:w-64",children:[e.jsx(w,{className:"mb-1.5 block",children:"Gate *"}),e.jsx(K,{value:r?.id,onChange:$,placeholder:"Select gate for entry/exit",required:!0})]}),e.jsxs("div",{className:"w-full sm:w-56",children:[e.jsxs(w,{className:"mb-1.5 block",children:[e.jsx(Z,{className:"h-3.5 w-3.5 inline mr-1"}),"Entry Time"]}),e.jsx(E,{type:"datetime-local",value:v,onChange:t=>B(t.target.value)})]}),e.jsxs("div",{className:"relative w-full sm:w-64",children:[e.jsx(w,{className:"mb-1.5 block",children:"Search"}),e.jsx(ee,{className:"absolute left-3 bottom-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(E,{placeholder:"Search by name, mobile, skill...",value:u,onChange:t=>P(t.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2 sm:ml-auto",children:[e.jsxs(m,{variant:"default",size:"sm",onClick:G,disabled:!r||g.length===0||d!==null,children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),d==="entry"?"Processing...":`Entry All (${g.length})`]}),e.jsxs(m,{variant:"destructive",size:"sm",onClick:U,disabled:!r||j.length===0||d!==null,children:[e.jsx(b,{className:"h-4 w-4 mr-1"}),d==="exit"?"Processing...":`Exit All (${j.length})`]})]})]}),!r&&e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:"Select a gate to enable entry/exit actions"})]})}),T?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"})}):M?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-muted-foreground rounded-md border",children:[e.jsx("p",{className:"text-lg",children:"Failed to load labours"}),e.jsx("p",{className:"text-sm",children:"Please try again later"})]}):o.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-muted-foreground rounded-md border",children:[e.jsx("p",{className:"text-lg",children:"No labours found"}),u&&e.jsx("p",{className:"text-sm",children:"Try a different search term"})]}):e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-[700px]",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Name"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Mobile"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Skill"}),e.jsx("th",{className:"p-3 text-left text-sm font-medium",children:"Permit Valid Till"}),e.jsx("th",{className:"p-3 text-center text-sm font-medium",children:"Status"}),e.jsx("th",{className:"p-3 text-right text-sm font-medium",children:"Action"})]})}),e.jsx("tbody",{children:o.map(t=>{const s=D.has(t.id);return e.jsxs("tr",{className:"border-t hover:bg-muted/50",children:[e.jsx("td",{className:"p-3 text-sm font-medium",children:t.name}),e.jsx("td",{className:"p-3 text-sm",children:t.mobile||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.skill_type||"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsxs("span",{className:W(L(t.permit_valid_till)&&"text-red-600 dark:text-red-400"),children:[R(t.permit_valid_till),L(t.permit_valid_till)&&" (Expired)"]})}),e.jsx("td",{className:"p-3 text-center",children:t.is_inside?e.jsxs(A,{variant:"default",className:"bg-green-100 text-green-800 hover:bg-green-100 dark:bg-green-900 dark:text-green-200",children:[e.jsx(te,{className:"h-3 w-3 mr-1"}),"Inside"]}):e.jsxs(A,{variant:"secondary",children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),"Outside"]})}),e.jsx("td",{className:"p-3 text-right",children:t.is_inside?e.jsxs(m,{variant:"destructive",size:"sm",onClick:()=>z(t),disabled:!r||s||d!==null,children:[s?e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-white border-t-transparent mr-1"}):e.jsx(b,{className:"h-3 w-3 mr-1"}),"Exit"]}):e.jsxs(m,{variant:"default",size:"sm",className:"bg-green-600 hover:bg-green-700",onClick:()=>O(t),disabled:!r||s||d!==null,children:[s?e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-white border-t-transparent mr-1"}):e.jsx(_,{className:"h-3 w-3 mr-1"}),"Entry"]})})]},t.id)})})]})})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-muted-foreground",children:[e.jsx("p",{children:"Invalid contractor ID"}),e.jsx(m,{variant:"link",onClick:()=>x("/gate/visitor-labour/contractors"),children:"Back to contractors"})]})}export{ge as default};
